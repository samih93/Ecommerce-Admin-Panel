!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(require("@firebase/app-compat"),require("@firebase/app")):"function"==typeof define&&define.amd?define(["@firebase/app-compat","@firebase/app"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).firebase,e.firebase.INTERNAL.modularAPIs)}(this,function(Jf,Zf){"use strict";try{!(function(){function e(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var l,t=e(Jf);function n(t){const n=[];let r=0;for(let s=0;s<t.length;s++){let e=t.charCodeAt(s);e<128?n[r++]=e:(e<2048?n[r++]=e>>6|192:(55296==(64512&e)&&s+1<t.length&&56320==(64512&t.charCodeAt(s+1))?(e=65536+((1023&e)<<10)+(1023&t.charCodeAt(++s)),n[r++]=e>>18|240,n[r++]=e>>12&63|128):n[r++]=e>>12|224,n[r++]=e>>6&63|128),n[r++]=63&e|128)}return n}const r={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:"function"==typeof atob,encodeByteArray(n,e){if(!Array.isArray(n))throw Error("encodeByteArray takes an array as a parameter");this.init_();var r=e?this.byteToCharMapWebSafe_:this.byteToCharMap_;const s=[];for(let h=0;h<n.length;h+=3){var i=n[h],a=h+1<n.length,o=a?n[h+1]:0,u=h+2<n.length,c=u?n[h+2]:0;let e=(15&o)<<2|c>>6,t=63&c;u||(t=64,a||(e=64)),s.push(r[i>>2],r[(3&i)<<4|o>>4],r[e],r[t])}return s.join("")},encodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?btoa(e):this.encodeByteArray(n(e),t)},decodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?atob(e):function(e){const t=[];let n=0,r=0;for(;n<e.length;){var s,i,a=e[n++];a<128?t[r++]=String.fromCharCode(a):191<a&&a<224?(s=e[n++],t[r++]=String.fromCharCode((31&a)<<6|63&s)):239<a&&a<365?(i=((7&a)<<18|(63&e[n++])<<12|(63&e[n++])<<6|63&e[n++])-65536,t[r++]=String.fromCharCode(55296+(i>>10)),t[r++]=String.fromCharCode(56320+(1023&i))):(s=e[n++],i=e[n++],t[r++]=String.fromCharCode((15&a)<<12|(63&s)<<6|63&i))}return t.join("")}(this.decodeStringToByteArray(e,t))},decodeStringToByteArray(e,t){this.init_();var n=t?this.charToByteMapWebSafe_:this.charToByteMap_;const r=[];for(let u=0;u<e.length;){var s=n[e.charAt(u++)],i=u<e.length?n[e.charAt(u)]:0;++u;var a=u<e.length?n[e.charAt(u)]:64;++u;var o=u<e.length?n[e.charAt(u)]:64;if(++u,null==s||null==i||null==a||null==o)throw Error();r.push(s<<2|i>>4),64!==a&&(r.push(i<<4&240|a>>2),64!==o&&r.push(a<<6&192|o))}return r},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let e=0;e<this.ENCODED_VALS.length;e++)this.byteToCharMap_[e]=this.ENCODED_VALS.charAt(e),this.charToByteMap_[this.byteToCharMap_[e]]=e,this.byteToCharMapWebSafe_[e]=this.ENCODED_VALS_WEBSAFE.charAt(e),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[e]]=e,e>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(e)]=e,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(e)]=e)}}},a=function(e){return e=e,t=n(e),r.encodeByteArray(t,!0).replace(/\./g,"");var t};function f(){return"undefined"!=typeof navigator&&"string"==typeof navigator.userAgent?navigator.userAgent:""}function s(){return!function(){try{return"[object process]"===Object.prototype.toString.call(global.process)}catch(e){return}}()&&navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome")}class o extends Error{constructor(e,t,n){super(t),this.code=e,this.customData=n,this.name="FirebaseError",Object.setPrototypeOf(this,o.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,i.prototype.create)}}class i{constructor(e,t,n){this.service=e,this.serviceName=t,this.errors=n}create(e,...t){var r,n=t[0]||{},s=`${this.service}/${e}`,i=this.errors[e],i=i?(r=n,i.replace(u,(e,t)=>{var n=r[t];return null!=n?String(n):`<${t}?>`})):"Error",i=`${this.serviceName}: ${i} (${s}).`;return new o(s,i,n)}}const u=/\{\$([^}]+)}/g;function m(e){return e&&e._delegate?e._delegate:e}class c{constructor(e,t,n){this.name=e,this.instanceFactory=t,this.type=n,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(e){return this.instantiationMode=e,this}setMultipleInstances(e){return this.multipleInstances=e,this}setServiceProps(e){return this.serviceProps=e,this}setInstanceCreatedCallback(e){return this.onInstanceCreated=e,this}}(td=l=l||{})[td.DEBUG=0]="DEBUG",td[td.VERBOSE=1]="VERBOSE",td[td.INFO=2]="INFO",td[td.WARN=3]="WARN",td[td.ERROR=4]="ERROR",td[td.SILENT=5]="SILENT";const h={debug:l.DEBUG,verbose:l.VERBOSE,info:l.INFO,warn:l.WARN,error:l.ERROR,silent:l.SILENT},d=l.INFO,g={[l.DEBUG]:"log",[l.VERBOSE]:"log",[l.INFO]:"info",[l.WARN]:"warn",[l.ERROR]:"error"},p=(e,t,...n)=>{if(!(t<e.logLevel)){var r=(new Date).toISOString(),s=g[t];if(!s)throw new Error(`Attempted to log a message with an invalid logType (value: ${t})`);console[s](`[${r}]  ${e.name}:`,...n)}};var y,v="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},w={},b=v||self;function I(){}function E(e){var t=typeof e;return"array"==(t="object"!=t?t:e?Array.isArray(e)?"array":t:"null")||"object"==t&&"number"==typeof e.length}function T(e){var t=typeof e;return"object"==t&&null!=e||"function"==t}var S="closure_uid_"+(1e9*Math.random()>>>0),_=0;function x(e,t,n){return e.call.apply(e.bind,arguments)}function D(t,n,e){if(!t)throw Error();if(2<arguments.length){var r=Array.prototype.slice.call(arguments,2);return function(){var e=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(e,r),t.apply(n,e)}}return function(){return t.apply(n,arguments)}}function A(e,t,n){return(A=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?x:D).apply(null,arguments)}function C(t){var n=Array.prototype.slice.call(arguments,1);return function(){var e=n.slice();return e.push.apply(e,arguments),t.apply(this,e)}}function N(e,i){function t(){}t.prototype=i.prototype,e.Z=i.prototype,e.prototype=new t,(e.prototype.constructor=e).Vb=function(e,t,n){for(var r=Array(arguments.length-2),s=2;s<arguments.length;s++)r[s-2]=arguments[s];return i.prototype[t].apply(e,r)}}function k(){this.s=this.s,this.o=this.o}var R={};k.prototype.s=!1,k.prototype.na=function(){var e,t;!this.s&&(this.s=!0,this.M(),0)&&(t=this,e=Object.prototype.hasOwnProperty.call(t,S)&&t[S]||(t[S]=++_),delete R[e])},k.prototype.M=function(){if(this.o)for(;this.o.length;)this.o.shift()()};const M=Array.prototype.indexOf?function(e,t){return Array.prototype.indexOf.call(e,t,void 0)}:function(e,t){if("string"==typeof e)return"string"!=typeof t||1!=t.length?-1:e.indexOf(t,0);for(let n=0;n<e.length;n++)if(n in e&&e[n]===t)return n;return-1},L=Array.prototype.forEach?function(e,t,n){Array.prototype.forEach.call(e,t,n)}:function(e,t,n){var r=e.length,s="string"==typeof e?e.split(""):e;for(let i=0;i<r;i++)i in s&&t.call(n,s[i],i,e)};function O(){return Array.prototype.concat.apply([],arguments)}function V(t){var n=t.length;if(0<n){const r=Array(n);for(let e=0;e<n;e++)r[e]=t[e];return r}return[]}function F(e){return/^[\s\xa0]*$/.test(e)}var P,B=String.prototype.trim?function(e){return e.trim()}:function(e){return/^[\s\xa0]*([\s\S]*?)[\s\xa0]*$/.exec(e)[1]};function U(e,t){return-1!=e.indexOf(t)}function q(e,t){return e<t?-1:t<e?1:0}e:{var j=b.navigator;if(j){j=j.userAgent;if(j){P=j;break e}}P=""}function K(e,t,n){for(const r in e)t.call(n,e[r],r,e)}function G(e){const t={};for(const n in e)t[n]=e[n];return t}var $="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function z(t){let n,r;for(let s=1;s<arguments.length;s++){for(n in r=arguments[s])t[n]=r[n];for(let e=0;e<$.length;e++)n=$[e],Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n])}}function Q(e){return Q[" "](e),e}Q[" "]=I;var H,W=U(P,"Opera"),Y=U(P,"Trident")||U(P,"MSIE"),X=U(P,"Edge"),J=X||Y,Z=U(P,"Gecko")&&!(U(P.toLowerCase(),"webkit")&&!U(P,"Edge"))&&!(U(P,"Trident")||U(P,"MSIE"))&&!U(P,"Edge"),ee=U(P.toLowerCase(),"webkit")&&!U(P,"Edge");function te(){var e=b.document;return e?e.documentMode:void 0}e:{var ne="",re=(re=P,Z?/rv:([^\);]+)(\)|;)/.exec(re):X?/Edge\/([\d\.]+)/.exec(re):Y?/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(re):ee?/WebKit\/(\S+)/.exec(re):W?/(?:Version)[ \/]?(\S+)/.exec(re):void 0);if(re&&(ne=re?re[1]:""),Y){re=te();if(null!=re&&re>parseFloat(ne)){H=String(re);break e}}H=ne}var se={};function ie(){return e=function(){let e=0;var t=B(String(H)).split("."),n=B("9").split("."),r=Math.max(t.length,n.length);for(let a=0;0==e&&a<r;a++)for(var s=t[a]||"",i=n[a]||"";s=/(\d*)(\D*)(.*)/.exec(s)||["","","",""],i=/(\d*)(\D*)(.*)/.exec(i)||["","","",""],(0!=s[0].length||0!=i[0].length)&&(e=q(0==s[1].length?0:parseInt(s[1],10),0==i[1].length?0:parseInt(i[1],10))||q(0==s[2].length,0==i[2].length)||q(s[2],i[2]),s=s[3],i=i[3],0==e););return 0<=e},t=se,Object.prototype.hasOwnProperty.call(t,9)?t[9]:t[9]=e(9);var e,t}var ae=b.document&&Y&&(te()||parseInt(H,10))||void 0,oe=function(){if(!b.addEventListener||!Object.defineProperty)return!1;var e=!1,t=Object.defineProperty({},"passive",{get:function(){e=!0}});try{b.addEventListener("test",I,t),b.removeEventListener("test",I,t)}catch(e){}return e}();function ue(e,t){this.type=e,this.g=this.target=t,this.defaultPrevented=!1}function ce(e,t){if(ue.call(this,e?e.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,e){var n=this.type=e.type,r=e.changedTouches&&e.changedTouches.length?e.changedTouches[0]:null;if(this.target=e.target||e.srcElement,this.g=t,t=e.relatedTarget){if(Z){e:{try{Q(t.nodeName);var s=!0;break e}catch(e){}s=!1}s||(t=null)}}else"mouseover"==n?t=e.fromElement:"mouseout"==n&&(t=e.toElement);this.relatedTarget=t,r?(this.clientX=void 0!==r.clientX?r.clientX:r.pageX,this.clientY=void 0!==r.clientY?r.clientY:r.pageY,this.screenX=r.screenX||0,this.screenY=r.screenY||0):(this.clientX=void 0!==e.clientX?e.clientX:e.pageX,this.clientY=void 0!==e.clientY?e.clientY:e.pageY,this.screenX=e.screenX||0,this.screenY=e.screenY||0),this.button=e.button,this.key=e.key||"",this.ctrlKey=e.ctrlKey,this.altKey=e.altKey,this.shiftKey=e.shiftKey,this.metaKey=e.metaKey,this.pointerId=e.pointerId||0,this.pointerType="string"==typeof e.pointerType?e.pointerType:he[e.pointerType]||"",this.state=e.state,(this.i=e).defaultPrevented&&ce.Z.h.call(this)}}ue.prototype.h=function(){this.defaultPrevented=!0},N(ce,ue);var he={2:"touch",3:"pen",4:"mouse"};ce.prototype.h=function(){ce.Z.h.call(this);var e=this.i;e.preventDefault?e.preventDefault():e.returnValue=!1};var le="closure_listenable_"+(1e6*Math.random()|0),de=0;function fe(e,t,n,r,s){this.listener=e,this.proxy=null,this.src=t,this.type=n,this.capture=!!r,this.ia=s,this.key=++de,this.ca=this.fa=!1}function ge(e){e.ca=!0,e.listener=null,e.proxy=null,e.src=null,e.ia=null}function me(e){this.src=e,this.g={},this.h=0}function pe(e,t){var n,r,s,i=t.type;i in e.g&&(n=e.g[i],(s=0<=(r=M(n,t)))&&Array.prototype.splice.call(n,r,1),s&&(ge(t),0==e.g[i].length&&(delete e.g[i],e.h--)))}function ye(e,t,n,r){for(var s=0;s<e.length;++s){var i=e[s];if(!i.ca&&i.listener==t&&i.capture==!!n&&i.ia==r)return s}return-1}me.prototype.add=function(e,t,n,r,s){var i=e.toString();(e=this.g[i])||(e=this.g[i]=[],this.h++);var a=ye(e,t,r,s);return-1<a?(t=e[a],n||(t.fa=!1)):((t=new fe(t,this.src,i,!!r,s)).fa=n,e.push(t)),t};var ve="closure_lm_"+(1e6*Math.random()|0),we={};function be(e,t,n,r,s){if(r&&r.once)return function e(t,n,r,s,i){if(Array.isArray(n)){for(var a=0;a<n.length;a++)e(t,n[a],r,s,i);return null}r=De(r);return t&&t[le]?t.O(n,r,T(s)?!!s.capture:!!s,i):Ie(t,n,r,!0,s,i)}(e,t,n,r,s);if(Array.isArray(t)){for(var i=0;i<t.length;i++)be(e,t[i],n,r,s);return null}return n=De(n),e&&e[le]?e.N(t,n,T(r)?!!r.capture:!!r,s):Ie(e,t,n,!1,r,s)}function Ie(e,t,n,r,s,i){if(!t)throw Error("Invalid event type");var a,o=T(s)?!!s.capture:!!s,u=_e(e);if(u||(e[ve]=u=new me(e)),(n=u.add(t,n,r,o,i)).proxy)return n;if(a=Se,r=function e(t){return a.call(e.src,e.listener,t)},(n.proxy=r).src=e,r.listener=n,e.addEventListener)void 0===(s=!oe?o:s)&&(s=!1),e.addEventListener(t.toString(),r,s);else if(e.attachEvent)e.attachEvent(Te(t.toString()),r);else{if(!e.addListener||!e.removeListener)throw Error("addEventListener and attachEvent are unavailable.");e.addListener(r)}return n}function Ee(e){var t,n,r;"number"!=typeof e&&e&&!e.ca&&((t=e.src)&&t[le]?pe(t.i,e):(n=e.type,r=e.proxy,t.removeEventListener?t.removeEventListener(n,r,e.capture):t.detachEvent?t.detachEvent(Te(n),r):t.addListener&&t.removeListener&&t.removeListener(r),(n=_e(t))?(pe(n,e),0==n.h&&(n.src=null,t[ve]=null)):ge(e)))}function Te(e){return e in we?we[e]:we[e]="on"+e}function Se(e,t){var n,r;return e=!!e.ca||(t=new ce(t,this),n=e.listener,r=e.ia||e.src,e.fa&&Ee(e),n.call(r,t))}function _e(e){return(e=e[ve])instanceof me?e:null}var xe="__closure_events_fn_"+(1e9*Math.random()>>>0);function De(t){return"function"==typeof t?t:(t[xe]||(t[xe]=function(e){return t.handleEvent(e)}),t[xe])}function Ae(){k.call(this),this.i=new me(this),(this.P=this).I=null}function Ce(e,t){var n,r=e.I;if(r)for(n=[];r;r=r.I)n.push(r);if(e=e.P,r=t.type||t,"string"==typeof t?t=new ue(t,e):t instanceof ue?t.target=t.target||e:(a=t,z(t=new ue(r,e),a)),a=!0,n)for(var s=n.length-1;0<=s;s--)var i=t.g=n[s],a=Ne(i,r,!0,t)&&a;if(a=Ne(i=t.g=e,r,!0,t)&&a,a=Ne(i,r,!1,t)&&a,n)for(s=0;s<n.length;s++)a=Ne(i=t.g=n[s],r,!1,t)&&a}function Ne(e,t,n,r){if(!(t=e.i.g[String(t)]))return!0;t=t.concat();for(var s=!0,i=0;i<t.length;++i){var a,o,u=t[i];u&&!u.ca&&u.capture==n&&(a=u.listener,o=u.ia||u.src,u.fa&&pe(e.i,u),s=!1!==a.call(o,r)&&s)}return s&&!r.defaultPrevented}N(Ae,k),Ae.prototype[le]=!0,Ae.prototype.removeEventListener=function(e,t,n,r){!function e(t,n,r,s,i){if(Array.isArray(n))for(var a=0;a<n.length;a++)e(t,n[a],r,s,i);else s=T(s)?!!s.capture:!!s,r=De(r),t&&t[le]?(t=t.i,(n=String(n).toString())in t.g&&-1<(r=ye(a=t.g[n],r,s,i))&&(ge(a[r]),Array.prototype.splice.call(a,r,1),0==a.length&&(delete t.g[n],t.h--))):(t=t&&_e(t))&&(n=t.g[n.toString()],(r=(t=-1)<(t=n?ye(n,r,s,i):t)?n[t]:null)&&Ee(r))}(this,e,t,n,r)},Ae.prototype.M=function(){if(Ae.Z.M.call(this),this.i){var e,t=this.i;for(e in t.g){for(var n=t.g[e],r=0;r<n.length;r++)ge(n[r]);delete t.g[e],t.h--}}this.I=null},Ae.prototype.N=function(e,t,n,r){return this.i.add(String(e),t,!1,n,r)},Ae.prototype.O=function(e,t,n,r){return this.i.add(String(e),t,!0,n,r)};var ke=b.JSON.stringify;var Re,Me=new class{constructor(e,t){this.i=e,this.j=t,this.h=0,this.g=null}get(){let e;return 0<this.h?(this.h--,e=this.g,this.g=e.next,e.next=null):e=this.i(),e}}(()=>new Le,e=>e.reset());class Le{constructor(){this.next=this.g=this.h=null}set(e,t){this.h=e,this.g=t,this.next=null}reset(){this.next=this.g=this.h=null}}function Oe(e,t){var n;Re||(n=b.Promise.resolve(void 0),Re=function(){n.then(Pe)}),Ve||(Re(),Ve=!0),Fe.add(e,t)}var Ve=!1,Fe=new class{constructor(){this.h=this.g=null}add(e,t){const n=Me.get();n.set(e,t),this.h?this.h.next=n:this.g=n,this.h=n}};function Pe(){for(var e;e=function(){var e=Fe;let t=null;return e.g&&(t=e.g,e.g=e.g.next,e.g||(e.h=null),t.next=null),t}();){try{e.h.call(e.g)}catch(e){!function(e){b.setTimeout(()=>{throw e},0)}(e)}var t=Me;t.j(e),t.h<100&&(t.h++,e.next=t.g,t.g=e)}Ve=!1}function Be(e,t){Ae.call(this),this.h=e||1,this.g=t||b,this.j=A(this.kb,this),this.l=Date.now()}function Ue(e){e.da=!1,e.S&&(e.g.clearTimeout(e.S),e.S=null)}function qe(e,t,n){if("function"==typeof e)n&&(e=A(e,n));else{if(!e||"function"!=typeof e.handleEvent)throw Error("Invalid listener argument");e=A(e.handleEvent,e)}return 2147483647<Number(t)?-1:b.setTimeout(e,t||0)}N(Be,Ae),(y=Be.prototype).da=!1,y.S=null,y.kb=function(){var e;this.da&&(0<(e=Date.now()-this.l)&&e<.8*this.h?this.S=this.g.setTimeout(this.j,this.h-e):(this.S&&(this.g.clearTimeout(this.S),this.S=null),Ce(this,"tick"),this.da&&(Ue(this),this.start())))},y.start=function(){this.da=!0,this.S||(this.S=this.g.setTimeout(this.j,this.h),this.l=Date.now())},y.M=function(){Be.Z.M.call(this),Ue(this),delete this.g};class je extends k{constructor(e,t){super(),this.m=e,this.j=t,this.h=null,this.i=!1,this.g=null}l(e){this.h=arguments,this.g?this.i=!0:function e(t){t.g=qe(()=>{t.g=null,t.i&&(t.i=!1,e(t))},t.j);var n=t.h;t.h=null,t.m.apply(null,n)}(this)}M(){super.M(),this.g&&(b.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function Ke(e){k.call(this),this.h=e,this.g={}}N(Ke,k);var Ge=[];function $e(e,t,n,r){Array.isArray(n)||(n&&(Ge[0]=n.toString()),n=Ge);for(var s=0;s<n.length;s++){var i=be(t,n[s],r||e.handleEvent,!1,e.h||e);if(!i)break;e.g[i.key]=i}}function ze(e){K(e.g,function(e,t){this.g.hasOwnProperty(t)&&Ee(e)},e),e.g={}}function Qe(){this.g=!0}function He(e,t,n,r){e.info(function(){return"XMLHTTP TEXT ("+t+"): "+function(e,t){if(!e.g)return t;if(!t)return null;try{var n=JSON.parse(t);if(n)for(e=0;e<n.length;e++)if(Array.isArray(n[e])){var r=n[e];if(!(r.length<2)){var s=r[1];if(Array.isArray(s)&&!(s.length<1)){var i=s[0];if("noop"!=i&&"stop"!=i&&"close"!=i)for(var a=1;a<s.length;a++)s[a]=""}}}return ke(n)}catch(e){return t}}(e,n)+(r?" "+r:"")})}Ke.prototype.M=function(){Ke.Z.M.call(this),ze(this)},Ke.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")},Qe.prototype.Aa=function(){this.g=!1},Qe.prototype.info=function(){};var We={},Ye=null;function Xe(){return Ye=Ye||new Ae}function Je(e){ue.call(this,We.Ma,e)}function Ze(){var e=Xe();Ce(e,new Je(e))}function et(e,t){ue.call(this,We.STAT_EVENT,e),this.stat=t}function tt(e){var t=Xe();Ce(t,new et(t,e))}function nt(e,t){ue.call(this,We.Na,e),this.size=t}function rt(e,t){if("function"!=typeof e)throw Error("Fn must not be null and must be a function");return b.setTimeout(function(){e()},t)}We.Ma="serverreachability",N(Je,ue),We.STAT_EVENT="statevent",N(et,ue),We.Na="timingevent",N(nt,ue);var st={NO_ERROR:0,lb:1,yb:2,xb:3,sb:4,wb:5,zb:6,Ja:7,TIMEOUT:8,Cb:9},it={qb:"complete",Mb:"success",Ka:"error",Ja:"abort",Eb:"ready",Fb:"readystatechange",TIMEOUT:"timeout",Ab:"incrementaldata",Db:"progress",tb:"downloadprogress",Ub:"uploadprogress"};function at(){}function ot(e){return e.h||(e.h=e.i())}function ut(){}at.prototype.h=null;v={OPEN:"a",pb:"b",Ka:"c",Bb:"d"};function ct(){ue.call(this,"d")}function ht(){ue.call(this,"c")}function lt(){}function dt(e,t,n,r){this.l=e,this.j=t,this.m=n,this.X=r||1,this.V=new Ke(this),this.P=mt,this.W=new Be(e=J?125:void 0),this.H=null,this.i=!1,this.s=this.A=this.v=this.K=this.F=this.Y=this.B=null,this.D=[],this.g=null,this.C=0,this.o=this.u=null,this.N=-1,this.I=!1,this.O=0,this.L=null,this.aa=this.J=this.$=this.U=!1,this.h=new ft}function ft(){this.i=null,this.g="",this.h=!1}N(ct,ue),N(ht,ue),N(lt,at),lt.prototype.g=function(){return new XMLHttpRequest},lt.prototype.i=function(){return{}};var gt=new lt,mt=45e3,pt={},yt={};function vt(e,t,n){e.K=1,e.v=Ut(Lt(t)),e.s=n,e.U=!0,wt(e,null)}function wt(e,t){e.F=Date.now(),Et(e),e.A=Lt(e.v);var a,o,u,c,h,l,n=e.A,r=e.X;Array.isArray(r)||(r=[String(r)]),Zt(n.h,"t",r),e.C=0,n=e.l.H,e.h=new ft,e.g=er(e.l,n?t:null,!e.s),0<e.O&&(e.L=new je(A(e.Ia,e,e.g),e.O)),$e(e.V,e.g,"readystatechange",e.gb),t=e.H?G(e.H):{},e.s?(e.u||(e.u="POST"),t["Content-Type"]="application/x-www-form-urlencoded",e.g.ea(e.A,e.u,e.s,t)):(e.u="GET",e.g.ea(e.A,e.u,null,t)),Ze(),a=e.j,o=e.u,u=e.A,c=e.m,h=e.X,l=e.s,a.info(function(){if(a.g)if(l)for(var e="",t=l.split("&"),n=0;n<t.length;n++){var r,s,i=t[n].split("=");1<i.length&&(r=i[0],i=i[1],e=2<=(s=r.split("_")).length&&"type"==s[1]?e+(r+"=")+i+"&":e+(r+"=redacted&"))}else e=null;else e=l;return"XMLHTTP REQ ("+c+") [attempt "+h+"]: "+o+"\n"+u+"\n"+e})}function bt(e){return e.g&&("GET"==e.u&&2!=e.K&&e.l.Ba)}function It(e,t,n){let r=!0,s;for(;!e.I&&e.C<n.length;){if(s=(a=n,u=o=void 0,o=(i=e).C,-1==(u=a.indexOf("\n",o))?yt:(o=Number(a.substring(o,u)),isNaN(o)?pt:(u+=1)+o>a.length?yt:(a=a.substr(u,o),i.C=u+o,a))),s==yt){4==t&&(e.o=4,tt(14),r=!1),He(e.j,e.m,null,"[Incomplete Response]");break}if(s==pt){e.o=4,tt(15),He(e.j,e.m,n,"[Invalid Chunk]"),r=!1;break}He(e.j,e.m,s,null),Dt(e,s)}var i,a,o,u;bt(e)&&s!=yt&&s!=pt&&(e.h.g="",e.C=0),4!=t||0!=n.length||e.h.h||(e.o=1,tt(16),r=!1),e.i=e.i&&r,r?0<n.length&&!e.aa&&(e.aa=!0,(t=e.l).g==e&&t.$&&!t.L&&(t.h.info("Great, no buffering proxy detected. Bytes received: "+n.length),zn(t),t.L=!0,tt(11))):(He(e.j,e.m,n,"[Invalid Chunked Response]"),xt(e),_t(e))}function Et(e){e.Y=Date.now()+e.P,Tt(e,e.P)}function Tt(e,t){if(null!=e.B)throw Error("WatchDog timer not null");e.B=rt(A(e.eb,e),t)}function St(e){e.B&&(b.clearTimeout(e.B),e.B=null)}function _t(e){0==e.l.G||e.I||Wn(e.l,e)}function xt(e){St(e);var t=e.L;t&&"function"==typeof t.na&&t.na(),e.L=null,Ue(e.W),ze(e.V),e.g&&(t=e.g,e.g=null,t.abort(),t.na())}function Dt(e,t){try{var n=e.l;if(0!=n.G&&(n.g==e||on(n.i,e)))if(n.I=e.N,!e.J&&on(n.i,e)&&3==n.G){try{var r=n.Ca.g.parse(t)}catch(e){r=null}if(Array.isArray(r)&&3==r.length){var s=r;if(0==s[0]){e:if(!n.u){if(n.g){if(!(n.g.F+3e3<e.F))break e;Hn(n),Fn(n)}$n(n),tt(18)}}else n.ta=s[1],0<n.ta-n.U&&s[2]<37500&&n.N&&0==n.A&&!n.v&&(n.v=rt(A(n.ab,n),6e3));if(an(n.i)<=1&&n.ka){try{n.ka()}catch(e){}n.ka=void 0}}else Xn(n,11)}else if(!e.J&&n.g!=e||Hn(n),!F(t))for(s=n.Ca.g.parse(t),t=0;t<s.length;t++){var i=s[t];if(n.U=i[0],i=i[1],2==n.G)if("c"==i[0]){n.J=i[1],n.la=i[2];var a=i[3];null!=a&&(n.ma=a,n.h.info("VER="+n.ma));var o=i[4];null!=o&&(n.za=o,n.h.info("SVER="+n.za));var u,c,h,l=i[5];null!=l&&"number"==typeof l&&0<l&&(r=1.5*l,n.K=r,n.h.info("backChannelRequestTimeoutMs_="+r)),r=n;const m=e.g;m&&(!(u=m.g?m.g.getResponseHeader("X-Client-Wire-Protocol"):null)||!(c=r.i).g&&(U(u,"spdy")||U(u,"quic")||U(u,"h2"))&&(c.j=c.l,c.g=new Set,c.h&&(un(c,c.h),c.h=null)),!r.D||(h=m.g?m.g.getResponseHeader("X-HTTP-Session-Id"):null)&&(r.sa=h,Bt(r.F,r.D,h))),n.G=3,n.j&&n.j.xa(),n.$&&(n.O=Date.now()-e.F,n.h.info("Handshake RTT: "+n.O+"ms"));var d,f,g=e;(r=n).oa=Zn(r,r.H?r.la:null,r.W),g.J?(cn(r.i,g),d=g,(f=r.K)&&d.setTimeout(f),d.B&&(St(d),Et(d)),r.g=g):Gn(r),0<n.l.length&&Un(n)}else"stop"!=i[0]&&"close"!=i[0]||Xn(n,7);else 3==n.G&&("stop"==i[0]||"close"==i[0]?"stop"==i[0]?Xn(n,7):Vn(n):"noop"!=i[0]&&n.j&&n.j.wa(i),n.A=0)}Ze()}catch(e){}}function At(e,t){if(e.forEach&&"function"==typeof e.forEach)e.forEach(t,void 0);else if(E(e)||"string"==typeof e)L(e,t,void 0);else{if(e.T&&"function"==typeof e.T)var n=e.T();else if(e.R&&"function"==typeof e.R)n=void 0;else if(E(e)||"string"==typeof e)for(var n=[],r=e.length,s=0;s<r;s++)n.push(s);else for(s in n=[],r=0,e)n[r++]=s;for(var s=(r=function(e){if(e.R&&"function"==typeof e.R)return e.R();if("string"==typeof e)return e.split("");if(E(e)){for(var t=[],n=e.length,r=0;r<n;r++)t.push(e[r]);return t}for(r in t=[],n=0,e)t[n++]=e[r];return t}(e)).length,i=0;i<s;i++)t.call(void 0,r[i],n&&n[i],e)}}function Ct(e,t){this.h={},this.g=[],this.i=0;var n=arguments.length;if(1<n){if(n%2)throw Error("Uneven number of arguments");for(var r=0;r<n;r+=2)this.set(arguments[r],arguments[r+1])}else if(e)if(e instanceof Ct)for(n=e.T(),r=0;r<n.length;r++)this.set(n[r],e.get(n[r]));else for(r in e)this.set(r,e[r])}function Nt(e){if(e.i!=e.g.length){for(var t=0,n=0;t<e.g.length;){var r=e.g[t];kt(e.h,r)&&(e.g[n++]=r),t++}e.g.length=n}if(e.i!=e.g.length){for(var s={},n=t=0;t<e.g.length;)kt(s,r=e.g[t])||(s[e.g[n++]=r]=1),t++;e.g.length=n}}function kt(e,t){return Object.prototype.hasOwnProperty.call(e,t)}(y=dt.prototype).setTimeout=function(e){this.P=e},y.gb=function(e){e=e.target;const t=this.L;t&&3==kn(e)?t.l():this.Ia(e)},y.Ia=function(e){try{if(e==this.g)e:{var t=kn(this.g),n=this.g.Da();this.g.ba();if(!(t<3)&&(3!=t||J||this.g&&(this.h.h||this.g.ga()||Rn(this.g)))){this.I||4!=t||7==n||Ze(),St(this);var r=this.g.ba();this.N=r;t:if(bt(this)){var s=Rn(this.g);e="";var i=s.length,a=4==kn(this.g);if(!this.h.i){if("undefined"==typeof TextDecoder){xt(this),_t(this);var o="";break t}this.h.i=new b.TextDecoder}for(n=0;n<i;n++)this.h.h=!0,e+=this.h.i.decode(s[n],{stream:a&&n==i-1});s.splice(0,i),this.h.g+=e,this.C=0,o=this.h.g}else o=this.g.ga();if(this.i=200==r,l=this.j,d=this.u,f=this.A,g=this.m,m=this.X,p=t,y=r,l.info(function(){return"XMLHTTP RESP ("+g+") [ attempt "+m+"]: "+d+"\n"+f+"\n"+p+" "+y}),this.i){if(this.$&&!this.J){t:{if(this.g){var u,c=this.g;if((u=c.g?c.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!F(u)){var h=u;break t}}h=null}if(!(r=h)){this.i=!1,this.o=3,tt(12),xt(this),_t(this);break e}He(this.j,this.m,r,"Initial handshake response via X-HTTP-Initial-Response"),this.J=!0,Dt(this,r)}this.U?(It(this,t,o),J&&this.i&&3==t&&($e(this.V,this.W,"tick",this.fb),this.W.start())):(He(this.j,this.m,o,null),Dt(this,o)),4==t&&xt(this),this.i&&!this.I&&(4==t?Wn(this.l,this):(this.i=!1,Et(this)))}else 400==r&&0<o.indexOf("Unknown SID")?(this.o=3,tt(12)):(this.o=0,tt(13)),xt(this),_t(this)}}}catch(e){}var l,d,f,g,m,p,y},y.fb=function(){var e,t;this.g&&(e=kn(this.g),t=this.g.ga(),this.C<t.length&&(St(this),It(this,e,t),this.i&&4!=e&&Et(this)))},y.cancel=function(){this.I=!0,xt(this)},y.eb=function(){this.B=null;var e,t,n=Date.now();0<=n-this.Y?(e=this.j,t=this.A,e.info(function(){return"TIMEOUT: "+t}),2!=this.K&&(Ze(),tt(17)),xt(this),this.o=2,_t(this)):Tt(this,this.Y-n)},(y=Ct.prototype).R=function(){Nt(this);for(var e=[],t=0;t<this.g.length;t++)e.push(this.h[this.g[t]]);return e},y.T=function(){return Nt(this),this.g.concat()},y.get=function(e,t){return kt(this.h,e)?this.h[e]:t},y.set=function(e,t){kt(this.h,e)||(this.i++,this.g.push(e)),this.h[e]=t},y.forEach=function(e,t){for(var n=this.T(),r=0;r<n.length;r++){var s=n[r],i=this.get(s);e.call(t,i,s,this)}};var Rt=/^(?:([^:/?#.]+):)?(?:\/\/(?:([^\\/?#]*)@)?([^\\/?#]*?)(?::([0-9]+))?(?=[\\/?#]|$))?([^?#]+)?(?:\?([^#]*))?(?:#([\s\S]*))?$/;function Mt(e,t){var n;this.i=this.s=this.j="",this.m=null,this.o=this.l="",this.g=!1,e instanceof Mt?(this.g=void 0!==t?t:e.g,Ot(this,e.j),this.s=e.s,Vt(this,e.i),Ft(this,e.m),this.l=e.l,t=e.h,(n=new Wt).i=t.i,t.g&&(n.g=new Ct(t.g),n.h=t.h),Pt(this,n),this.o=e.o):e&&(n=String(e).match(Rt))?(this.g=!!t,Ot(this,n[1]||"",!0),this.s=qt(n[2]||""),Vt(this,n[3]||"",!0),Ft(this,n[4]),this.l=qt(n[5]||"",!0),Pt(this,n[6]||"",!0),this.o=qt(n[7]||"")):(this.g=!!t,this.h=new Wt(null,this.g))}function Lt(e){return new Mt(e)}function Ot(e,t,n){e.j=n?qt(t,!0):t,e.j&&(e.j=e.j.replace(/:$/,""))}function Vt(e,t,n){e.i=n?qt(t,!0):t}function Ft(e,t){if(t){if(t=Number(t),isNaN(t)||t<0)throw Error("Bad port number "+t);e.m=t}else e.m=null}function Pt(e,t,n){var r,s;t instanceof Wt?(e.h=t,r=e.h,(s=e.g)&&!r.j&&(Yt(r),r.i=null,r.g.forEach(function(e,t){var n=t.toLowerCase();t!=n&&(Xt(this,t),Zt(this,n,e))},r)),r.j=s):(n||(t=jt(t,Qt)),e.h=new Wt(t,e.g))}function Bt(e,t,n){e.h.set(t,n)}function Ut(e){return Bt(e,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),e}function qt(e,t){return e?t?decodeURI(e.replace(/%25/g,"%2525")):decodeURIComponent(e):""}function jt(e,t,n){return"string"==typeof e?(e=encodeURI(e).replace(t,Kt),e=n?e.replace(/%25([0-9a-fA-F]{2})/g,"%$1"):e):null}function Kt(e){return"%"+((e=e.charCodeAt(0))>>4&15).toString(16)+(15&e).toString(16)}Mt.prototype.toString=function(){var e=[],t=this.j;t&&e.push(jt(t,Gt,!0),":");var n=this.i;return!n&&"file"!=t||(e.push("//"),(t=this.s)&&e.push(jt(t,Gt,!0),"@"),e.push(encodeURIComponent(String(n)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(n=this.m)&&e.push(":",String(n))),(n=this.l)&&(this.i&&"/"!=n.charAt(0)&&e.push("/"),e.push(jt(n,"/"==n.charAt(0)?zt:$t,!0))),(n=this.h.toString())&&e.push("?",n),(n=this.o)&&e.push("#",jt(n,Ht)),e.join("")};var Gt=/[#\/\?@]/g,$t=/[#\?:]/g,zt=/[#\?]/g,Qt=/[#\?@]/g,Ht=/#/g;function Wt(e,t){this.h=this.g=null,this.i=e||null,this.j=!!t}function Yt(n){n.g||(n.g=new Ct,n.h=0,n.i&&function(e,t){if(e){e=e.split("&");for(var n=0;n<e.length;n++){var r,s=e[n].indexOf("="),i=null;0<=s?(r=e[n].substring(0,s),i=e[n].substring(s+1)):r=e[n],t(r,i?decodeURIComponent(i.replace(/\+/g," ")):"")}}}(n.i,function(e,t){n.add(decodeURIComponent(e.replace(/\+/g," ")),t)}))}function Xt(e,t){Yt(e),t=en(e,t),kt(e.g.h,t)&&(e.i=null,e.h-=e.g.get(t).length,kt((e=e.g).h,t)&&(delete e.h[t],e.i--,e.g.length>2*e.i&&Nt(e)))}function Jt(e,t){return Yt(e),t=en(e,t),kt(e.g.h,t)}function Zt(e,t,n){Xt(e,t),0<n.length&&(e.i=null,e.g.set(en(e,t),V(n)),e.h+=n.length)}function en(e,t){return t=String(t),t=e.j?t.toLowerCase():t}(y=Wt.prototype).add=function(e,t){Yt(this),this.i=null,e=en(this,e);var n=this.g.get(e);return n||this.g.set(e,n=[]),n.push(t),this.h+=1,this},y.forEach=function(n,r){Yt(this),this.g.forEach(function(e,t){L(e,function(e){n.call(r,e,t,this)},this)},this)},y.T=function(){Yt(this);for(var e=this.g.R(),t=this.g.T(),n=[],r=0;r<t.length;r++)for(var s=e[r],i=0;i<s.length;i++)n.push(t[r]);return n},y.R=function(e){Yt(this);var t=[];if("string"==typeof e)Jt(this,e)&&(t=O(t,this.g.get(en(this,e))));else{e=this.g.R();for(var n=0;n<e.length;n++)t=O(t,e[n])}return t},y.set=function(e,t){return Yt(this),this.i=null,Jt(this,e=en(this,e))&&(this.h-=this.g.get(e).length),this.g.set(e,[t]),this.h+=1,this},y.get=function(e,t){return e&&0<(e=this.R(e)).length?String(e[0]):t},y.toString=function(){if(this.i)return this.i;if(!this.g)return"";for(var e=[],t=this.g.T(),n=0;n<t.length;n++)for(var r=t[n],s=encodeURIComponent(String(r)),r=this.R(r),i=0;i<r.length;i++){var a=s;""!==r[i]&&(a+="="+encodeURIComponent(String(r[i]))),e.push(a)}return this.i=e.join("&")};var tn=class{constructor(e,t){this.h=e,this.g=t}};function nn(e){this.l=e||10,e=b.PerformanceNavigationTiming?0<(e=b.performance.getEntriesByType("navigation")).length&&("hq"==e[0].nextHopProtocol||"h2"==e[0].nextHopProtocol):!!(b.g&&b.g.Ea&&b.g.Ea()&&b.g.Ea().Zb),this.j=e?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}var rn;function sn(e){return e.h||e.g&&e.g.size>=e.j}function an(e){return e.h?1:e.g?e.g.size:0}function on(e,t){return e.h?e.h==t:e.g&&e.g.has(t)}function un(e,t){e.g?e.g.add(t):e.h=t}function cn(e,t){e.h&&e.h==t?e.h=null:e.g&&e.g.has(t)&&e.g.delete(t)}function hn(t){if(null!=t.h)return t.i.concat(t.h.D);if(null==t.g||0===t.g.size)return V(t.i);{let e=t.i;for(const n of t.g.values())e=e.concat(n.D);return e}}function ln(){}function dn(){this.g=new ln}function fn(e,t,n,r,s){try{t.onload=null,t.onerror=null,t.onabort=null,t.ontimeout=null,s(r)}catch(e){}}function gn(e){this.l=e.$b||null,this.j=e.ib||!1}function mn(e,t){Ae.call(this),this.D=e,this.u=t,this.m=void 0,this.readyState=pn,this.status=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.v=new Headers,this.h=null,this.C="GET",this.B="",this.g=!1,this.A=this.j=this.l=null}nn.prototype.cancel=function(){if(this.i=hn(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&0!==this.g.size){for(const e of this.g.values())e.cancel();this.g.clear()}},ln.prototype.stringify=function(e){return b.JSON.stringify(e,void 0)},ln.prototype.parse=function(e){return b.JSON.parse(e,void 0)},N(gn,at),gn.prototype.g=function(){return new mn(this.l,this.j)},gn.prototype.i=(rn={},function(){return rn}),N(mn,Ae);var pn=0;function yn(e){e.j.read().then(e.Sa.bind(e)).catch(e.ha.bind(e))}function vn(e){e.readyState=4,e.l=null,e.j=null,e.A=null,wn(e)}function wn(e){e.onreadystatechange&&e.onreadystatechange.call(e)}(y=mn.prototype).open=function(e,t){if(this.readyState!=pn)throw this.abort(),Error("Error reopening a connection");this.C=e,this.B=t,this.readyState=1,wn(this)},y.send=function(e){if(1!=this.readyState)throw this.abort(),Error("need to call open() first. ");this.g=!0;const t={headers:this.v,method:this.C,credentials:this.m,cache:void 0};e&&(t.body=e),(this.D||b).fetch(new Request(this.B,t)).then(this.Va.bind(this),this.ha.bind(this))},y.abort=function(){this.response=this.responseText="",this.v=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted."),1<=this.readyState&&this.g&&4!=this.readyState&&(this.g=!1,vn(this)),this.readyState=pn},y.Va=function(e){if(this.g&&(this.l=e,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=e.headers,this.readyState=2,wn(this)),this.g&&(this.readyState=3,wn(this),this.g)))if("arraybuffer"===this.responseType)e.arrayBuffer().then(this.Ta.bind(this),this.ha.bind(this));else if(void 0!==b.ReadableStream&&"body"in e){if(this.j=e.body.getReader(),this.u){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.A=new TextDecoder;yn(this)}else e.text().then(this.Ua.bind(this),this.ha.bind(this))},y.Sa=function(e){var t;this.g&&(this.u&&e.value?this.response.push(e.value):this.u||(t=e.value||new Uint8Array(0),(t=this.A.decode(t,{stream:!e.done}))&&(this.response=this.responseText+=t)),(e.done?vn:wn)(this),3==this.readyState&&yn(this))},y.Ua=function(e){this.g&&(this.response=this.responseText=e,vn(this))},y.Ta=function(e){this.g&&(this.response=e,vn(this))},y.ha=function(){this.g&&vn(this)},y.setRequestHeader=function(e,t){this.v.append(e,t)},y.getResponseHeader=function(e){return this.h&&this.h.get(e.toLowerCase())||""},y.getAllResponseHeaders=function(){if(!this.h)return"";const e=[],t=this.h.entries();for(var n=t.next();!n.done;)n=n.value,e.push(n[0]+": "+n[1]),n=t.next();return e.join("\r\n")},Object.defineProperty(mn.prototype,"withCredentials",{get:function(){return"include"===this.m},set:function(e){this.m=e?"include":"same-origin"}});var bn=b.JSON.parse;function In(e){Ae.call(this),this.headers=new Ct,this.u=e||null,this.h=!1,this.C=this.g=null,this.H="",this.m=0,this.j="",this.l=this.F=this.v=this.D=!1,this.B=0,this.A=null,this.J=En,this.K=this.L=!1}N(In,Ae);var En="",Tn=/^https?$/i,Sn=["POST","PUT"];function _n(e){return"content-type"==e.toLowerCase()}function xn(e,t){e.h=!1,e.g&&(e.l=!0,e.g.abort(),e.l=!1),e.j=t,e.m=5,Dn(e),Cn(e)}function Dn(e){e.D||(e.D=!0,Ce(e,"complete"),Ce(e,"error"))}function An(e){if(e.h&&void 0!==w&&(!e.C[1]||4!=kn(e)||2!=e.ba()))if(e.v&&4==kn(e))qe(e.Fa,0,e);else if(Ce(e,"readystatechange"),4==kn(e)){e.h=!1;try{var t,n,r,s,i=e.ba();e:switch(i){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var a=!0;break e;default:a=!1}if((t=a)||((n=0===i)&&(!(s=String(e.H).match(Rt)[1]||null)&&b.self&&b.self.location&&(s=(r=b.self.location.protocol).substr(0,r.length-1)),n=!Tn.test(s?s.toLowerCase():"")),t=n),t)Ce(e,"complete"),Ce(e,"success");else{e.m=6;try{var o=2<kn(e)?e.g.statusText:""}catch(e){o=""}e.j=o+" ["+e.ba()+"]",Dn(e)}}finally{Cn(e)}}}function Cn(e,t){if(e.g){Nn(e);const n=e.g,r=e.C[0]?I:null;e.g=null,e.C=null,t||Ce(e,"ready");try{n.onreadystatechange=r}catch(e){}}}function Nn(e){e.g&&e.K&&(e.g.ontimeout=null),e.A&&(b.clearTimeout(e.A),e.A=null)}function kn(e){return e.g?e.g.readyState:0}function Rn(e){try{if(!e.g)return null;if("response"in e.g)return e.g.response;switch(e.J){case En:case"text":return e.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in e.g)return e.g.mozResponseArrayBuffer}return null}catch(e){return null}}function Mn(e,t,n){e:{for(r in n){var r=!1;break e}r=!0}r||(n=function(e){let n="";return K(e,function(e,t){n+=t,n+=":",n+=e,n+="\r\n"}),n}(n),"string"==typeof e?null!=n&&encodeURIComponent(String(n)):Bt(e,t,n))}function Ln(e,t,n){return n&&n.internalChannelParams&&n.internalChannelParams[e]||t}function On(e){this.za=0,this.l=[],this.h=new Qe,this.la=this.oa=this.F=this.W=this.g=this.sa=this.D=this.aa=this.o=this.P=this.s=null,this.Za=this.V=0,this.Xa=Ln("failFast",!1,e),this.N=this.v=this.u=this.m=this.j=null,this.X=!0,this.I=this.ta=this.U=-1,this.Y=this.A=this.C=0,this.Pa=Ln("baseRetryDelayMs",5e3,e),this.$a=Ln("retryDelaySeedMs",1e4,e),this.Ya=Ln("forwardChannelMaxRetries",2,e),this.ra=Ln("forwardChannelRequestTimeoutMs",2e4,e),this.qa=e&&e.xmlHttpFactory||void 0,this.Ba=e&&e.Yb||!1,this.K=void 0,this.H=e&&e.supportsCrossDomainXhr||!1,this.J="",this.i=new nn(e&&e.concurrentRequestLimit),this.Ca=new dn,this.ja=e&&e.fastHandshake||!1,this.Ra=e&&e.Wb||!1,e&&e.Aa&&this.h.Aa(),e&&e.forceLongPolling&&(this.X=!1),this.$=!this.ja&&this.X&&e&&e.detectBufferingProxy||!1,this.ka=void 0,this.O=0,this.L=!1,this.B=null,this.Wa=!e||!1!==e.Xb}function Vn(e){var t,n;Pn(e),3==e.G&&(t=e.V++,Bt(n=Lt(e.F),"SID",e.J),Bt(n,"RID",t),Bt(n,"TYPE","terminate"),jn(e,n),(t=new dt(e,e.h,t,void 0)).K=2,t.v=Ut(Lt(n)),n=!1,!(n=b.navigator&&b.navigator.sendBeacon?b.navigator.sendBeacon(t.v.toString(),""):n)&&b.Image&&((new Image).src=t.v,n=!0),n||(t.g=er(t.l,null),t.g.ea(t.v)),t.F=Date.now(),Et(t)),Jn(e)}function Fn(e){e.g&&(zn(e),e.g.cancel(),e.g=null)}function Pn(e){Fn(e),e.u&&(b.clearTimeout(e.u),e.u=null),Hn(e),e.i.cancel(),e.m&&("number"==typeof e.m&&b.clearTimeout(e.m),e.m=null)}function Bn(e,t){e.l.push(new tn(e.Za++,t)),3==e.G&&Un(e)}function Un(e){sn(e.i)||e.m||(e.m=!0,Oe(e.Ha,e),e.C=0)}function qn(e,t){var n=t?t.m:e.V++,r=Lt(e.F);Bt(r,"SID",e.J),Bt(r,"RID",n),Bt(r,"AID",e.U),jn(e,r),e.o&&e.s&&Mn(r,e.o,e.s),n=new dt(e,e.h,n,e.C+1),null===e.o&&(n.H=e.s),t&&(e.l=t.D.concat(e.l)),t=Kn(e,n,1e3),n.setTimeout(Math.round(.5*e.ra)+Math.round(.5*e.ra*Math.random())),un(e.i,n),vt(n,r,t)}function jn(e,n){e.j&&At({},function(e,t){Bt(n,t,e)})}function Kn(e,t,r){r=Math.min(e.l.length,r);var s=e.j?A(e.j.Oa,e.j,e):null;e:{var i=e.l;let n=-1;for(;;){const u=["count="+r];-1==n?0<r?(n=i[0].h,u.push("ofs="+n)):n=0:u.push("ofs="+n);let e=!0;for(let t=0;t<r;t++){var a=i[t].h,o=i[t].g;if((a-=n)<0)n=Math.max(0,i[t].h-100),e=!1;else try{!function(e,r,t){const s=t||"";try{At(e,function(e,t){let n=e;T(e)&&(n=ke(e)),r.push(s+t+"="+encodeURIComponent(n))})}catch(e){throw r.push(s+"type="+encodeURIComponent("_badmap")),e}}(o,u,"req"+a+"_")}catch(e){s&&s(o)}}if(e){s=u.join("&");break e}}}return e=e.l.splice(0,r),t.D=e,s}function Gn(e){e.g||e.u||(e.Y=1,Oe(e.Ga,e),e.A=0)}function $n(e){return!(e.g||e.u||3<=e.A)&&(e.Y++,e.u=rt(A(e.Ga,e),Yn(e,e.A)),e.A++,1)}function zn(e){null!=e.B&&(b.clearTimeout(e.B),e.B=null)}function Qn(e){e.g=new dt(e,e.h,"rpc",e.Y),null===e.o&&(e.g.H=e.s),e.g.O=0;var t=Lt(e.oa);Bt(t,"RID","rpc"),Bt(t,"SID",e.J),Bt(t,"CI",e.N?"0":"1"),Bt(t,"AID",e.U),jn(e,t),Bt(t,"TYPE","xmlhttp"),e.o&&e.s&&Mn(t,e.o,e.s),e.K&&e.g.setTimeout(e.K);var n=e.g;e=e.la,n.K=1,n.v=Ut(Lt(t)),n.s=null,n.U=!0,wt(n,e)}function Hn(e){null!=e.v&&(b.clearTimeout(e.v),e.v=null)}function Wn(e,t){var n,r,s,i=null;if(e.g==t){Hn(e),zn(e),e.g=null;var a=2}else{if(!on(e.i,t))return;i=t.D,cn(e.i,t),a=1}if(e.I=t.N,0!=e.G)if(t.i)1==a?(i=t.s?t.s.length:0,t=Date.now()-t.F,n=e.C,Ce(a=Xe(),new nt(a,i)),Un(e)):Gn(e);else if(3==(n=t.o)||0==n&&0<e.I||(1!=a||(s=t,an((r=e).i)>=r.i.j-(r.m?1:0)||(r.m?(r.l=s.D.concat(r.l),0):1==r.G||2==r.G||r.C>=(r.Xa?0:r.Ya)||(r.m=rt(A(r.Ha,r,s),Yn(r,r.C)),r.C++,0))))&&(2!=a||!$n(e)))switch(i&&0<i.length&&(t=e.i,t.i=t.i.concat(i)),n){case 1:Xn(e,5);break;case 4:Xn(e,10);break;case 3:Xn(e,6);break;default:Xn(e,2)}}function Yn(e,t){let n=e.Pa+Math.floor(Math.random()*e.$a);return e.j||(n*=2),n*t}function Xn(e,t){var n,r;e.h.info("Error code "+t),2==t?(n=null,e.j&&(n=null),r=A(e.jb,e),n||(n=new Mt("//www.google.com/images/cleardot.gif"),b.location&&"http"==b.location.protocol||Ot(n,"https"),Ut(n)),function(e,t){var n=new Qe;if(b.Image){const r=new Image;r.onload=C(fn,n,r,"TestLoadImage: loaded",!0,t),r.onerror=C(fn,n,r,"TestLoadImage: error",!1,t),r.onabort=C(fn,n,r,"TestLoadImage: abort",!1,t),r.ontimeout=C(fn,n,r,"TestLoadImage: timeout",!1,t),b.setTimeout(function(){r.ontimeout&&r.ontimeout()},1e4),r.src=e}else t(!1)}(n.toString(),r)):tt(2),e.G=0,e.j&&e.j.va(t),Jn(e),Pn(e)}function Jn(e){e.G=0,e.I=-1,e.j&&(0==hn(e.i).length&&0==e.l.length||(e.i.i.length=0,V(e.l),e.l.length=0),e.j.ua())}function Zn(e,t,n){let r=(o=n)instanceof Mt?Lt(o):new Mt(o,void 0);var s,i,a,o,u;return""!=r.i?(t&&Vt(r,t+"."+r.i),Ft(r,r.m)):(u=b.location,r=(s=u.protocol,i=t?t+"."+u.hostname:u.hostname,a=+u.port,o=n,u=new Mt(null,void 0),s&&Ot(u,s),i&&Vt(u,i),a&&Ft(u,a),o&&(u.l=o),u)),e.aa&&K(e.aa,function(e,t){Bt(r,t,e)}),t=e.D,n=e.sa,t&&n&&Bt(r,t,n),Bt(r,"VER",e.ma),jn(e,r),r}function er(e,t,n){if(t&&!e.H)throw Error("Can't create secondary domain capable XhrIo object.");return(t=n&&e.Ba&&!e.qa?new In(new gn({ib:!0})):new In(e.qa)).L=e.H,t}function tr(){}function nr(){if(Y&&!(10<=Number(ae)))throw Error("Environmental error: no available transport.")}function rr(e,t){Ae.call(this),this.g=new On(t),this.l=e,this.h=t&&t.messageUrlParams||null,e=t&&t.messageHeaders||null,t&&t.clientProtocolHeaderRequired&&(e?e["X-Client-Protocol"]="webchannel":e={"X-Client-Protocol":"webchannel"}),this.g.s=e,e=t&&t.initMessageHeaders||null,t&&t.messageContentType&&(e?e["X-WebChannel-Content-Type"]=t.messageContentType:e={"X-WebChannel-Content-Type":t.messageContentType}),t&&t.ya&&(e?e["X-WebChannel-Client-Profile"]=t.ya:e={"X-WebChannel-Client-Profile":t.ya}),this.g.P=e,(e=t&&t.httpHeadersOverwriteParam)&&!F(e)&&(this.g.o=e),this.A=t&&t.supportsCrossDomainXhr||!1,this.v=t&&t.sendRawJson||!1,(t=t&&t.httpSessionIdParam)&&!F(t)&&(this.g.D=t,null!==(e=this.h)&&t in e&&(t in(e=this.h)&&delete e[t])),this.j=new ar(this)}function sr(e){ct.call(this);var t=e.__sm__;if(t){e:{for(const n in t){e=n;break e}e=void 0}(this.i=e)&&(e=this.i,t=null!==t&&e in t?t[e]:void 0),this.data=t}else this.data=e}function ir(){ht.call(this),this.status=1}function ar(e){this.g=e}(y=In.prototype).ea=function(e,t,n,r){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.H+"; newUri="+e);t=t?t.toUpperCase():"GET",this.H=e,this.j="",this.m=0,this.D=!1,this.h=!0,this.g=(this.u||gt).g(),this.C=this.u?ot(this.u):ot(gt),this.g.onreadystatechange=A(this.Fa,this);try{this.F=!0,this.g.open(t,String(e),!0),this.F=!1}catch(e){return void xn(this,e)}e=n||"";const s=new Ct(this.headers);r&&At(r,function(e,t){s.set(t,e)}),r=function(t){e:{var n=_n,r=t.length,s="string"==typeof t?t.split(""):t;for(let e=0;e<r;e++)if(e in s&&n.call(void 0,s[e],e,t)){n=e;break e}n=-1}return n<0?null:"string"==typeof t?t.charAt(n):t[n]}(s.T()),n=b.FormData&&e instanceof b.FormData,0<=M(Sn,t)&&!r&&!n&&s.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8"),s.forEach(function(e,t){this.g.setRequestHeader(t,e)},this),this.J&&(this.g.responseType=this.J),"withCredentials"in this.g&&this.g.withCredentials!==this.L&&(this.g.withCredentials=this.L);try{Nn(this),0<this.B&&((this.K=(i=this.g,Y&&ie()&&"number"==typeof i.timeout&&void 0!==i.ontimeout))?(this.g.timeout=this.B,this.g.ontimeout=A(this.pa,this)):this.A=qe(this.pa,this.B,this)),this.v=!0,this.g.send(e),this.v=!1}catch(e){xn(this,e)}var i},y.pa=function(){void 0!==w&&this.g&&(this.j="Timed out after "+this.B+"ms, aborting",this.m=8,Ce(this,"timeout"),this.abort(8))},y.abort=function(e){this.g&&this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1,this.m=e||7,Ce(this,"complete"),Ce(this,"abort"),Cn(this))},y.M=function(){this.g&&(this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1),Cn(this,!0)),In.Z.M.call(this)},y.Fa=function(){this.s||(this.F||this.v||this.l?An(this):this.cb())},y.cb=function(){An(this)},y.ba=function(){try{return 2<kn(this)?this.g.status:-1}catch(e){return-1}},y.ga=function(){try{return this.g?this.g.responseText:""}catch(e){return""}},y.Qa=function(e){if(this.g){var t=this.g.responseText;return e&&0==t.indexOf(e)&&(t=t.substring(e.length)),bn(t)}},y.Da=function(){return this.m},y.La=function(){return"string"==typeof this.j?this.j:String(this.j)},(y=On.prototype).ma=8,y.G=1,y.hb=function(e){try{this.h.info("Origin Trials invoked: "+e)}catch(e){}},y.Ha=function(t){if(this.m)if(this.m=null,1==this.G){if(!t){this.V=Math.floor(1e5*Math.random()),t=this.V++;const i=new dt(this,this.h,t,void 0);let e=this.s;if(this.P&&(e?(e=G(e),z(e,this.P)):e=this.P),null===this.o&&(i.H=e),this.ja)e:{for(var n=0,r=0;r<this.l.length;r++){var s=this.l[r];if("__data__"in s.g&&"string"==typeof(s=s.g.__data__)?s=s.length:s=void 0,void 0===s)break;if(4096<(n+=s)){n=r;break e}if(4096===n||r===this.l.length-1){n=r+1;break e}}n=1e3}else n=1e3;n=Kn(this,i,n),Bt(r=Lt(this.F),"RID",t),Bt(r,"CVER",22),this.D&&Bt(r,"X-HTTP-Session-Id",this.D),jn(this,r),this.o&&e&&Mn(r,this.o,e),un(this.i,i),this.Ra&&Bt(r,"TYPE","init"),this.ja?(Bt(r,"$req",n),Bt(r,"SID","null"),i.$=!0,vt(i,r,null)):vt(i,r,n),this.G=2}}else 3==this.G&&(t?qn(this,t):0==this.l.length||sn(this.i)||qn(this))},y.Ga=function(){var e;this.u=null,Qn(this),this.$&&!(this.L||null==this.g||this.O<=0)&&(e=2*this.O,this.h.info("BP detection timer enabled: "+e),this.B=rt(A(this.bb,this),e))},y.bb=function(){this.B&&(this.B=null,this.h.info("BP detection timeout reached."),this.h.info("Buffering proxy detected and switch to long-polling!"),this.N=!1,this.L=!0,tt(10),Fn(this),Qn(this))},y.ab=function(){null!=this.v&&(this.v=null,Fn(this),$n(this),tt(19))},y.jb=function(e){e?(this.h.info("Successfully pinged google.com"),tt(2)):(this.h.info("Failed to ping google.com"),tt(1))},(y=tr.prototype).xa=function(){},y.wa=function(){},y.va=function(){},y.ua=function(){},y.Oa=function(){},nr.prototype.g=function(e,t){return new rr(e,t)},N(rr,Ae),rr.prototype.m=function(){this.g.j=this.j,this.A&&(this.g.H=!0);var e=this.g,t=this.l,n=this.h||void 0;e.Wa&&(e.h.info("Origin Trials enabled."),Oe(A(e.hb,e,t))),tt(0),e.W=t,e.aa=n||{},e.N=e.X,e.F=Zn(e,null,e.W),Un(e)},rr.prototype.close=function(){Vn(this.g)},rr.prototype.u=function(e){var t;"string"==typeof e?((t={}).__data__=e,Bn(this.g,t)):this.v?((t={}).__data__=ke(e),Bn(this.g,t)):Bn(this.g,e)},rr.prototype.M=function(){this.g.j=null,delete this.j,Vn(this.g),delete this.g,rr.Z.M.call(this)},N(sr,ct),N(ir,ht),N(ar,tr),ar.prototype.xa=function(){Ce(this.g,"a")},ar.prototype.wa=function(e){Ce(this.g,new sr(e))},ar.prototype.va=function(e){Ce(this.g,new ir)},ar.prototype.ua=function(){Ce(this.g,"b")},nr.prototype.createWebChannel=nr.prototype.g,rr.prototype.send=rr.prototype.u,rr.prototype.open=rr.prototype.m,st.NO_ERROR=0,st.TIMEOUT=8,st.HTTP_ERROR=6,it.COMPLETE="complete",(ut.EventType=v).OPEN="a",v.CLOSE="b",v.ERROR="c",v.MESSAGE="d",Ae.prototype.listen=Ae.prototype.N,In.prototype.listenOnce=In.prototype.O,In.prototype.getLastError=In.prototype.La,In.prototype.getLastErrorCode=In.prototype.Da,In.prototype.getStatus=In.prototype.ba,In.prototype.getResponseJson=In.prototype.Qa,In.prototype.getResponseText=In.prototype.ga,In.prototype.send=In.prototype.ea;var or,ur=Xe,cr=st,hr=it,lr=We,dr=10,fr=11,gr=gn,mr=ut,pr=In;const yr="@firebase/firestore";class vr{constructor(e){this.uid=e}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}}vr.UNAUTHENTICATED=new vr(null),vr.GOOGLE_CREDENTIALS=new vr("google-credentials-uid"),vr.FIRST_PARTY=new vr("first-party-uid"),vr.MOCK_USER=new vr("mock-user");let wr="9.8.3";const br=new class{constructor(e){this.name=e,this._logLevel=d,this._logHandler=p,this._userLogHandler=null}get logLevel(){return this._logLevel}set logLevel(e){if(!(e in l))throw new TypeError(`Invalid value "${e}" assigned to \`logLevel\``);this._logLevel=e}setLogLevel(e){this._logLevel="string"==typeof e?h[e]:e}get logHandler(){return this._logHandler}set logHandler(e){if("function"!=typeof e)throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=e}get userLogHandler(){return this._userLogHandler}set userLogHandler(e){this._userLogHandler=e}debug(...e){this._userLogHandler&&this._userLogHandler(this,l.DEBUG,...e),this._logHandler(this,l.DEBUG,...e)}log(...e){this._userLogHandler&&this._userLogHandler(this,l.VERBOSE,...e),this._logHandler(this,l.VERBOSE,...e)}info(...e){this._userLogHandler&&this._userLogHandler(this,l.INFO,...e),this._logHandler(this,l.INFO,...e)}warn(...e){this._userLogHandler&&this._userLogHandler(this,l.WARN,...e),this._logHandler(this,l.WARN,...e)}error(...e){this._userLogHandler&&this._userLogHandler(this,l.ERROR,...e),this._logHandler(this,l.ERROR,...e)}}("@firebase/firestore");function Ir(){return br.logLevel}function Er(e,...t){var n;br.logLevel<=l.DEBUG&&(n=t.map(_r),br.debug(`Firestore (${wr}): ${e}`,...n))}function Tr(e,...t){var n;br.logLevel<=l.ERROR&&(n=t.map(_r),br.error(`Firestore (${wr}): ${e}`,...n))}function Sr(e,...t){var n;br.logLevel<=l.WARN&&(n=t.map(_r),br.warn(`Firestore (${wr}): ${e}`,...n))}function _r(t){if("string"==typeof t)return t;try{return JSON.stringify(t)}catch(e){return t}}function xr(e="Unexpected state"){var t=`FIRESTORE (${wr}) INTERNAL ASSERTION FAILED: `+e;throw Tr(t),new Error(t)}function Dr(e){e||xr()}const Ar={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class Cr extends o{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class Nr{constructor(){this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}}class kr{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${e}`)}}class Rr{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable(()=>t(vr.UNAUTHENTICATED))}shutdown(){}}class Mr{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable(()=>t(this.token.user))}shutdown(){this.changeListener=null}}class Lr{constructor(e){this.t=e,this.currentUser=vr.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(t,n){let r=this.i;const s=e=>this.i!==r?(r=this.i,n(e)):Promise.resolve();let i=new Nr;this.o=()=>{this.i++,this.currentUser=this.u(),i.resolve(),i=new Nr,t.enqueueRetryable(()=>s(this.currentUser))};const a=()=>{const e=i;t.enqueueRetryable(async()=>{await e.promise,await s(this.currentUser)})},o=e=>{Er("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=e,this.auth.addAuthTokenListener(this.o),a()};this.t.onInit(e=>o(e)),setTimeout(()=>{var e;this.auth||((e=this.t.getImmediate({optional:!0}))?o(e):(Er("FirebaseAuthCredentialsProvider","Auth not yet detected"),i.resolve(),i=new Nr))},0),a()}getToken(){const t=this.i,e=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(e).then(e=>this.i!==t?(Er("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):e?(Dr("string"==typeof e.accessToken),new kr(e.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){var e=this.auth&&this.auth.getUid();return Dr(null===e||"string"==typeof e),new vr(e)}}class Or{constructor(e,t,n){this.type="FirstParty",this.user=vr.FIRST_PARTY,this.headers=new Map,this.headers.set("X-Goog-AuthUser",t);var r=e.auth.getAuthHeaderValueForFirstParty([]);r&&this.headers.set("Authorization",r),n&&this.headers.set("X-Goog-Iam-Authorization-Token",n)}}class Vr{constructor(e,t,n){this.h=e,this.l=t,this.m=n}getToken(){return Promise.resolve(new Or(this.h,this.l,this.m))}start(e,t){e.enqueueRetryable(()=>t(vr.FIRST_PARTY))}shutdown(){}invalidateToken(){}}class Fr{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&0<e.length&&this.headers.set("x-firebase-appcheck",this.value)}}class Pr{constructor(e){this.g=e,this.forceRefresh=!1,this.appCheck=null,this.p=null}start(t,n){const r=e=>{null!=e.error&&Er("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${e.error.message}`);var t=e.token!==this.p;return this.p=e.token,Er("FirebaseAppCheckTokenProvider",`Received ${t?"new":"existing"} token.`),t?n(e.token):Promise.resolve()};this.o=e=>{t.enqueueRetryable(()=>r(e))};const s=e=>{Er("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=e,this.appCheck.addTokenListener(this.o)};this.g.onInit(e=>s(e)),setTimeout(()=>{var e;this.appCheck||((e=this.g.getImmediate({optional:!0}))?s(e):Er("FirebaseAppCheckTokenProvider","AppCheck not yet detected"))},0)}getToken(){var e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then(e=>e?(Dr("string"==typeof e.token),this.p=e.token,new Fr(e.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}}class Br{static I(){var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n=Math.floor(256/t.length)*t.length;let r="";for(;r.length<20;){var s=function(t){const n="undefined"!=typeof self&&(self.crypto||self.msCrypto),r=new Uint8Array(t);if(n&&"function"==typeof n.getRandomValues)n.getRandomValues(r);else for(let e=0;e<t;e++)r[e]=Math.floor(256*Math.random());return r}(40);for(let e=0;e<s.length;++e)r.length<20&&s[e]<n&&(r+=t.charAt(s[e]%t.length))}return r}}function Ur(e,t){return e<t?-1:t<e?1:0}function qr(e,n,r){return e.length===n.length&&e.every((e,t)=>r(e,n[t]))}function jr(e){return e+"\0"}class Kr{constructor(e,t){if(this.seconds=e,(this.nanoseconds=t)<0)throw new Cr(Ar.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(1e9<=t)throw new Cr(Ar.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-62135596800)throw new Cr(Ar.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e);if(253402300800<=e)throw new Cr(Ar.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}static now(){return Kr.fromMillis(Date.now())}static fromDate(e){return Kr.fromMillis(e.getTime())}static fromMillis(e){var t=Math.floor(e/1e3),n=Math.floor(1e6*(e-1e3*t));return new Kr(t,n)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?Ur(this.nanoseconds,e.nanoseconds):Ur(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){var e=this.seconds- -62135596800;return String(e).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class Gr{constructor(e){this.timestamp=e}static fromTimestamp(e){return new Gr(e)}static min(){return new Gr(new Kr(0,0))}static max(){return new Gr(new Kr(253402300799,999999999))}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}class $r{constructor(e,t,n){void 0===t?t=0:t>e.length&&xr(),void 0===n?n=e.length-t:n>e.length-t&&xr(),this.segments=e,this.offset=t,this.len=n}get length(){return this.len}isEqual(e){return 0===$r.comparator(this,e)}child(e){const t=this.segments.slice(this.offset,this.limit());return e instanceof $r?e.forEach(e=>{t.push(e)}):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return this.construct(this.segments,this.offset+(e=void 0===e?1:e),this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return 0===this.length}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(e){for(let t=this.offset,n=this.limit();t<n;t++)e(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,t){const n=Math.min(e.length,t.length);for(let r=0;r<n;r++){const n=e.get(r),s=t.get(r);if(n<s)return-1;if(n>s)return 1}return e.length<t.length?-1:e.length>t.length?1:0}}class zr extends $r{construct(e,t,n){return new zr(e,t,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}static fromString(...e){const t=[];for(const n of e){if(0<=n.indexOf("//"))throw new Cr(Ar.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);t.push(...n.split("/").filter(e=>0<e.length))}return new zr(t)}static emptyPath(){return new zr([])}}const Qr=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class Hr extends $r{construct(e,t,n){return new Hr(e,t,n)}static isValidIdentifier(e){return Qr.test(e)}canonicalString(){return this.toArray().map(e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),e=!Hr.isValidIdentifier(e)?"`"+e+"`":e)).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new Hr(["__name__"])}static fromServerFormat(e){const t=[];let n="",r=0;var s=()=>{if(0===n.length)throw new Cr(Ar.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(n),n=""};let i=!1;for(;r<e.length;){const t=e[r];if("\\"===t){if(r+1===e.length)throw new Cr(Ar.INVALID_ARGUMENT,"Path has trailing escape character: "+e);const t=e[r+1];if("\\"!==t&&"."!==t&&"`"!==t)throw new Cr(Ar.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);n+=t,r+=2}else"`"===t?i=!i:"."!==t||i?n+=t:s(),r++}if(s(),i)throw new Cr(Ar.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new Hr(t)}static emptyPath(){return new Hr([])}}class Wr{constructor(e){this.path=e}static fromPath(e){return new Wr(zr.fromString(e))}static fromName(e){return new Wr(zr.fromString(e).popFirst(5))}static empty(){return new Wr(zr.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return 2<=this.path.length&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return null!==e&&0===zr.comparator(this.path,e.path)}toString(){return this.path.toString()}static comparator(e,t){return zr.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new Wr(new zr(e.slice()))}}class Yr{constructor(e,t,n,r){this.indexId=e,this.collectionGroup=t,this.fields=n,this.indexState=r}}function Xr(e){return e.fields.find(e=>2===e.kind)}function Jr(e){return e.fields.filter(e=>2!==e.kind)}Yr.UNKNOWN_ID=-1;class Zr{constructor(e,t){this.fieldPath=e,this.kind=t}}class es{constructor(e,t){this.sequenceNumber=e,this.offset=t}static empty(){return new es(0,rs.min())}}function ts(e,t){var n=e.toTimestamp().seconds,r=e.toTimestamp().nanoseconds+1,r=Gr.fromTimestamp(1e9===r?new Kr(n+1,0):new Kr(n,r));return new rs(r,Wr.empty(),t)}function ns(e){return new rs(e.readTime,e.key,-1)}class rs{constructor(e,t,n){this.readTime=e,this.documentKey=t,this.largestBatchId=n}static min(){return new rs(Gr.min(),Wr.empty(),-1)}static max(){return new rs(Gr.max(),Wr.empty(),-1)}}function ss(e,t){let n=e.readTime.compareTo(t.readTime);return 0!==n?n:(n=Wr.comparator(e.documentKey,t.documentKey),0!==n?n:Ur(e.largestBatchId,t.largestBatchId))}const is="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class as{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(e=>e())}}async function os(e){if(e.code!==Ar.FAILED_PRECONDITION||e.message!==is)throw e;Er("LocalStore","Unexpectedly lost primary lease")}class us{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e(e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)},e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)})}catch(e){return this.next(void 0,e)}next(r,s){return this.callbackAttached&&xr(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(s,this.error):this.wrapSuccess(r,this.result):new us((t,n)=>{this.nextCallback=e=>{this.wrapSuccess(r,e).next(t,n)},this.catchCallback=e=>{this.wrapFailure(s,e).next(t,n)}})}toPromise(){return new Promise((e,t)=>{this.next(e,t)})}wrapUserFunction(e){try{var t=e();return t instanceof us?t:us.resolve(t)}catch(e){return us.reject(e)}}wrapSuccess(e,t){return e?this.wrapUserFunction(()=>e(t)):us.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction(()=>e(t)):us.reject(t)}static resolve(n){return new us((e,t)=>{e(n)})}static reject(n){return new us((e,t)=>{t(n)})}static waitFor(e){return new us((t,n)=>{let r=0,s=0,i=!1;e.forEach(e=>{++r,e.next(()=>{++s,i&&s===r&&t()},e=>n(e))}),i=!0,s===r&&t()})}static or(e){let t=us.resolve(!1);for(const n of e)t=t.next(e=>e?us.resolve(e):n());return t}static forEach(e,n){const r=[];return e.forEach((e,t)=>{r.push(n.call(this,e,t))}),this.waitFor(r)}static mapArray(o,u){return new us((t,n)=>{const r=o.length,s=new Array(r);let i=0;for(let e=0;e<r;e++){const a=e;u(o[a]).next(e=>{s[a]=e,++i,i===r&&t(s)},e=>n(e))}})}static doWhile(r,s){return new us((e,t)=>{const n=()=>{!0===r()?s().next(()=>{n()},t):e()};n()})}}class cs{constructor(n,e){this.action=n,this.transaction=e,this.aborted=!1,this.T=new Nr,this.transaction.oncomplete=()=>{this.T.resolve()},this.transaction.onabort=()=>{e.error?this.T.reject(new ds(n,e.error)):this.T.resolve()},this.transaction.onerror=e=>{var t=ys(e.target.error);this.T.reject(new ds(n,t))}}static open(e,t,n,r){try{return new cs(t,e.transaction(r,n))}catch(e){throw new ds(t,e)}}get A(){return this.T.promise}abort(e){e&&this.T.reject(e),this.aborted||(Er("SimpleDb","Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}R(){const e=this.transaction;this.aborted||"function"!=typeof e.commit||e.commit()}store(e){var t=this.transaction.objectStore(e);return new gs(t)}}class hs{constructor(e,t,n){this.name=e,this.version=t,this.P=n,12.2===hs.v(f())&&Tr("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(e){return Er("SimpleDb","Removing database:",e),ms(window.indexedDB.deleteDatabase(e)).toPromise()}static V(){if("object"!=typeof indexedDB)return!1;if(hs.S())return!0;const e=f(),t=hs.v(e),n=0<t&&t<10,r=hs.D(e),s=0<r&&r<4.5;return!(0<e.indexOf("MSIE ")||0<e.indexOf("Trident/")||0<e.indexOf("Edge/")||n||s)}static S(){var e;return"undefined"!=typeof process&&"YES"===(null===(e=process.env)||void 0===e?void 0:e.C)}static N(e,t){return e.store(t)}static v(e){const t=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=t?t[1].split("_").slice(0,2).join("."):"-1";return Number(n)}static D(e){const t=e.match(/Android ([\d.]+)/i),n=t?t[1].split(".").slice(0,2).join("."):"-1";return Number(n)}async k(i){return this.db||(Er("SimpleDb","Opening database:",this.name),this.db=await new Promise((n,r)=>{const s=indexedDB.open(this.name,this.version);s.onsuccess=e=>{var t=e.target.result;n(t)},s.onblocked=()=>{r(new ds(i,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},s.onerror=e=>{var t=e.target.error;"VersionError"===t.name?r(new Cr(Ar.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===t.name?r(new Cr(Ar.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+t)):r(new ds(i,t))},s.onupgradeneeded=e=>{Er("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',e.oldVersion);var t=e.target.result;this.P.O(t,s.transaction,e.oldVersion,this.version).next(()=>{Er("SimpleDb","Database upgrade to version "+this.version+" complete")})}})),this.M&&(this.db.onversionchange=e=>this.M(e)),this.db}F(t){this.M=t,this.db&&(this.db.onversionchange=e=>t(e))}async runTransaction(e,t,n,r){var s="readonly"===t;let i=0;for(;;){++i;try{this.db=await this.k(e);const t=cs.open(this.db,e,s?"readonly":"readwrite",n),i=r(t).next(e=>(t.R(),e)).catch(e=>(t.abort(e),us.reject(e))).toPromise();return i.catch(()=>{}),await t.A,i}catch(e){const t="FirebaseError"!==e.name&&i<3;if(Er("SimpleDb","Transaction failed with error:",e.message,"Retrying:",t),this.close(),!t)return Promise.reject(e)}}}close(){this.db&&this.db.close(),this.db=void 0}}class ls{constructor(e){this.$=e,this.B=!1,this.L=null}get isDone(){return this.B}get U(){return this.L}set cursor(e){this.$=e}done(){this.B=!0}q(e){this.L=e}delete(){return ms(this.$.delete())}}class ds extends Cr{constructor(e,t){super(Ar.UNAVAILABLE,`IndexedDB transaction '${e}' failed: ${t}`),this.name="IndexedDbTransactionError"}}function fs(e){return"IndexedDbTransactionError"===e.name}class gs{constructor(e){this.store=e}put(e,t){let n;return n=void 0!==t?(Er("SimpleDb","PUT",this.store.name,e,t),this.store.put(t,e)):(Er("SimpleDb","PUT",this.store.name,"<auto-key>",e),this.store.put(e)),ms(n)}add(e){return Er("SimpleDb","ADD",this.store.name,e,e),ms(this.store.add(e))}get(t){return ms(this.store.get(t)).next(e=>(Er("SimpleDb","GET",this.store.name,t,e=void 0===e?null:e),e))}delete(e){return Er("SimpleDb","DELETE",this.store.name,e),ms(this.store.delete(e))}count(){return Er("SimpleDb","COUNT",this.store.name),ms(this.store.count())}K(e,n){var t=this.options(e,n);if(t.index||"function"!=typeof this.store.getAll){const e=this.cursor(t),n=[];return this.G(e,(e,t)=>{n.push(t)}).next(()=>n)}{const e=this.store.getAll(t.range);return new us((t,n)=>{e.onerror=e=>{n(e.target.error)},e.onsuccess=e=>{t(e.target.result)}})}}j(e,t){const r=this.store.getAll(e,null===t?void 0:t);return new us((t,n)=>{r.onerror=e=>{n(e.target.error)},r.onsuccess=e=>{t(e.target.result)}})}W(e,t){Er("SimpleDb","DELETE ALL",this.store.name);const n=this.options(e,t);n.H=!1;var r=this.cursor(n);return this.G(r,(e,t,n)=>n.delete())}J(e,t){let n;t?n=e:(n={},t=e);var r=this.cursor(n);return this.G(r,t)}Y(s){const e=this.cursor({});return new us((n,r)=>{e.onerror=e=>{var t=ys(e.target.error);r(t)},e.onsuccess=e=>{const t=e.target.result;t?s(t.primaryKey,t.value).next(e=>{e?t.continue():n()}):n()}})}G(e,i){const a=[];return new us((s,t)=>{e.onerror=e=>{t(e.target.error)},e.onsuccess=e=>{const t=e.target.result;if(t){const n=new ls(t),r=i(t.primaryKey,t.value,n);if(r instanceof us){const e=r.catch(e=>(n.done(),us.reject(e)));a.push(e)}n.isDone?s():null===n.U?t.continue():t.continue(n.U)}else s()}}).next(()=>us.waitFor(a))}options(e,t){let n;return void 0!==e&&("string"==typeof e?n=e:t=e),{index:n,range:t}}cursor(e){let t="next";if(e.reverse&&(t="prev"),e.index){const n=this.store.index(e.index);return e.H?n.openKeyCursor(e.range,t):n.openCursor(e.range,t)}return this.store.openCursor(e.range,t)}}function ms(e){return new us((n,r)=>{e.onsuccess=e=>{var t=e.target.result;n(t)},e.onerror=e=>{var t=ys(e.target.error);r(t)}})}let ps=!1;function ys(e){const t=hs.v(f());if(12.2<=t&&t<13){const t="An internal error was encountered in the Indexed Database server";if(0<=e.message.indexOf(t)){const e=new Cr("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${t}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return ps||(ps=!0,setTimeout(()=>{throw e},0)),e}}return e}class vs{constructor(e,t){this.asyncQueue=e,this.X=t,this.task=null}start(){}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return null!==this.task}Z(e){Er("IndexBackiller",`Scheduled in ${e}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",e,async()=>{this.task=null;try{Er("IndexBackiller",`Documents written: ${await this.X.tt()}`)}catch(e){fs(e)?Er("IndexBackiller","Ignoring IndexedDB error during index backfill: ",e):await os(e)}await this.Z(1)})}}class ws{constructor(e,t){this.localStore=e,this.persistence=t}async tt(t=50){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",e=>this.et(e,t))}et(e,t){const n=new Set;let r=t,s=!0;return us.doWhile(()=>!0===s&&0<r,()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(e).next(t=>null===t||n.has(t)?void(s=!1):(Er("IndexBackiller",`Processing collection: ${t}`),this.nt(e,t,r).next(e=>{r-=e,n.add(t)})))).next(()=>t-r)}nt(r,s,e){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(r,s).next(n=>this.localStore.localDocuments.getNextDocuments(r,s,n,e).next(e=>{const t=e.changes;return this.localStore.indexManager.updateIndexEntries(r,t).next(()=>this.st(n,e)).next(e=>(Er("IndexBackiller",`Updating offset: ${e}`),this.localStore.indexManager.updateCollectionGroup(r,s,e))).next(()=>t.size)}))}st(e,t){let r=e;return t.changes.forEach((e,t)=>{var n=ns(t);0<ss(n,r)&&(r=n)}),new rs(r.readTime,r.documentKey,Math.max(t.batchId,e.largestBatchId))}}class bs{constructor(e,t){this.previousValue=e,t&&(t.sequenceNumberHandler=e=>this.it(e),this.rt=e=>t.writeSequenceNumber(e))}it(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){var e=++this.previousValue;return this.rt&&this.rt(e),e}}function Is(e){let t=0;for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t++;return t}function Es(e,t){for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])}function Ts(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}bs.ot=-1;class Ss{constructor(e,t){this.comparator=e,this.root=t||xs.EMPTY}insert(e,t){return new Ss(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,xs.BLACK,null,null))}remove(e){return new Ss(this.comparator,this.root.remove(e,this.comparator).copy(null,null,xs.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){var n=this.comparator(e,t.key);if(0===n)return t.value;n<0?t=t.left:0<n&&(t=t.right)}return null}indexOf(e){let t=0,n=this.root;for(;!n.isEmpty();){var r=this.comparator(e,n.key);if(0===r)return t+n.left.size;n=r<0?n.left:(t+=n.left.size+1,n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(n){this.inorderTraversal((e,t)=>(n(e,t),!1))}toString(){const n=[];return this.inorderTraversal((e,t)=>(n.push(`${e}:${t}`),!1)),`{${n.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new _s(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new _s(this.root,e,this.comparator,!1)}getReverseIterator(){return new _s(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new _s(this.root,e,this.comparator,!0)}}class _s{constructor(e,t,n,r){this.isReverse=r,this.nodeStack=[];let s=1;for(;!e.isEmpty();)if(s=t?n(e.key,t):1,t&&r&&(s*=-1),s<0)e=this.isReverse?e.left:e.right;else{if(0===s){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop();var t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return 0<this.nodeStack.length}peek(){if(0===this.nodeStack.length)return null;var e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}}class xs{constructor(e,t,n,r,s){this.key=e,this.value=t,this.color=null!=n?n:xs.RED,this.left=null!=r?r:xs.EMPTY,this.right=null!=s?s:xs.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,n,r,s){return new xs(null!=e?e:this.key,null!=t?t:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=s?s:this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,n){let r=this;var s=n(e,r.key);return r=s<0?r.copy(null,null,null,r.left.insert(e,t,n),null):0===s?r.copy(null,t,null,null,null):r.copy(null,null,null,null,r.right.insert(e,t,n)),r.fixUp()}removeMin(){if(this.left.isEmpty())return xs.EMPTY;let e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),e=e.copy(null,null,null,e.left.removeMin(),null),e.fixUp()}remove(e,t){let n,r=this;if(t(e,r.key)<0)r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()||(r=r.moveRedLeft()),r=r.copy(null,null,null,r.left.remove(e,t),null);else{if(r.left.isRed()&&(r=r.rotateRight()),r.right.isEmpty()||r.right.isRed()||r.right.left.isRed()||(r=r.moveRedRight()),0===t(e,r.key)){if(r.right.isEmpty())return xs.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(e,t))}return r.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}moveRedLeft(){let e=this.colorFlip();return e.right.left.isRed()&&(e=e.copy(null,null,null,null,e.right.rotateRight()),e=e.rotateLeft(),e=e.colorFlip()),e}moveRedRight(){let e=this.colorFlip();return e.left.left.isRed()&&(e=e.rotateRight(),e=e.colorFlip()),e}rotateLeft(){var e=this.copy(null,null,xs.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){var e=this.copy(null,null,xs.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){var e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){var e=this.check();return Math.pow(2,e)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw xr();if(this.right.isRed())throw xr();var e=this.left.check();if(e!==this.right.check())throw xr();return e+(this.isRed()?0:1)}}xs.EMPTY=null,xs.RED=!0,xs.BLACK=!1,xs.EMPTY=new class{constructor(){this.size=0}get key(){throw xr()}get value(){throw xr()}get color(){throw xr()}get left(){throw xr()}get right(){throw xr()}copy(e,t,n,r,s){return this}insert(e,t,n){return new xs(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class Ds{constructor(e){this.comparator=e,this.data=new Ss(this.comparator)}has(e){return null!==this.data.get(e)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(n){this.data.inorderTraversal((e,t)=>(n(e),!1))}forEachInRange(e,t){const n=this.data.getIteratorFrom(e[0]);for(;n.hasNext();){var r=n.getNext();if(0<=this.comparator(r.key,e[1]))return;t(r.key)}}forEachWhile(e,t){let n;for(n=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();n.hasNext();)if(!e(n.getNext().key))return}firstAfterOrEqual(e){const t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new As(this.data.getIterator())}getIteratorFrom(e){return new As(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach(e=>{t=t.add(e)}),t}isEqual(e){if(!(e instanceof Ds))return!1;if(this.size!==e.size)return!1;const t=this.data.getIterator(),n=e.data.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(0!==this.comparator(e,r))return!1}return!0}toArray(){const t=[];return this.forEach(e=>{t.push(e)}),t}toString(){const t=[];return this.forEach(e=>t.push(e)),"SortedSet("+t.toString()+")"}copy(e){const t=new Ds(this.comparator);return t.data=e,t}}class As{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function Cs(e){return e.hasNext()?e.getNext():void 0}class Ns{constructor(e){(this.fields=e).sort(Hr.comparator)}static empty(){return new Ns([])}unionWith(e){let t=new Ds(Hr.comparator);for(const e of this.fields)t=t.add(e);for(const n of e)t=t.add(n);return new Ns(t.toArray())}covers(e){for(const t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return qr(this.fields,e.fields,(e,t)=>e.isEqual(t))}}class ks{constructor(e){this.binaryString=e}static fromBase64String(e){var t=atob(e);return new ks(t)}static fromUint8Array(e){var t=function(e){let t="";for(let n=0;n<e.length;++n)t+=String.fromCharCode(e[n]);return t}(e);return new ks(t)}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return e=this.binaryString,btoa(e);var e}toUint8Array(){return function(e){const t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return Ur(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}}ks.EMPTY_BYTE_STRING=new ks("");const Rs=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function Ms(t){if(Dr(!!t),"string"!=typeof t)return{seconds:Ls(t.seconds),nanos:Ls(t.nanos)};{let e=0;var n=Rs.exec(t);Dr(!!n),n[1]&&(n=((n=n[1])+"000000000").substr(0,9),e=Number(n));const r=new Date(t);return{seconds:Math.floor(r.getTime()/1e3),nanos:e}}}function Ls(e){return"number"==typeof e?e:"string"==typeof e?Number(e):0}function Os(e){return"string"==typeof e?ks.fromBase64String(e):ks.fromUint8Array(e)}function Vs(e){var t;return"server_timestamp"===(null===(t=((null===(t=null==e?void 0:e.mapValue)||void 0===t?void 0:t.fields)||{}).__type__)||void 0===t?void 0:t.stringValue)}function Fs(e){var t=Ms(e.mapValue.fields.__local_write_time__.timestampValue);return new Kr(t.seconds,t.nanos)}class Ps{constructor(e,t,n,r,s,i,a,o){this.databaseId=e,this.appId=t,this.persistenceKey=n,this.host=r,this.ssl=s,this.forceLongPolling=i,this.autoDetectLongPolling=a,this.useFetchStreams=o}}class Bs{constructor(e,t){this.projectId=e,this.database=t||"(default)"}static empty(){return new Bs("","")}get isDefaultDatabase(){return"(default)"===this.database}isEqual(e){return e instanceof Bs&&e.projectId===this.projectId&&e.database===this.database}}function Us(e){return null==e}function qs(e){return 0===e&&1/e==-1/0}function js(e){return"number"==typeof e&&Number.isInteger(e)&&!qs(e)&&e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER}const Ks={mapValue:{fields:{__type__:{stringValue:"__max__"}}}},Gs={nullValue:"NULL_VALUE"};function $s(e){return"nullValue"in e?0:"booleanValue"in e?1:"integerValue"in e||"doubleValue"in e?2:"timestampValue"in e?3:"stringValue"in e?5:"bytesValue"in e?6:"referenceValue"in e?7:"geoPointValue"in e?8:"arrayValue"in e?9:"mapValue"in e?Vs(e)?4:si(e)?9007199254740991:10:xr()}function zs(r,s){if(r===s)return!0;var e,t,n=$s(r);if(n!==$s(s))return!1;switch(n){case 0:case 9007199254740991:return!0;case 1:return r.booleanValue===s.booleanValue;case 4:return Fs(r).isEqual(Fs(s));case 3:return function(e){if("string"==typeof r.timestampValue&&"string"==typeof e.timestampValue&&r.timestampValue.length===e.timestampValue.length)return r.timestampValue===e.timestampValue;var t=Ms(r.timestampValue),n=Ms(e.timestampValue);return t.seconds===n.seconds&&t.nanos===n.nanos}(s);case 5:return r.stringValue===s.stringValue;case 6:return t=s,Os(r.bytesValue).isEqual(Os(t.bytesValue));case 7:return r.referenceValue===s.referenceValue;case 8:return e=s,Ls((t=r).geoPointValue.latitude)===Ls(e.geoPointValue.latitude)&&Ls(t.geoPointValue.longitude)===Ls(e.geoPointValue.longitude);case 2:return function(e,t){if("integerValue"in e&&"integerValue"in t)return Ls(e.integerValue)===Ls(t.integerValue);if("doubleValue"in e&&"doubleValue"in t){var n=Ls(e.doubleValue),r=Ls(t.doubleValue);return n===r?qs(n)===qs(r):isNaN(n)&&isNaN(r)}return!1}(r,s);case 9:return qr(r.arrayValue.values||[],s.arrayValue.values||[],zs);case 10:return function(e){const t=e.mapValue.fields||{},n=s.mapValue.fields||{};if(Is(t)!==Is(n))return!1;for(const e in t)if(t.hasOwnProperty(e)&&(void 0===n[e]||!zs(t[e],n[e])))return!1;return!0}(r);default:return xr()}}function Qs(e,t){return void 0!==(e.values||[]).find(e=>zs(e,t))}function Hs(e,t){if(e===t)return 0;var n,r,s,i,a=$s(e),o=$s(t);if(a!==o)return Ur(a,o);switch(a){case 0:case 9007199254740991:return 0;case 1:return Ur(e.booleanValue,t.booleanValue);case 2:return r=t,s=Ls(e.integerValue||e.doubleValue),i=Ls(r.integerValue||r.doubleValue),s<i?-1:i<s?1:s===i?0:isNaN(s)?isNaN(i)?0:-1:1;case 3:return Ws(e.timestampValue,t.timestampValue);case 4:return Ws(Fs(e),Fs(t));case 5:return Ur(e.stringValue,t.stringValue);case 6:return function(e,t){const n=Os(e),r=Os(t);return n.compareTo(r)}(e.bytesValue,t.bytesValue);case 7:return function(e,t){var n=e.split("/"),r=t.split("/");for(let s=0;s<n.length&&s<r.length;s++){const t=Ur(n[s],r[s]);if(0!==t)return t}return Ur(n.length,r.length)}(e.referenceValue,t.referenceValue);case 8:return n=e.geoPointValue,r=t.geoPointValue,0!==(i=Ur(Ls(n.latitude),Ls(r.latitude)))?i:Ur(Ls(n.longitude),Ls(r.longitude));case 9:return function(e,t){var n=e.values||[],r=t.values||[];for(let s=0;s<n.length&&s<r.length;++s){const t=Hs(n[s],r[s]);if(t)return t}return Ur(n.length,r.length)}(e.arrayValue,t.arrayValue);case 10:return function(e,t){if(e===Ks.mapValue&&t===Ks.mapValue)return 0;if(e===Ks.mapValue)return 1;if(t===Ks.mapValue)return-1;const n=e.fields||{},r=Object.keys(n),s=t.fields||{},i=Object.keys(s);r.sort(),i.sort();for(let o=0;o<r.length&&o<i.length;++o){const t=Ur(r[o],i[o]);if(0!==t)return t;var a=Hs(n[r[o]],s[i[o]]);if(0!==a)return a}return Ur(r.length,i.length)}(e.mapValue,t.mapValue);default:throw xr()}}function Ws(e,t){if("string"==typeof e&&"string"==typeof t&&e.length===t.length)return Ur(e,t);var n=Ms(e),r=Ms(t),s=Ur(n.seconds,r.seconds);return 0!==s?s:Ur(n.nanos,r.nanos)}function Ys(e){return function i(e){return"nullValue"in e?"null":"booleanValue"in e?""+e.booleanValue:"integerValue"in e?""+e.integerValue:"doubleValue"in e?""+e.doubleValue:"timestampValue"in e?function(e){const t=Ms(e);return`time(${t.seconds},${t.nanos})`}(e.timestampValue):"stringValue"in e?e.stringValue:"bytesValue"in e?Os(e.bytesValue).toBase64():"referenceValue"in e?(t=e.referenceValue,Wr.fromName(t).toString()):"geoPointValue"in e?`geo(${(t=e.geoPointValue).latitude},${t.longitude})`:"arrayValue"in e?function(e){let t="[",n=!0;for(const r of e.values||[])n?n=!1:t+=",",t+=i(r);return t+"]"}(e.arrayValue):"mapValue"in e?function(e){const t=Object.keys(e.fields||{}).sort();let n="{",r=!0;for(const s of t)r?r=!1:n+=",",n+=`${s}:${i(e.fields[s])}`;return n+"}"}(e.mapValue):xr();var t}(e)}function Xs(e,t){return{referenceValue:`projects/${e.projectId}/databases/${e.database}/documents/${t.path.canonicalString()}`}}function Js(e){return e&&"integerValue"in e}function Zs(e){return!!e&&"arrayValue"in e}function ei(e){return e&&"nullValue"in e}function ti(e){return e&&"doubleValue"in e&&isNaN(Number(e.doubleValue))}function ni(e){return e&&"mapValue"in e}function ri(t){if(t.geoPointValue)return{geoPointValue:Object.assign({},t.geoPointValue)};if(t.timestampValue&&"object"==typeof t.timestampValue)return{timestampValue:Object.assign({},t.timestampValue)};if(t.mapValue){const n={mapValue:{fields:{}}};return Es(t.mapValue.fields,(e,t)=>n.mapValue.fields[e]=ri(t)),n}if(t.arrayValue){const r={arrayValue:{values:[]}};for(let e=0;e<(t.arrayValue.values||[]).length;++e)r.arrayValue.values[e]=ri(t.arrayValue.values[e]);return r}return Object.assign({},t)}function si(e){return"__max__"===(((e.mapValue||{}).fields||{}).__type__||{}).stringValue}function ii(e,t){var n=Hs(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?-1:!e.inclusive&&t.inclusive?1:0}function ai(e,t){var n=Hs(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?1:!e.inclusive&&t.inclusive?-1:0}class oi{constructor(e){this.value=e}static empty(){return new oi({mapValue:{}})}field(n){if(n.isEmpty())return this.value;{let e=this.value;for(let t=0;t<n.length-1;++t)if(e=(e.mapValue.fields||{})[n.get(t)],!ni(e))return null;return e=(e.mapValue.fields||{})[n.lastSegment()],e||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=ri(t)}setAll(e){let n=Hr.emptyPath(),r={},s=[];e.forEach((e,t)=>{if(!n.isImmediateParentOf(t)){const e=this.getFieldsMap(n);this.applyChanges(e,r,s),r={},s=[],n=t.popLast()}e?r[t.lastSegment()]=ri(e):s.push(t.lastSegment())});var t=this.getFieldsMap(n);this.applyChanges(t,r,s)}delete(e){const t=this.field(e.popLast());ni(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return zs(this.value,e.value)}getFieldsMap(t){let n=this.value;n.mapValue.fields||(n.mapValue={fields:{}});for(let r=0;r<t.length;++r){let e=n.mapValue.fields[t.get(r)];ni(e)&&e.mapValue.fields||(e={mapValue:{fields:{}}},n.mapValue.fields[t.get(r)]=e),n=e}return n.mapValue.fields}applyChanges(n,e,t){Es(e,(e,t)=>n[e]=t);for(const e of t)delete n[e]}clone(){return new oi(ri(this.value))}}class ui{constructor(e,t,n,r,s,i){this.key=e,this.documentType=t,this.version=n,this.readTime=r,this.data=s,this.documentState=i}static newInvalidDocument(e){return new ui(e,0,Gr.min(),Gr.min(),oi.empty(),0)}static newFoundDocument(e,t,n){return new ui(e,1,t,Gr.min(),n,0)}static newNoDocument(e,t){return new ui(e,2,t,Gr.min(),oi.empty(),0)}static newUnknownDocument(e,t){return new ui(e,3,t,Gr.min(),oi.empty(),2)}convertToFoundDocument(e,t){return this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=oi.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=oi.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=Gr.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(e){return e instanceof ui&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new ui(this.key,this.documentType,this.version,this.readTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class ci{constructor(e,t=null,n=[],r=[],s=null,i=null,a=null){this.path=e,this.collectionGroup=t,this.orderBy=n,this.filters=r,this.limit=s,this.startAt=i,this.endAt=a,this.ut=null}}function hi(e,t=null,n=[],r=[],s=null,i=null,a=null){return new ci(e,t,n,r,s,i,a)}function li(e){const t=e;if(null===t.ut){let e=t.path.canonicalString();null!==t.collectionGroup&&(e+="|cg:"+t.collectionGroup),e+="|f:",e+=t.filters.map(e=>{return(t=e).field.canonicalString()+t.op.toString()+Ys(t.value);var t}).join(","),e+="|ob:",e+=t.orderBy.map(e=>function(e){return e.field.canonicalString()+e.dir}(e)).join(","),Us(t.limit)||(e+="|l:",e+=t.limit),t.startAt&&(e+="|lb:",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map(e=>Ys(e)).join(",")),t.endAt&&(e+="|ub:",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map(e=>Ys(e)).join(",")),t.ut=e}return t.ut}function di(e,t){if(e.limit!==t.limit)return!1;if(e.orderBy.length!==t.orderBy.length)return!1;for(let a=0;a<e.orderBy.length;a++)if(n=e.orderBy[a],r=t.orderBy[a],n.dir!==r.dir||!n.field.isEqual(r.field))return!1;var n,r,s,i;if(e.filters.length!==t.filters.length)return!1;for(let o=0;o<e.filters.length;o++)if(s=e.filters[o],i=t.filters[o],s.op!==i.op||!s.field.isEqual(i.field)||!zs(s.value,i.value))return!1;return e.collectionGroup===t.collectionGroup&&!!e.path.isEqual(t.path)&&!!Ci(e.startAt,t.startAt)&&Ci(e.endAt,t.endAt)}function fi(e){return Wr.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}function gi(e,t){return e.filters.filter(e=>e instanceof yi&&e.field.isEqual(t))}function mi(t,n,r){let s=Gs,i=!0;for(const r of gi(t,n)){let e=Gs,t=!0;switch(r.op){case"<":case"<=":e="nullValue"in(a=r.value)?Gs:"booleanValue"in a?{booleanValue:!1}:"integerValue"in a||"doubleValue"in a?{doubleValue:NaN}:"timestampValue"in a?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in a?{stringValue:""}:"bytesValue"in a?{bytesValue:""}:"referenceValue"in a?Xs(Bs.empty(),Wr.empty()):"geoPointValue"in a?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in a?{arrayValue:{}}:"mapValue"in a?{mapValue:{}}:xr();break;case"==":case"in":case">=":e=r.value;break;case">":e=r.value,t=!1;break;case"!=":case"not-in":e=Gs}ii({value:s,inclusive:i},{value:e,inclusive:t})<0&&(s=e,i=t)}var a;if(null!==r)for(let e=0;e<t.orderBy.length;++e)if(t.orderBy[e].field.isEqual(n)){const t=r.position[e];ii({value:s,inclusive:i},{value:t,inclusive:r.inclusive})<0&&(s=t,i=r.inclusive);break}return{value:s,inclusive:i}}function pi(t,n,r){let s=Ks,i=!0;for(const r of gi(t,n)){let e=Ks,t=!0;switch(r.op){case">=":case">":e="nullValue"in(a=r.value)?{booleanValue:!1}:"booleanValue"in a?{doubleValue:NaN}:"integerValue"in a||"doubleValue"in a?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in a?{stringValue:""}:"stringValue"in a?{bytesValue:""}:"bytesValue"in a?Xs(Bs.empty(),Wr.empty()):"referenceValue"in a?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in a?{arrayValue:{}}:"arrayValue"in a?{mapValue:{}}:"mapValue"in a?Ks:xr(),t=!1;break;case"==":case"in":case"<=":e=r.value;break;case"<":e=r.value,t=!1;break;case"!=":case"not-in":e=Ks}0<ai({value:s,inclusive:i},{value:e,inclusive:t})&&(s=e,i=t)}var a;if(null!==r)for(let e=0;e<t.orderBy.length;++e)if(t.orderBy[e].field.isEqual(n)){const t=r.position[e];0<ai({value:s,inclusive:i},{value:t,inclusive:r.inclusive})&&(s=t,i=r.inclusive);break}return{value:s,inclusive:i}}class yi extends class{}{constructor(e,t,n){super(),this.field=e,this.op=t,this.value=n}static create(e,t,n){return e.isKeyField()?"in"===t||"not-in"===t?this.ct(e,t,n):new vi(e,t,n):"array-contains"===t?new Ei(e,n):"in"===t?new Ti(e,n):"not-in"===t?new Si(e,n):"array-contains-any"===t?new _i(e,n):new yi(e,t,n)}static ct(e,t,n){return new("in"===t?wi:bi)(e,n)}matches(e){var t=e.data.field(this.field);return"!="===this.op?null!==t&&this.at(Hs(t,this.value)):null!==t&&$s(this.value)===$s(t)&&this.at(Hs(t,this.value))}at(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return 0===e;case"!=":return 0!==e;case">":return 0<e;case">=":return 0<=e;default:return xr()}}ht(){return 0<=["<","<=",">",">=","!=","not-in"].indexOf(this.op)}}class vi extends yi{constructor(e,t,n){super(e,t,n),this.key=Wr.fromName(n.referenceValue)}matches(e){var t=Wr.comparator(e.key,this.key);return this.at(t)}}class wi extends yi{constructor(e,t){super(e,"in",t),this.keys=Ii(0,t)}matches(t){return this.keys.some(e=>e.isEqual(t.key))}}class bi extends yi{constructor(e,t){super(e,"not-in",t),this.keys=Ii(0,t)}matches(t){return!this.keys.some(e=>e.isEqual(t.key))}}function Ii(e,t){var n;return((null===(n=t.arrayValue)||void 0===n?void 0:n.values)||[]).map(e=>Wr.fromName(e.referenceValue))}class Ei extends yi{constructor(e,t){super(e,"array-contains",t)}matches(e){var t=e.data.field(this.field);return Zs(t)&&Qs(t.arrayValue,this.value)}}class Ti extends yi{constructor(e,t){super(e,"in",t)}matches(e){var t=e.data.field(this.field);return null!==t&&Qs(this.value.arrayValue,t)}}class Si extends yi{constructor(e,t){super(e,"not-in",t)}matches(e){if(Qs(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;var t=e.data.field(this.field);return null!==t&&!Qs(this.value.arrayValue,t)}}class _i extends yi{constructor(e,t){super(e,"array-contains-any",t)}matches(e){const t=e.data.field(this.field);return!(!Zs(t)||!t.arrayValue.values)&&t.arrayValue.values.some(e=>Qs(this.value.arrayValue,e))}}class xi{constructor(e,t){this.position=e,this.inclusive=t}}class Di{constructor(e,t="asc"){this.field=e,this.dir=t}}function Ai(e,t,n){let r=0;for(let s=0;s<e.position.length;s++){const i=t[s],a=e.position[s];if(r=i.field.isKeyField()?Wr.comparator(Wr.fromName(a.referenceValue),n.key):Hs(a,n.data.field(i.field)),"desc"===i.dir&&(r*=-1),0!==r)break}return r}function Ci(e,t){if(null===e)return null===t;if(null===t)return!1;if(e.inclusive!==t.inclusive||e.position.length!==t.position.length)return!1;for(let n=0;n<e.position.length;n++)if(!zs(e.position[n],t.position[n]))return!1;return!0}class Ni{constructor(e,t=null,n=[],r=[],s=null,i="F",a=null,o=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=n,this.filters=r,this.limit=s,this.limitType=i,this.startAt=a,this.endAt=o,this.lt=null,this.ft=null,this.startAt,this.endAt}}function ki(e,t,n,r,s,i,a,o){return new Ni(e,t,n,r,s,i,a,o)}function Ri(e){return new Ni(e)}function Mi(e){return 0<e.explicitOrderBy.length?e.explicitOrderBy[0].field:null}function Li(e){for(const t of e.filters)if(t.ht())return t.field;return null}function Oi(e){return null!==e.collectionGroup}function Vi(t){const n=t;if(null===n.lt){n.lt=[];const t=Li(n),e=Mi(n);if(null!==t&&null===e)t.isKeyField()||n.lt.push(new Di(t)),n.lt.push(new Di(Hr.keyField(),"asc"));else{let e=!1;for(const r of n.explicitOrderBy)n.lt.push(r),r.field.isKeyField()&&(e=!0);if(!e){const t=0<n.explicitOrderBy.length?n.explicitOrderBy[n.explicitOrderBy.length-1].dir:"asc";n.lt.push(new Di(Hr.keyField(),t))}}}return n.lt}function Fi(e){const t=e;if(!t.ft)if("F"===t.limitType)t.ft=hi(t.path,t.collectionGroup,Vi(t),t.filters,t.limit,t.startAt,t.endAt);else{const e=[];for(const s of Vi(t)){const t="desc"===s.dir?"asc":"desc";e.push(new Di(s.field,t))}var n=t.endAt?new xi(t.endAt.position,t.endAt.inclusive):null,r=t.startAt?new xi(t.startAt.position,t.startAt.inclusive):null;t.ft=hi(t.path,t.collectionGroup,e,t.filters,t.limit,n,r)}return t.ft}function Pi(e,t,n){return new Ni(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),t,n,e.startAt,e.endAt)}function Bi(e,t){return di(Fi(e),Fi(t))&&e.limitType===t.limitType}function Ui(e){return`${li(Fi(e))}|lt:${e.limitType}`}function qi(e){return`Query(target=${function(e){let t=e.path.canonicalString();return null!==e.collectionGroup&&(t+=" collectionGroup="+e.collectionGroup),0<e.filters.length&&(t+=`, filters: [${e.filters.map(e=>{return`${(t=e).field.canonicalString()} ${t.op} ${Ys(t.value)}`;var t}).join(", ")}]`),Us(e.limit)||(t+=", limit: "+e.limit),0<e.orderBy.length&&(t+=`, orderBy: [${e.orderBy.map(e=>function(e){return`${e.field.canonicalString()} (${e.dir})`}(e)).join(", ")}]`),e.startAt&&(t+=", startAt: ",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map(e=>Ys(e)).join(",")),e.endAt&&(t+=", endAt: ",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map(e=>Ys(e)).join(",")),`Target(${t})`}(Fi(e))}; limitType=${e.limitType})`}function ji(n,e){return e.isFoundDocument()&&(s=n,a=(i=e).key.path,null!==s.collectionGroup?i.key.hasCollectionId(s.collectionGroup)&&s.path.isPrefixOf(a):Wr.isDocumentKey(s.path)?s.path.isEqual(a):s.path.isImmediateParentOf(a))&&function(e){for(const t of n.explicitOrderBy)if(!t.field.isKeyField()&&null===e.data.field(t.field))return;return 1}(e)&&function(e){for(const t of n.filters)if(!t.matches(e))return;return 1}(e)&&(s=e,(!(e=n).startAt||(t=e.startAt,r=Ai(t,Vi(e),s),t.inclusive?r<=0:r<0))&&(!e.endAt||(t=e.endAt,r=Ai(t,Vi(e),s),t.inclusive?0<=r:0<r)));var t,r,s,i,a}function Ki(e){return e.collectionGroup||(e.path.length%2==1?e.path.lastSegment():e.path.get(e.path.length-2))}function Gi(s){return(e,t)=>{let n=!1;for(const r of Vi(s)){const s=function(e,s,t){var n=e.field.isKeyField()?Wr.comparator(s.key,t.key):function(e,t){var n=s.data.field(e),r=t.data.field(e);return null!==n&&null!==r?Hs(n,r):xr()}(e.field,t);switch(e.dir){case"asc":return n;case"desc":return-1*n;default:return xr()}}(r,e,t);if(0!==s)return s;n=n||r.field.isKeyField()}return 0}}function $i(e,t){if(e.dt){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:qs(t)?"-0":t}}function zi(e){return{integerValue:""+e}}function Qi(e,t){return js(t)?zi(t):$i(e,t)}class Hi{constructor(){this._=void 0}}function Wi(e,t){return e instanceof ta?Js(n=t)||n&&"doubleValue"in n?t:{integerValue:0}:null;var n}class Yi extends Hi{}class Xi extends Hi{constructor(e){super(),this.elements=e}}function Ji(e,t){const n=ra(t);for(const t of e.elements)n.some(e=>zs(e,t))||n.push(t);return{arrayValue:{values:n}}}class Zi extends Hi{constructor(e){super(),this.elements=e}}function ea(e,t){let n=ra(t);for(const t of e.elements)n=n.filter(e=>!zs(e,t));return{arrayValue:{values:n}}}class ta extends Hi{constructor(e,t){super(),this.wt=e,this._t=t}}function na(e){return Ls(e.integerValue||e.doubleValue)}function ra(e){return Zs(e)&&e.arrayValue.values?e.arrayValue.values.slice():[]}class sa{constructor(e,t){this.field=e,this.transform=t}}class ia{constructor(e,t){this.version=e,this.transformResults=t}}class aa{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new aa}static exists(e){return new aa(void 0,e)}static updateTime(e){return new aa(e)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}function oa(e,t){return void 0!==e.updateTime?t.isFoundDocument()&&t.version.isEqual(e.updateTime):void 0===e.exists||e.exists===t.isFoundDocument()}class ua{}function ca(e,n){if(!e.hasLocalMutations||n&&0===n.fields.length)return null;if(null===n)return e.isNoDocument()?new va(e.key,aa.none()):new fa(e.key,e.data,aa.none());{const s=e.data,i=oi.empty();let t=new Ds(Hr.comparator);for(var r of n.fields)if(!t.has(r)){let e=s.field(r);null===e&&1<r.length&&(r=r.popLast(),e=s.field(r)),null===e?i.delete(r):i.set(r,e),t=t.add(r)}return new ga(e.key,i,new Ns(t.toArray()),aa.none())}}function ha(e,t,n){e instanceof fa?function(e,t,n){const r=e.value.clone(),s=pa(e.fieldTransforms,t,n.transformResults);r.setAll(s),t.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(e,t,n):e instanceof ga?function(e,t,n){if(!oa(e.precondition,t))return t.convertToUnknownDocument(n.version);const r=pa(e.fieldTransforms,t,n.transformResults),s=t.data;s.setAll(ma(e)),s.setAll(r),t.convertToFoundDocument(n.version,s).setHasCommittedMutations()}(e,t,n):t.convertToNoDocument(n.version).setHasCommittedMutations()}function la(e,t,n,r){return e instanceof fa?function(e,t,n,r){if(!oa(e.precondition,t))return n;const s=e.value.clone(),i=ya(e.fieldTransforms,r,t);return s.setAll(i),t.convertToFoundDocument(t.version,s).setHasLocalMutations(),null}(e,t,n,r):e instanceof ga?function(e,t,n,r){if(!oa(e.precondition,t))return n;const s=ya(e.fieldTransforms,r,t),i=t.data;return i.setAll(ma(e)),i.setAll(s),t.convertToFoundDocument(t.version,i).setHasLocalMutations(),null===n?null:n.unionWith(e.fieldMask.fields).unionWith(e.fieldTransforms.map(e=>e.field))}(e,t,n,r):(t=t,n=n,oa(e.precondition,t)?(t.convertToNoDocument(t.version).setHasLocalMutations(),null):n)}function da(e,t){return e.type===t.type&&!!e.key.isEqual(t.key)&&!!e.precondition.isEqual(t.precondition)&&(n=e.fieldTransforms,r=t.fieldTransforms,!!(void 0===n&&void 0===r||n&&r&&qr(n,r,(e,t)=>function(e,t){return e.field.isEqual(t.field)&&(e=e.transform,t=t.transform,e instanceof Xi&&t instanceof Xi||e instanceof Zi&&t instanceof Zi?qr(e.elements,t.elements,zs):e instanceof ta&&t instanceof ta?zs(e._t,t._t):e instanceof Yi&&t instanceof Yi)}(e,t)))&&(0===e.type?e.value.isEqual(t.value):1!==e.type||e.data.isEqual(t.data)&&e.fieldMask.isEqual(t.fieldMask)));var n,r}class fa extends ua{constructor(e,t,n,r=[]){super(),this.key=e,this.value=t,this.precondition=n,this.fieldTransforms=r,this.type=0}getFieldMask(){return null}}class ga extends ua{constructor(e,t,n,r,s=[]){super(),this.key=e,this.data=t,this.fieldMask=n,this.precondition=r,this.fieldTransforms=s,this.type=1}getFieldMask(){return this.fieldMask}}function ma(n){const r=new Map;return n.fieldMask.fields.forEach(e=>{var t;e.isEmpty()||(t=n.data.field(e),r.set(e,t))}),r}function pa(e,t,n){const r=new Map;Dr(e.length===n.length);for(let h=0;h<n.length;h++){var s=e[h],i=s.transform,a=t.data.field(s.field);r.set(s.field,(o=i,u=a,c=n[h],o instanceof Xi?Ji(o,u):o instanceof Zi?ea(o,u):c))}var o,u,c;return r}function ya(e,t,n){const r=new Map;for(const c of e){const e=c.transform,h=n.data.field(c.field);r.set(c.field,(s=e,i=h,a=t,u=o=void 0,s instanceof Yi?function(){const e={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:a.seconds,nanos:a.nanoseconds}}}};return i&&(e.fields.__previous_value__=i),{mapValue:e}}():s instanceof Xi?Ji(s,i):s instanceof Zi?ea(s,i):(o=Wi(s=s,i),u=na(o)+na(s._t),Js(o)&&Js(s._t)?zi(u):$i(s.wt,u))))}var s,i,a,o,u;return r}class va extends ua{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class wa extends ua{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class ba{constructor(e){this.count=e}}function Ia(e){switch(e){default:return xr(),0;case Ar.CANCELLED:case Ar.UNKNOWN:case Ar.DEADLINE_EXCEEDED:case Ar.RESOURCE_EXHAUSTED:case Ar.INTERNAL:case Ar.UNAVAILABLE:case Ar.UNAUTHENTICATED:return;case Ar.INVALID_ARGUMENT:case Ar.NOT_FOUND:case Ar.ALREADY_EXISTS:case Ar.PERMISSION_DENIED:case Ar.FAILED_PRECONDITION:case Ar.ABORTED:case Ar.OUT_OF_RANGE:case Ar.UNIMPLEMENTED:case Ar.DATA_LOSS:return 1}}function Ea(e){if(void 0===e)return Tr("GRPC error has no .code"),Ar.UNKNOWN;switch(e){case or.OK:return Ar.OK;case or.CANCELLED:return Ar.CANCELLED;case or.UNKNOWN:return Ar.UNKNOWN;case or.DEADLINE_EXCEEDED:return Ar.DEADLINE_EXCEEDED;case or.RESOURCE_EXHAUSTED:return Ar.RESOURCE_EXHAUSTED;case or.INTERNAL:return Ar.INTERNAL;case or.UNAVAILABLE:return Ar.UNAVAILABLE;case or.UNAUTHENTICATED:return Ar.UNAUTHENTICATED;case or.INVALID_ARGUMENT:return Ar.INVALID_ARGUMENT;case or.NOT_FOUND:return Ar.NOT_FOUND;case or.ALREADY_EXISTS:return Ar.ALREADY_EXISTS;case or.PERMISSION_DENIED:return Ar.PERMISSION_DENIED;case or.FAILED_PRECONDITION:return Ar.FAILED_PRECONDITION;case or.ABORTED:return Ar.ABORTED;case or.OUT_OF_RANGE:return Ar.OUT_OF_RANGE;case or.UNIMPLEMENTED:return Ar.UNIMPLEMENTED;case or.DATA_LOSS:return Ar.DATA_LOSS;default:return xr()}}(it=or=or||{})[it.OK=0]="OK",it[it.CANCELLED=1]="CANCELLED",it[it.UNKNOWN=2]="UNKNOWN",it[it.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",it[it.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",it[it.NOT_FOUND=5]="NOT_FOUND",it[it.ALREADY_EXISTS=6]="ALREADY_EXISTS",it[it.PERMISSION_DENIED=7]="PERMISSION_DENIED",it[it.UNAUTHENTICATED=16]="UNAUTHENTICATED",it[it.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",it[it.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",it[it.ABORTED=10]="ABORTED",it[it.OUT_OF_RANGE=11]="OUT_OF_RANGE",it[it.UNIMPLEMENTED=12]="UNIMPLEMENTED",it[it.INTERNAL=13]="INTERNAL",it[it.UNAVAILABLE=14]="UNAVAILABLE",it[it.DATA_LOSS=15]="DATA_LOSS";class Ta{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0!==n)for(const[t,r]of n)if(this.equalsFn(t,e))return r}has(e){return void 0!==this.get(e)}set(e,t){const n=this.mapKeyFn(e),r=this.inner[n];if(void 0===r)return this.inner[n]=[[e,t]],void this.innerSize++;for(let s=0;s<r.length;s++)if(this.equalsFn(r[s][0],e))return void(r[s]=[e,t]);r.push([e,t]),this.innerSize++}delete(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0===n)return!1;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],e))return 1===n.length?delete this.inner[t]:n.splice(r,1),this.innerSize--,!0;return!1}forEach(r){Es(this.inner,(e,t)=>{for(const[e,n]of t)r(e,n)})}isEmpty(){return Ts(this.inner)}size(){return this.innerSize}}const Sa=new Ss(Wr.comparator);const _a=new Ss(Wr.comparator);function xa(...e){let t=_a;for(const n of e)t=t.insert(n.key,n);return t}function Da(e){let n=_a;return e.forEach((e,t)=>n=n.insert(e,t.overlayedDocument)),n}function Aa(){return new Ta(e=>e.toString(),(e,t)=>e.isEqual(t))}const Ca=new Ss(Wr.comparator),Na=new Ds(Wr.comparator);function ka(...e){let t=Na;for(const n of e)t=t.add(n);return t}const Ra=new Ds(Ur);class Ma{constructor(e,t,n,r,s){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=s}static createSynthesizedRemoteEventForCurrentChange(e,t){const n=new Map;return n.set(e,La.createSynthesizedTargetChangeForCurrentChange(e,t)),new Ma(Gr.min(),n,Ra,Sa,ka())}}class La{constructor(e,t,n,r,s){this.resumeToken=e,this.current=t,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=s}static createSynthesizedTargetChangeForCurrentChange(e,t){return new La(ks.EMPTY_BYTE_STRING,t,ka(),ka(),ka())}}class Oa{constructor(e,t,n,r){this.gt=e,this.removedTargetIds=t,this.key=n,this.yt=r}}class Va{constructor(e,t){this.targetId=e,this.It=t}}class Fa{constructor(e,t,n=ks.EMPTY_BYTE_STRING,r=null){this.state=e,this.targetIds=t,this.resumeToken=n,this.cause=r}}class Pa{constructor(){this.Tt=0,this.Et=qa(),this.At=ks.EMPTY_BYTE_STRING,this.Rt=!1,this.bt=!0}get current(){return this.Rt}get resumeToken(){return this.At}get Pt(){return 0!==this.Tt}get vt(){return this.bt}Vt(e){0<e.approximateByteSize()&&(this.bt=!0,this.At=e)}St(){let n=ka(),r=ka(),s=ka();return this.Et.forEach((e,t)=>{switch(t){case 0:n=n.add(e);break;case 2:r=r.add(e);break;case 1:s=s.add(e);break;default:xr()}}),new La(this.At,this.Rt,n,r,s)}Dt(){this.bt=!1,this.Et=qa()}Ct(e,t){this.bt=!0,this.Et=this.Et.insert(e,t)}xt(e){this.bt=!0,this.Et=this.Et.remove(e)}Nt(){this.Tt+=1}kt(){--this.Tt}Ot(){this.bt=!0,this.Rt=!0}}class Ba{constructor(e){this.Mt=e,this.Ft=new Map,this.$t=Sa,this.Bt=Ua(),this.Lt=new Ds(Ur)}Ut(e){for(const t of e.gt)e.yt&&e.yt.isFoundDocument()?this.qt(t,e.yt):this.Kt(t,e.key,e.yt);for(const n of e.removedTargetIds)this.Kt(n,e.key,e.yt)}Gt(n){this.forEachTarget(n,e=>{const t=this.Qt(e);switch(n.state){case 0:this.jt(e)&&t.Vt(n.resumeToken);break;case 1:t.kt(),t.Pt||t.Dt(),t.Vt(n.resumeToken);break;case 2:t.kt(),t.Pt||this.removeTarget(e);break;case 3:this.jt(e)&&(t.Ot(),t.Vt(n.resumeToken));break;case 4:this.jt(e)&&(this.Wt(e),t.Vt(n.resumeToken));break;default:xr()}})}forEachTarget(e,n){0<e.targetIds.length?e.targetIds.forEach(n):this.Ft.forEach((e,t)=>{this.jt(t)&&n(t)})}zt(e){const t=e.targetId,n=e.It.count,r=this.Ht(t);if(r){const e=r.target;if(fi(e))if(0===n){const n=new Wr(e.path);this.Kt(t,n,ui.newNoDocument(n,Gr.min()))}else Dr(1===n);else this.Jt(t)!==n&&(this.Wt(t),this.Lt=this.Lt.add(t))}}Yt(r){const s=new Map;this.Ft.forEach((e,t)=>{var n=this.Ht(t);if(n){if(e.current&&fi(n.target)){const s=new Wr(n.target.path);null!==this.$t.get(s)||this.Xt(t,s)||this.Kt(t,s,ui.newNoDocument(s,r))}e.vt&&(s.set(t,e.St()),e.Dt())}});let i=ka();this.Bt.forEach((e,t)=>{let n=!0;t.forEachWhile(e=>{var t=this.Ht(e);return!t||2===t.purpose||(n=!1)}),n&&(i=i.add(e))}),this.$t.forEach((e,t)=>t.setReadTime(r));var e=new Ma(r,s,this.Lt,this.$t,i);return this.$t=Sa,this.Bt=Ua(),this.Lt=new Ds(Ur),e}qt(e,t){var n;this.jt(e)&&(n=this.Xt(e,t.key)?2:0,this.Qt(e).Ct(t.key,n),this.$t=this.$t.insert(t.key,t),this.Bt=this.Bt.insert(t.key,this.Zt(t.key).add(e)))}Kt(e,t,n){if(this.jt(e)){const r=this.Qt(e);this.Xt(e,t)?r.Ct(t,1):r.xt(t),this.Bt=this.Bt.insert(t,this.Zt(t).delete(e)),n&&(this.$t=this.$t.insert(t,n))}}removeTarget(e){this.Ft.delete(e)}Jt(e){var t=this.Qt(e).St();return this.Mt.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}Nt(e){this.Qt(e).Nt()}Qt(e){let t=this.Ft.get(e);return t||(t=new Pa,this.Ft.set(e,t)),t}Zt(e){let t=this.Bt.get(e);return t||(t=new Ds(Ur),this.Bt=this.Bt.insert(e,t)),t}jt(e){var t=null!==this.Ht(e);return t||Er("WatchChangeAggregator","Detected inactive target",e),t}Ht(e){var t=this.Ft.get(e);return t&&t.Pt?null:this.Mt.te(e)}Wt(t){this.Ft.set(t,new Pa),this.Mt.getRemoteKeysForTarget(t).forEach(e=>{this.Kt(t,e,null)})}Xt(e,t){return this.Mt.getRemoteKeysForTarget(e).has(t)}}function Ua(){return new Ss(Wr.comparator)}function qa(){return new Ss(Wr.comparator)}const ja={asc:"ASCENDING",desc:"DESCENDING"},Ka={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"};class Ga{constructor(e,t){this.databaseId=e,this.dt=t}}function $a(e,t){return e.dt?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function za(e,t){return e.dt?t.toBase64():t.toUint8Array()}function Qa(e){return Dr(!!e),Gr.fromTimestamp((t=Ms(e),new Kr(t.seconds,t.nanos)));var t}function Ha(e,t){return e=e,new zr(["projects",e.projectId,"databases",e.database]).child("documents").child(t).canonicalString()}function Wa(e){var t=zr.fromString(e);return Dr(go(t)),t}function Ya(e,t){return Ha(e.databaseId,t.path)}function Xa(e,t){const n=Wa(t);if(n.get(1)!==e.databaseId.projectId)throw new Cr(Ar.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+e.databaseId.projectId);if(n.get(3)!==e.databaseId.database)throw new Cr(Ar.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+e.databaseId.database);return new Wr(to(n))}function Ja(e,t){return Ha(e.databaseId,t)}function Za(e){var t=Wa(e);return 4===t.length?zr.emptyPath():to(t)}function eo(e){return new zr(["projects",e.databaseId.projectId,"databases",e.databaseId.database]).canonicalString()}function to(e){return Dr(4<e.length&&"documents"===e.get(4)),e.popFirst(5)}function no(e,t,n){return{name:Ya(e,t),fields:n.value.mapValue.fields}}function ro(e,t,n){const r=Xa(e,t.name),s=Qa(t.updateTime),i=new oi({mapValue:{fields:t.fields}}),a=ui.newFoundDocument(r,s,i);return n&&a.setHasCommittedMutations(),n?a.setHasCommittedMutations():a}function so(e,t){let n;if(t instanceof fa)n={update:no(e,t.key,t.value)};else if(t instanceof va)n={delete:Ya(e,t.key)};else if(t instanceof ga)n={update:no(e,t.key,t.data),updateMask:function(e){const t=[];return e.fields.forEach(e=>t.push(e.canonicalString())),{fieldPaths:t}}(t.fieldMask)};else{if(!(t instanceof wa))return xr();n={verify:Ya(e,t.key)}}return 0<t.fieldTransforms.length&&(n.updateTransforms=t.fieldTransforms.map(e=>function(e){var t=e.transform;if(t instanceof Yi)return{fieldPath:e.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(t instanceof Xi)return{fieldPath:e.field.canonicalString(),appendMissingElements:{values:t.elements}};if(t instanceof Zi)return{fieldPath:e.field.canonicalString(),removeAllFromArray:{values:t.elements}};if(t instanceof ta)return{fieldPath:e.field.canonicalString(),increment:t._t};throw xr()}(e))),t.precondition.isNone||(n.currentDocument=void 0!==(r=t.precondition).updateTime?{updateTime:(t=r.updateTime,$a(e,t.toTimestamp()))}:void 0!==r.exists?{exists:r.exists}:xr()),n;var r}function io(t,n){const e=n.currentDocument?void 0!==(s=n.currentDocument).updateTime?aa.updateTime(Qa(s.updateTime)):void 0!==s.exists?aa.exists(s.exists):aa.none():aa.none(),r=n.updateTransforms?n.updateTransforms.map(e=>function(e,t){let n=null;if("setToServerValue"in t)Dr("REQUEST_TIME"===t.setToServerValue),n=new Yi;else if("appendMissingElements"in t){const e=t.appendMissingElements.values||[];n=new Xi(e)}else if("removeAllFromArray"in t){const e=t.removeAllFromArray.values||[];n=new Zi(e)}else"increment"in t?n=new ta(e,t.increment):xr();var r=Hr.fromServerFormat(t.fieldPath);return new sa(r,n)}(t,e)):[];var s;if(n.update){n.update.name;var i=Xa(t,n.update.name),a=new oi({mapValue:{fields:n.update.fields}});if(n.updateMask){const t=function(){const e=n.updateMask.fieldPaths||[];return new Ns(e.map(e=>Hr.fromServerFormat(e)))}();return new ga(i,a,t,e,r)}return new fa(i,a,e,r)}if(n.delete){const r=Xa(t,n.delete);return new va(r,e)}if(n.verify){const r=Xa(t,n.verify);return new wa(r,e)}return xr()}function ao(e,t){return{documents:[Ja(e,t.path)]}}function oo(e,t){const n={structuredQuery:{}},r=t.path;null!==t.collectionGroup?(n.parent=Ja(e,r),n.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(n.parent=Ja(e,r.popLast()),n.structuredQuery.from=[{collectionId:r.lastSegment()}]);var s=function(e){if(0!==e.length){var t=e.map(e=>function(e){if("=="===e.op){if(ti(e.value))return{unaryFilter:{field:co(e.field),op:"IS_NAN"}};if(ei(e.value))return{unaryFilter:{field:co(e.field),op:"IS_NULL"}}}else if("!="===e.op){if(ti(e.value))return{unaryFilter:{field:co(e.field),op:"IS_NOT_NAN"}};if(ei(e.value))return{unaryFilter:{field:co(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:co(e.field),op:(t=e.op,Ka[t]),value:e.value}};var t}(e));return 1===t.length?t[0]:{compositeFilter:{op:"AND",filters:t}}}}(t.filters);s&&(n.structuredQuery.where=s);s=function(e){if(0!==e.length)return e.map(e=>function(e){return{field:co(e.field),direction:(e=e.dir,ja[e])}}(e))}(t.orderBy);s&&(n.structuredQuery.orderBy=s);var i,s=(i=t.limit,e.dt||Us(i)?i:{value:i});return null!==s&&(n.structuredQuery.limit=s),t.startAt&&(n.structuredQuery.startAt={before:(s=t.startAt).inclusive,values:s.position}),t.endAt&&(n.structuredQuery.endAt={before:!(t=t.endAt).inclusive,values:t.position}),n}function uo(e){let t=Za(e.parent);const n=e.structuredQuery,r=n.from?n.from.length:0;let s=null;if(0<r){Dr(1===r);const g=n.from[0];g.allDescendants?s=g.collectionId:t=t.child(g.collectionId)}let i=[];n.where&&(i=function t(e){return e?void 0!==e.unaryFilter?[fo(e)]:void 0!==e.fieldFilter?[lo(e)]:void 0!==e.compositeFilter?e.compositeFilter.filters.map(e=>t(e)).reduce((e,t)=>e.concat(t)):xr():[]}(n.where));let a=[];n.orderBy&&(a=n.orderBy.map(e=>function(e){return new Di(ho(e.field),function(){switch(e.direction){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}())}(e)));let o=null;var u,c,h,l;n.limit&&(o=(e=n.limit,Us(u="object"==typeof e?e.value:e)?null:u));let d=null;n.startAt&&(d=(c=n.startAt,l=!!c.before,h=c.values||[],new xi(h,l)));let f=null;return n.endAt&&(f=(c=n.endAt,h=!c.before,l=c.values||[],new xi(l,h))),ki(t,s,a,i,o,"F",d,f)}function co(e){return{fieldPath:e.canonicalString()}}function ho(e){return Hr.fromServerFormat(e.fieldPath)}function lo(e){return yi.create(ho(e.fieldFilter.field),function(){switch(e.fieldFilter.op){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return xr()}}(),e.fieldFilter.value)}function fo(e){switch(e.unaryFilter.op){case"IS_NAN":var t=ho(e.unaryFilter.field);return yi.create(t,"==",{doubleValue:NaN});case"IS_NULL":t=ho(e.unaryFilter.field);return yi.create(t,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":var n=ho(e.unaryFilter.field);return yi.create(n,"!=",{doubleValue:NaN});case"IS_NOT_NULL":n=ho(e.unaryFilter.field);return yi.create(n,"!=",{nullValue:"NULL_VALUE"});default:return xr()}}function go(e){return 4<=e.length&&"projects"===e.get(0)&&"databases"===e.get(2)}function mo(e){let t="";for(let n=0;n<e.length;n++)0<t.length&&(t=po(t)),t=function(e,t){let n=t;const r=e.length;for(let s=0;s<r;s++){const r=e.charAt(s);switch(r){case"\0":n+="";break;case"":n+="";break;default:n+=r}}return n}(e.get(n),t);return po(t)}function po(e){return e+""}function yo(t){const n=t.length;if(Dr(2<=n),2===n)return Dr(""===t.charAt(0)&&""===t.charAt(1)),zr.emptyPath();const r=n-2,s=[];let i="";for(let a=0;a<n;){const n=t.indexOf("",a);switch((n<0||n>r)&&xr(),t.charAt(n+1)){case"":const r=t.substring(a,n);let e;0===i.length?e=r:(i+=r,e=i,i=""),s.push(e);break;case"":i+=t.substring(a,n),i+="\0";break;case"":i+=t.substring(a,n+1);break;default:xr()}a=n+2}return new zr(s)}const vo=["userId","batchId"];function wo(e,t){return[e,mo(t)]}function bo(e,t,n){return[e,mo(t),n]}const Io={},Eo=["prefixPath","collectionGroup","readTime","documentId"],To=["prefixPath","collectionGroup","documentId"],So=["collectionGroup","readTime","prefixPath","documentId"],_o=["canonicalId","targetId"],xo=["targetId","path"],Do=["path","targetId"],Ao=["collectionId","parent"],Co=["indexId","uid"],No=["uid","sequenceNumber"],ko=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],Ro=["indexId","uid","orderedDocumentKey"],Mo=["userId","collectionPath","documentId"],Lo=["userId","collectionPath","largestBatchId"],Oo=["userId","collectionGroup","largestBatchId"],Vo=["mutationQueues","mutations","documentMutations","remoteDocuments","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries"],Fo=[...Vo,"documentOverlays"],Po=["mutationQueues","mutations","documentMutations","remoteDocumentsV14","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries","documentOverlays"],Bo=Po,Uo=[...Bo,"indexConfiguration","indexState","indexEntries"];class qo extends as{constructor(e,t){super(),this.ee=e,this.currentSequenceNumber=t}}function jo(e,t){var n=e;return hs.N(n.ee,t)}class Ko{constructor(e,t,n,r){this.batchId=e,this.localWriteTime=t,this.baseMutations=n,this.mutations=r}applyToRemoteDocument(e,t){var n=t.mutationResults;for(let r=0;r<this.mutations.length;r++){const s=this.mutations[r];s.key.isEqual(e.key)&&ha(s,e,n[r])}}applyToLocalView(e,t){for(const n of this.baseMutations)n.key.isEqual(e.key)&&(t=la(n,e,t,this.localWriteTime));for(const r of this.mutations)r.key.isEqual(e.key)&&(t=la(r,e,t,this.localWriteTime));return t}applyToLocalDocumentSet(i,a){const o=Aa();return this.mutations.forEach(e=>{const t=i.get(e.key),n=t.overlayedDocument;let r=this.applyToLocalView(n,t.mutatedFields);r=a.has(e.key)?null:r;var s=ca(n,r);null!==s&&o.set(e.key,s),n.isValidDocument()||n.convertToNoDocument(Gr.min())}),o}keys(){return this.mutations.reduce((e,t)=>e.add(t.key),ka())}isEqual(e){return this.batchId===e.batchId&&qr(this.mutations,e.mutations,(e,t)=>da(e,t))&&qr(this.baseMutations,e.baseMutations,(e,t)=>da(e,t))}}class Go{constructor(e,t,n,r){this.batch=e,this.commitVersion=t,this.mutationResults=n,this.docVersions=r}static from(e,t,n){Dr(e.mutations.length===n.length);let r=Ca;var s=e.mutations;for(let i=0;i<s.length;i++)r=r.insert(s[i].key,n[i].version);return new Go(e,t,n,r)}}class $o{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return null!==e&&this.mutation===e.mutation}toString(){return`Overlay{\n      largestBatchId: ${this.largestBatchId},\n      mutation: ${this.mutation.toString()}\n    }`}}class zo{constructor(e,t,n,r,s=Gr.min(),i=Gr.min(),a=ks.EMPTY_BYTE_STRING){this.target=e,this.targetId=t,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=s,this.lastLimboFreeSnapshotVersion=i,this.resumeToken=a}withSequenceNumber(e){return new zo(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken)}withResumeToken(e,t){return new zo(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e)}withLastLimboFreeSnapshotVersion(e){return new zo(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken)}}class Qo{constructor(e){this.ne=e}}function Ho(e,t){const n=t.key,r={prefixPath:n.getCollectionPath().popLast().toArray(),collectionGroup:n.collectionGroup,documentId:n.path.lastSegment(),readTime:Wo(t.readTime),hasCommittedMutations:t.hasCommittedMutations};if(t.isFoundDocument())r.document={name:Ya(s=e.ne,(e=t).key),fields:e.data.value.mapValue.fields,updateTime:$a(s,e.version.toTimestamp())};else if(t.isNoDocument())r.noDocument={path:n.path.toArray(),readTime:Yo(t.version)};else{if(!t.isUnknownDocument())return xr();r.unknownDocument={path:n.path.toArray(),version:Yo(t.version)}}var s;return r}function Wo(e){var t=e.toTimestamp();return[t.seconds,t.nanoseconds]}function Yo(e){var t=e.toTimestamp();return{seconds:t.seconds,nanoseconds:t.nanoseconds}}function Xo(e){var t=new Kr(e.seconds,e.nanoseconds);return Gr.fromTimestamp(t)}function Jo(t,e){const n=(e.baseMutations||[]).map(e=>io(t.ne,e));for(let i=0;i<e.mutations.length-1;++i){const n=e.mutations[i];if(i+1<e.mutations.length&&void 0!==e.mutations[i+1].transform){const r=e.mutations[i+1];n.updateTransforms=r.transform.fieldTransforms,e.mutations.splice(i+1,1),++i}}const r=e.mutations.map(e=>io(t.ne,e)),s=Kr.fromMillis(e.localWriteTimeMs);return new Ko(e.batchId,s,n,r)}function Zo(e){var t,n=Xo(e.readTime),r=void 0!==e.lastLimboFreeSnapshotVersion?Xo(e.lastLimboFreeSnapshotVersion):Gr.min();let s;return s=void 0!==e.query.documents?(Dr(1===(t=e.query).documents.length),Fi(Ri(Za(t.documents[0])))):Fi(uo(e.query)),new zo(s,e.targetId,0,e.lastListenSequenceNumber,n,r,ks.fromBase64String(e.resumeToken))}function eu(e,t){var n=Yo(t.snapshotVersion),r=Yo(t.lastLimboFreeSnapshotVersion),s=(fi(t.target)?ao:oo)(e.ne,t.target),i=t.resumeToken.toBase64();return{targetId:t.targetId,canonicalId:li(t.target),readTime:n,resumeToken:i,lastListenSequenceNumber:t.sequenceNumber,lastLimboFreeSnapshotVersion:r,query:s}}function tu(e){var t=uo({parent:e.parent,structuredQuery:e.structuredQuery});return"LAST"===e.limitType?Pi(t,t.limit,"L"):t}function nu(e,t){return new $o(t.largestBatchId,io(e.ne,t.overlayMutation))}function ru(e,t){var n=t.path.lastSegment();return[e,mo(t.path.popLast()),n]}function su(e,t,n,r){return{indexId:e,uid:t.uid||"",sequenceNumber:n,readTime:Yo(r.readTime),documentKey:mo(r.documentKey.path),largestBatchId:r.largestBatchId}}class iu{getBundleMetadata(e,t){return au(e).get(t).next(e=>{if(e)return{id:(t=e).bundleId,createTime:Xo(t.createTime),version:t.version};var t})}saveBundleMetadata(e,t){return au(e).put({bundleId:(n=t).id,createTime:Yo(Qa(n.createTime)),version:n.version});var n}getNamedQuery(e,t){return ou(e).get(t).next(e=>{if(e)return{name:(t=e).name,query:tu(t.bundledQuery),readTime:Xo(t.readTime)};var t})}saveNamedQuery(e,t){return ou(e).put({name:(t=t).name,readTime:Yo(Qa(t.readTime)),bundledQuery:t.bundledQuery})}}function au(e){return jo(e,"bundles")}function ou(e){return jo(e,"namedQueries")}class uu{constructor(e,t){this.wt=e,this.userId=t}static se(e,t){var n=t.uid||"";return new uu(e,n)}getOverlay(e,t){return cu(e).get(ru(this.userId,t)).next(e=>e?nu(this.wt,e):null)}getOverlays(e,t){const n=Aa();return us.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&n.set(t,e)})).next(()=>n)}saveOverlays(r,s,e){const i=[];return e.forEach((e,t)=>{var n=new $o(s,t);i.push(this.ie(r,n))}),us.waitFor(i)}removeOverlaysForBatchId(n,e,r){const t=new Set;e.forEach(e=>t.add(mo(e.getCollectionPath())));const s=[];return t.forEach(e=>{var t=IDBKeyRange.bound([this.userId,e,r],[this.userId,e,r+1],!1,!0);s.push(cu(n).W("collectionPathOverlayIndex",t))}),us.waitFor(s)}getOverlaysForCollection(e,t,n){const r=Aa(),s=mo(t),i=IDBKeyRange.bound([this.userId,s,n],[this.userId,s,Number.POSITIVE_INFINITY],!0);return cu(e).K("collectionPathOverlayIndex",i).next(e=>{for(const t of e){const e=nu(this.wt,t);r.set(e.getKey(),e)}return r})}getOverlaysForCollectionGroup(e,t,n,s){const i=Aa();let a;var r=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,Number.POSITIVE_INFINITY],!0);return cu(e).J({index:"collectionGroupOverlayIndex",range:r},(e,t,n)=>{const r=nu(this.wt,t);i.size()<s||r.largestBatchId===a?(i.set(r.getKey(),r),a=r.largestBatchId):n.done()}).next(()=>i)}ie(e,t){return cu(e).put(function(e,t,n){var[,r,s]=ru(t,n.mutation.key);return{userId:t,collectionPath:r,documentId:s,collectionGroup:n.mutation.key.getCollectionGroup(),largestBatchId:n.largestBatchId,overlayMutation:so(e.ne,n.mutation)}}(this.wt,this.userId,t))}}function cu(e){return jo(e,"documentOverlays")}class hu{constructor(){}re(e,t){this.oe(e,t),t.ue()}oe(e,t){var n,r;"nullValue"in e?this.ce(t,5):"booleanValue"in e?(this.ce(t,10),t.ae(e.booleanValue?1:0)):"integerValue"in e?(this.ce(t,15),t.ae(Ls(e.integerValue))):"doubleValue"in e?(n=Ls(e.doubleValue),isNaN(n)?this.ce(t,13):(this.ce(t,15),qs(n)?t.ae(0):t.ae(n))):"timestampValue"in e?(r=e.timestampValue,this.ce(t,20),"string"==typeof r?t.he(r):(t.he(`${r.seconds||""}`),t.ae(r.nanos||0))):"stringValue"in e?(this.le(e.stringValue,t),this.fe(t)):"bytesValue"in e?(this.ce(t,30),t.de(Os(e.bytesValue)),this.fe(t)):"referenceValue"in e?this._e(e.referenceValue,t):"geoPointValue"in e?(r=e.geoPointValue,this.ce(t,45),t.ae(r.latitude||0),t.ae(r.longitude||0)):"mapValue"in e?si(e)?this.ce(t,Number.MAX_SAFE_INTEGER):(this.we(e.mapValue,t),this.fe(t)):"arrayValue"in e?(this.me(e.arrayValue,t),this.fe(t)):xr()}le(e,t){this.ce(t,25),this.ge(e,t)}ge(e,t){t.he(e)}we(e,t){var n=e.fields||{};this.ce(t,55);for(const e of Object.keys(n))this.le(e,t),this.oe(n[e],t)}me(e,t){var n=e.values||[];this.ce(t,50);for(const e of n)this.oe(e,t)}_e(e,t){this.ce(t,37),Wr.fromName(e).path.forEach(e=>{this.ce(t,60),this.ge(e,t)})}ce(e,t){e.ae(t)}fe(e){e.ae(2)}}function lu(e){var t=64-function(e){let t=0;for(let r=0;r<8;++r){var n=function(e){if(0===e)return 8;let t=0;return e>>4==0&&(t+=4,e<<=4),e>>6==0&&(t+=2,e<<=2),e>>7==0&&(t+=1),t}(255&e[r]);if(t+=n,8!==n)break}return t}(e);return Math.ceil(t/8)}hu.ye=new hu;class du{constructor(){this.buffer=new Uint8Array(1024),this.position=0}pe(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.Ie(n.value),n=t.next();this.Te()}Ee(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.Ae(n.value),n=t.next();this.Re()}be(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.Ie(e);else if(e<2048)this.Ie(960|e>>>6),this.Ie(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Ie(480|e>>>12),this.Ie(128|63&e>>>6),this.Ie(128|63&e);else{const e=t.codePointAt(0);this.Ie(240|e>>>18),this.Ie(128|63&e>>>12),this.Ie(128|63&e>>>6),this.Ie(128|63&e)}}this.Te()}Pe(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.Ae(e);else if(e<2048)this.Ae(960|e>>>6),this.Ae(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Ae(480|e>>>12),this.Ae(128|63&e>>>6),this.Ae(128|63&e);else{const e=t.codePointAt(0);this.Ae(240|e>>>18),this.Ae(128|63&e>>>12),this.Ae(128|63&e>>>6),this.Ae(128|63&e)}}this.Re()}ve(e){var t=this.Ve(e),n=lu(t);this.Se(1+n),this.buffer[this.position++]=255&n;for(let r=t.length-n;r<t.length;++r)this.buffer[this.position++]=255&t[r]}De(e){var t=this.Ve(e),n=lu(t);this.Se(1+n),this.buffer[this.position++]=~(255&n);for(let r=t.length-n;r<t.length;++r)this.buffer[this.position++]=~(255&t[r])}Ce(){this.xe(255),this.xe(255)}Ne(){this.ke(255),this.ke(255)}reset(){this.position=0}seed(e){this.Se(e.length),this.buffer.set(e,this.position),this.position+=e.length}Oe(){return this.buffer.slice(0,this.position)}Ve(e){const t=function(e){const t=new DataView(new ArrayBuffer(8));return t.setFloat64(0,e,!1),new Uint8Array(t.buffer)}(e),n=0!=(128&t[0]);t[0]^=n?255:128;for(let r=1;r<t.length;++r)t[r]^=n?255:0;return t}Ie(e){var t=255&e;0==t?(this.xe(0),this.xe(255)):255==t?(this.xe(255),this.xe(0)):this.xe(t)}Ae(e){var t=255&e;0==t?(this.ke(0),this.ke(255)):255==t?(this.ke(255),this.ke(0)):this.ke(e)}Te(){this.xe(0),this.xe(1)}Re(){this.ke(0),this.ke(1)}xe(e){this.Se(1),this.buffer[this.position++]=e}ke(e){this.Se(1),this.buffer[this.position++]=~e}Se(e){var t=e+this.position;if(!(t<=this.buffer.length)){let e=2*this.buffer.length;e<t&&(e=t);const n=new Uint8Array(e);n.set(this.buffer),this.buffer=n}}}class fu{constructor(e){this.Me=e}de(e){this.Me.pe(e)}he(e){this.Me.be(e)}ae(e){this.Me.ve(e)}ue(){this.Me.Ce()}}class gu{constructor(e){this.Me=e}de(e){this.Me.Ee(e)}he(e){this.Me.Pe(e)}ae(e){this.Me.De(e)}ue(){this.Me.Ne()}}class mu{constructor(){this.Me=new du,this.Fe=new fu(this.Me),this.$e=new gu(this.Me)}seed(e){this.Me.seed(e)}Be(e){return 0===e?this.Fe:this.$e}Oe(){return this.Me.Oe()}reset(){this.Me.reset()}}class pu{constructor(e,t,n,r){this.indexId=e,this.documentKey=t,this.arrayValue=n,this.directionalValue=r}Le(){const e=this.directionalValue.length,t=0===e||255===this.directionalValue[e-1]?e+1:e,n=new Uint8Array(t);return n.set(this.directionalValue,0),t!==e?n.set([0],this.directionalValue.length):++n[n.length-1],new pu(this.indexId,this.documentKey,this.arrayValue,n)}}function yu(e,t){let n=e.indexId-t.indexId;return 0!==n?n:(n=vu(e.arrayValue,t.arrayValue),0!==n?n:(n=vu(e.directionalValue,t.directionalValue),0!==n?n:Wr.comparator(e.documentKey,t.documentKey)))}function vu(e,t){for(let r=0;r<e.length&&r<t.length;++r){var n=e[r]-t[r];if(0!=n)return n}return e.length-t.length}class wu{constructor(e){this.collectionId=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment(),this.Ue=e.orderBy,this.qe=[];for(const t of e.filters){const e=t;e.ht()?this.Ke=e:this.qe.push(e)}}Ge(e){var t=Xr(e);if(void 0!==t&&!this.Qe(t))return!1;var n=Jr(e);let r=0,s=0;for(;r<n.length&&this.Qe(n[r]);++r);if(r===n.length)return!0;if(void 0!==this.Ke){const e=n[r];if(!this.je(this.Ke,e)||!this.We(this.Ue[s++],e))return!1;++r}for(;r<n.length;++r){const e=n[r];if(s>=this.Ue.length||!this.We(this.Ue[s++],e))return!1}return!0}Qe(e){for(const t of this.qe)if(this.je(t,e))return!0;return!1}je(e,t){if(void 0===e||!e.field.isEqual(t.fieldPath))return!1;var n="array-contains"===e.op||"array-contains-any"===e.op;return 2===t.kind==n}We(e,t){return!!e.field.isEqual(t.fieldPath)&&(0===t.kind&&"asc"===e.dir||1===t.kind&&"desc"===e.dir)}}class bu{constructor(){this.ze=new Iu}addToCollectionParentIndex(e,t){return this.ze.add(t),us.resolve()}getCollectionParents(e,t){return us.resolve(this.ze.getEntries(t))}addFieldIndex(e,t){return us.resolve()}deleteFieldIndex(e,t){return us.resolve()}getDocumentsMatchingTarget(e,t){return us.resolve(null)}getIndexType(e,t){return us.resolve(0)}getFieldIndexes(e,t){return us.resolve([])}getNextCollectionGroupToUpdate(e){return us.resolve(null)}getMinOffset(e,t){return us.resolve(rs.min())}getMinOffsetFromCollectionGroup(e,t){return us.resolve(rs.min())}updateCollectionGroup(e,t,n){return us.resolve()}updateIndexEntries(e,t){return us.resolve()}}class Iu{constructor(){this.index={}}add(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t]||new Ds(zr.comparator),s=!r.has(n);return this.index[t]=r.add(n),s}has(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t];return r&&r.has(n)}getEntries(e){return(this.index[e]||new Ds(zr.comparator)).toArray()}}const Eu=new Uint8Array(0);class Tu{constructor(e,t){this.user=e,this.databaseId=t,this.He=new Iu,this.Je=new Ta(e=>li(e),(e,t)=>di(e,t)),this.uid=e.uid||""}addToCollectionParentIndex(e,t){if(this.He.has(t))return us.resolve();var n=t.lastSegment(),r=t.popLast();e.addOnCommittedListener(()=>{this.He.add(t)});r={collectionId:n,parent:mo(r)};return Su(e).put(r)}getCollectionParents(e,n){const r=[],t=IDBKeyRange.bound([n,""],[jr(n),""],!1,!0);return Su(e).K(t).next(e=>{for(const t of e){if(t.collectionId!==n)break;r.push(yo(t.parent))}return r})}addFieldIndex(e,t){const n=xu(e),r={indexId:t.indexId,collectionGroup:t.collectionGroup,fields:t.fields.map(e=>[e.fieldPath.canonicalString(),e.kind])};delete r.indexId;const s=n.add(r);if(t.indexState){const n=Du(e);return s.next(e=>{n.put(su(e,this.user,t.indexState.sequenceNumber,t.indexState.offset))})}return s.next()}deleteFieldIndex(e,t){const n=xu(e),r=Du(e),s=_u(e);return n.delete(t.indexId).next(()=>r.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0))).next(()=>s.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0)))}getDocumentsMatchingTarget(e,c){const h=_u(e);let l=!0;const n=new Map;return us.forEach(this.Ye(c),t=>this.Xe(e,t).next(e=>{l=l&&!!e,n.set(t,e)})).next(()=>{if(l){let u=ka();const l=[];return us.forEach(n,(e,t)=>{Er("IndexedDbIndexManager",`Using index ${o=e,`id=${o.indexId}|cg=${o.collectionGroup}|f=${o.fields.map(e=>`${e.fieldPath}:${e.kind}`).join(",")}`} to execute ${li(c)}`);var n=function(e,t){var n=Xr(t);if(void 0===n)return null;for(const t of gi(e,n.fieldPath))switch(t.op){case"array-contains-any":return t.value.arrayValue.values||[];case"array-contains":return[t.value]}return null}(t,e),r=function(e,t){const n=new Map;for(const r of Jr(t))for(const t of gi(e,r.fieldPath))switch(t.op){case"==":case"in":n.set(r.fieldPath.canonicalString(),t.value);break;case"not-in":case"!=":return n.set(r.fieldPath.canonicalString(),t.value),Array.from(n.values())}return null}(t,e),s=function(e,t){const n=[];let r=!0;for(const s of Jr(t)){const t=(0===s.kind?mi:pi)(e,s.fieldPath,e.startAt);n.push(t.value),r=r&&t.inclusive}return new xi(n,r)}(t,e),i=function(e,t){const n=[];let r=!0;for(const s of Jr(t)){const t=(0===s.kind?pi:mi)(e,s.fieldPath,e.endAt);n.push(t.value),r=r&&t.inclusive}return new xi(n,r)}(t,e),a=this.Ze(e,t,s),o=this.Ze(e,t,i),r=this.tn(e,t,r),r=this.en(e.indexId,n,a,s.inclusive,o,i.inclusive,r);return us.forEach(r,e=>h.j(e,c.limit).next(e=>{e.forEach(e=>{var t=Wr.fromSegments(e.documentKey);u.has(t)||(u=u.add(t),l.push(t))})}))}).next(()=>l)}return us.resolve(null)})}Ye(e){var t;return(t=this.Je.get(e))||(this.Je.set(e,t=[e]),t)}en(t,e,n,r,s,i,a){const o=(null!=e?e.length:1)*Math.max(n.length,s.length),u=o/(null!=e?e.length:1),c=[];for(let h=0;h<o;++h){const o=e?this.nn(e[h/u]):Eu,l=this.sn(t,o,n[h%u],r),d=this.rn(t,o,s[h%u],i),f=a.map(e=>this.sn(t,o,e,!0));c.push(...this.createRange(l,d,f))}return c}sn(e,t,n,r){const s=new pu(e,Wr.empty(),t,n);return r?s:s.Le()}rn(e,t,n,r){const s=new pu(e,Wr.empty(),t,n);return r?s.Le():s}Xe(e,t){const r=new wu(t),n=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment();return this.getFieldIndexes(e,n).next(e=>{let t=null;for(const n of e)r.Ge(n)&&(!t||n.fields.length>t.fields.length)&&(t=n);return t})}getIndexType(e,t){let n=2;return us.forEach(this.Ye(t),t=>this.Xe(e,t).next(e=>{e?0!==n&&e.fields.length<function(e){let t=new Ds(Hr.comparator),n=!1;for(const r of e.filters){const e=r;e.field.isKeyField()||("array-contains"===e.op||"array-contains-any"===e.op?n=!0:t=t.add(e.field))}for(const n of e.orderBy)n.field.isKeyField()||(t=t.add(n.field));return t.size+(n?1:0)}(t)&&(n=1):n=0})).next(()=>n)}on(e,t){const n=new mu;for(const s of Jr(e)){const e=t.data.field(s.fieldPath);if(null==e)return null;var r=n.Be(s.kind);hu.ye.re(e,r)}return n.Oe()}nn(e){const t=new mu;return hu.ye.re(e,t.Be(0)),t.Oe()}un(e,t){const n=new mu;return hu.ye.re(Xs(this.databaseId,t),n.Be(0===(r=Jr(e)).length?0:r[r.length-1].kind)),n.Oe();var r}tn(e,t,n){if(null===n)return[];let r=[];r.push(new mu);let s=0;for(const i of Jr(e)){const e=n[s++];for(const n of r)if(this.cn(t,i.fieldPath)&&Zs(e))r=this.an(r,i,e);else{const t=n.Be(i.kind);hu.ye.re(e,t)}}return this.hn(r)}Ze(e,t,n){return this.tn(e,t,n.position)}hn(e){const t=[];for(let n=0;n<e.length;++n)t[n]=e[n].Oe();return t}an(e,t,n){const r=[...e],s=[];for(const e of n.arrayValue.values||[])for(const n of r){const r=new mu;r.seed(n.Oe()),hu.ye.re(e,r.Be(t.kind)),s.push(r)}return s}cn(e,t){return!!e.filters.find(e=>e instanceof yi&&e.field.isEqual(t)&&("in"===e.op||"not-in"===e.op))}getFieldIndexes(e,t){const n=xu(e),r=Du(e);return(t?n.K("collectionGroupIndex",IDBKeyRange.bound(t,t)):n.K()).next(e=>{const i=[];return us.forEach(e,s=>r.get([s.indexId,this.uid]).next(e=>{var t,n,r;i.push((t=s,n=(e=e)?new es(e.sequenceNumber,new rs(Xo(e.readTime),new Wr(yo(e.documentKey)),e.largestBatchId)):es.empty(),r=t.fields.map(([e,t])=>new Zr(Hr.fromServerFormat(e),t)),new Yr(t.indexId,t.collectionGroup,r,n)))})).next(()=>i)})}getNextCollectionGroupToUpdate(e){return this.getFieldIndexes(e).next(e=>0===e.length?null:(e.sort((e,t)=>{var n=e.indexState.sequenceNumber-t.indexState.sequenceNumber;return 0!=n?n:Ur(e.collectionGroup,t.collectionGroup)}),e[0].collectionGroup))}updateCollectionGroup(e,n,r){const s=xu(e),i=Du(e);return this.ln(e).next(t=>s.K("collectionGroupIndex",IDBKeyRange.bound(n,n)).next(e=>us.forEach(e,e=>i.put(su(e.indexId,this.user,t,r)))))}updateIndexEntries(s,e){const n=new Map;return us.forEach(e,(t,r)=>{var e=n.get(t.collectionGroup);return(e?us.resolve(e):this.getFieldIndexes(s,t.collectionGroup)).next(e=>(n.set(t.collectionGroup,e),us.forEach(e,n=>this.fn(s,t,n).next(e=>{var t=this.dn(r,n);return e.isEqual(t)?us.resolve():this._n(s,r,n,e,t)}))))})}wn(e,t,n,r){return _u(e).put({indexId:r.indexId,uid:this.uid,arrayValue:r.arrayValue,directionalValue:r.directionalValue,orderedDocumentKey:this.un(n,t.key),documentKey:t.key.path.toArray()})}mn(e,t,n,r){return _u(e).delete([r.indexId,this.uid,r.arrayValue,r.directionalValue,this.un(n,t.key),t.key.path.toArray()])}fn(e,n,r){const t=_u(e);let s=new Ds(yu);return t.J({index:"documentKeyIndex",range:IDBKeyRange.only([r.indexId,this.uid,this.un(r,n)])},(e,t)=>{s=s.add(new pu(r.indexId,n,t.arrayValue,t.directionalValue))}).next(()=>s)}dn(e,t){let n=new Ds(yu);var r=this.on(t,e);if(null==r)return n;const s=Xr(t);if(null!=s){var i=e.data.field(s.fieldPath);if(Zs(i))for(const s of i.arrayValue.values||[])n=n.add(new pu(t.indexId,e.key,this.nn(s),r))}else n=n.add(new pu(t.indexId,e.key,Eu,r));return n}_n(t,n,r,c,e){Er("IndexedDbIndexManager","Updating index entries for document '%s'",n.key);const s=[];return function(e,n,r,s){var i=c.getIterator(),a=e.getIterator();let o=Cs(i),u=Cs(a);for(;o||u;){let e=!1,t=!1;if(o&&u){const r=n(o,u);r<0?t=!0:0<r&&(e=!0)}else null!=o?t=!0:e=!0;e?(r(u),u=Cs(a)):t?(s(o),o=Cs(i)):(o=Cs(i),u=Cs(a))}}(e,yu,e=>{s.push(this.wn(t,n,r,e))},e=>{s.push(this.mn(t,n,r,e))}),us.waitFor(s)}ln(e){let r=1;return Du(e).J({index:"sequenceNumberIndex",reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},(e,t,n)=>{n.done(),r=t.sequenceNumber+1}).next(()=>r)}createRange(e,t,n){n=n.sort((e,t)=>yu(e,t)).filter((e,t,n)=>!t||0!==yu(e,n[t-1]));const r=[];r.push(e);for(const s of n){const n=yu(s,e),i=yu(s,t);if(0===n)r[0]=e.Le();else if(0<n&&i<0)r.push(s),r.push(s.Le());else if(0<i)break}r.push(t);const s=[];for(let a=0;a<r.length;a+=2)s.push(IDBKeyRange.bound([r[a].indexId,this.uid,r[a].arrayValue,r[a].directionalValue,Eu,[]],[r[a+1].indexId,this.uid,r[a+1].arrayValue,r[a+1].directionalValue,Eu,[]]));return s}getMinOffsetFromCollectionGroup(e,t){return this.getFieldIndexes(e,t).next(Au)}getMinOffset(t,e){return us.mapArray(this.Ye(e),e=>this.Xe(t,e).next(e=>e||xr())).next(Au)}}function Su(e){return jo(e,"collectionParents")}function _u(e){return jo(e,"indexEntries")}function xu(e){return jo(e,"indexConfiguration")}function Du(e){return jo(e,"indexState")}function Au(e){Dr(0!==e.length);let t=e[0].indexState.offset,n=t.largestBatchId;for(let s=1;s<e.length;s++){var r=e[s].indexState.offset;ss(r,t)<0&&(t=r),n<r.largestBatchId&&(n=r.largestBatchId)}return new rs(t.readTime,t.documentKey,n)}const Cu={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class Nu{constructor(e,t,n){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=n}static withCacheSize(e){return new Nu(e,Nu.DEFAULT_COLLECTION_PERCENTILE,Nu.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}function ku(e,t,n){const r=e.store("mutations"),s=e.store("documentMutations"),i=[],a=IDBKeyRange.only(n.batchId);let o=0;const u=r.J({range:a},(e,t,n)=>(o++,n.delete()));i.push(u.next(()=>{Dr(1===o)}));const c=[];for(const e of n.mutations){const r=bo(t,e.key.path,n.batchId);i.push(s.delete(r)),c.push(e.key)}return us.waitFor(i).next(()=>c)}function Ru(e){if(!e)return 0;let t;if(e.document)t=e.document;else if(e.unknownDocument)t=e.unknownDocument;else{if(!e.noDocument)throw xr();t=e.noDocument}return JSON.stringify(t).length}Nu.DEFAULT_COLLECTION_PERCENTILE=10,Nu.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,Nu.DEFAULT=new Nu(41943040,Nu.DEFAULT_COLLECTION_PERCENTILE,Nu.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),Nu.DISABLED=new Nu(-1,0,0);class Mu{constructor(e,t,n,r){this.userId=e,this.wt=t,this.indexManager=n,this.referenceDelegate=r,this.gn={}}static se(e,t,n,r){Dr(""!==e.uid);var s=e.isAuthenticated()?e.uid:"";return new Mu(s,t,n,r)}checkEmpty(e){let r=!0;var t=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return Ou(e).J({index:"userMutationsIndex",range:t},(e,t,n)=>{r=!1,n.done()}).next(()=>r)}addMutationBatch(h,l,d,f){const g=Vu(h),m=Ou(h);return m.add({}).next(e=>{Dr("number"==typeof e);const t=new Ko(e,l,d,f),n=(s=this.wt,i=this.userId,a=t,o=a.baseMutations.map(e=>so(s.ne,e)),u=a.mutations.map(e=>so(s.ne,e)),{userId:i,batchId:a.batchId,localWriteTimeMs:a.localWriteTime.toMillis(),baseMutations:o,mutations:u}),r=[];var s,i,a,o,u;let c=new Ds((e,t)=>Ur(e.canonicalString(),t.canonicalString()));for(const h of f){const l=bo(this.userId,h.key.path,e);c=c.add(h.key.path.popLast()),r.push(m.put(n)),r.push(g.put(l,Io))}return c.forEach(e=>{r.push(this.indexManager.addToCollectionParentIndex(h,e))}),h.addOnCommittedListener(()=>{this.gn[e]=t.keys()}),us.waitFor(r).next(()=>t)})}lookupMutationBatch(e,t){return Ou(e).get(t).next(e=>e?(Dr(e.userId===this.userId),Jo(this.wt,e)):null)}yn(e,n){return this.gn[n]?us.resolve(this.gn[n]):this.lookupMutationBatch(e,n).next(e=>{if(e){var t=e.keys();return this.gn[n]=t}return null})}getNextMutationBatchAfterBatchId(e,t){const r=t+1,n=IDBKeyRange.lowerBound([this.userId,r]);let s=null;return Ou(e).J({index:"userMutationsIndex",range:n},(e,t,n)=>{t.userId===this.userId&&(Dr(t.batchId>=r),s=Jo(this.wt,t)),n.done()}).next(()=>s)}getHighestUnacknowledgedBatchId(e){var t=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let r=-1;return Ou(e).J({index:"userMutationsIndex",range:t,reverse:!0},(e,t,n)=>{r=t.batchId,n.done()}).next(()=>r)}getAllMutationBatches(e){var t=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return Ou(e).K("userMutationsIndex",t).next(e=>e.map(e=>Jo(this.wt,e)))}getAllMutationBatchesAffectingDocumentKey(a,o){const e=wo(this.userId,o.path),t=IDBKeyRange.lowerBound(e),u=[];return Vu(a).J({range:t},(e,t,n)=>{var[r,s,i]=e,s=yo(s);if(r===this.userId&&o.path.isEqual(s))return Ou(a).get(i).next(e=>{if(!e)throw xr();Dr(e.userId===this.userId),u.push(Jo(this.wt,e))});n.done()}).next(()=>u)}getAllMutationBatchesAffectingDocumentKeys(t,e){let o=new Ds(Ur);const n=[];return e.forEach(a=>{var e=wo(this.userId,a.path),e=IDBKeyRange.lowerBound(e),e=Vu(t).J({range:e},(e,t,n)=>{var[r,s,i]=e,s=yo(s);r===this.userId&&a.path.isEqual(s)?o=o.add(i):n.done()});n.push(e)}),us.waitFor(n).next(()=>this.pn(t,o))}getAllMutationBatchesAffectingQuery(e,t){const a=t.path,o=a.length+1,n=wo(this.userId,a),r=IDBKeyRange.lowerBound(n);let u=new Ds(Ur);return Vu(e).J({range:r},(e,t,n)=>{var[r,s,i]=e,s=yo(s);r===this.userId&&a.isPrefixOf(s)?s.length===o&&(u=u.add(i)):n.done()}).next(()=>this.pn(e,u))}pn(t,e){const n=[],r=[];return e.forEach(e=>{r.push(Ou(t).get(e).next(e=>{if(null===e)throw xr();Dr(e.userId===this.userId),n.push(Jo(this.wt,e))}))}),us.waitFor(r).next(()=>n)}removeMutationBatch(t,n){return ku(t.ee,this.userId,n).next(e=>(t.addOnCommittedListener(()=>{this.In(n.batchId)}),us.forEach(e,e=>this.referenceDelegate.markPotentiallyOrphaned(t,e))))}In(e){delete this.gn[e]}performConsistencyCheck(n){return this.checkEmpty(n).next(e=>{if(!e)return us.resolve();var t=IDBKeyRange.lowerBound([this.userId]);const r=[];return Vu(n).J({range:t},(e,t,n)=>{if(e[0]===this.userId){const t=yo(e[1]);r.push(t)}else n.done()}).next(()=>{Dr(0===r.length)})})}containsKey(e,t){return Lu(e,this.userId,t)}Tn(e){return Fu(e).get(this.userId).next(e=>e||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""})}}function Lu(e,i,t){const n=wo(i,t.path),a=n[1],r=IDBKeyRange.lowerBound(n);let o=!1;return Vu(e).J({range:r,H:!0},(e,t,n)=>{var[r,s]=e;r===i&&s===a&&(o=!0),n.done()}).next(()=>o)}function Ou(e){return jo(e,"mutations")}function Vu(e){return jo(e,"documentMutations")}function Fu(e){return jo(e,"mutationQueues")}class Pu{constructor(e){this.En=e}next(){return this.En+=2,this.En}static An(){return new Pu(0)}static Rn(){return new Pu(-1)}}class Bu{constructor(e,t){this.referenceDelegate=e,this.wt=t}allocateTargetId(n){return this.bn(n).next(e=>{const t=new Pu(e.highestTargetId);return e.highestTargetId=t.next(),this.Pn(n,e).next(()=>e.highestTargetId)})}getLastRemoteSnapshotVersion(e){return this.bn(e).next(e=>Gr.fromTimestamp(new Kr(e.lastRemoteSnapshotVersion.seconds,e.lastRemoteSnapshotVersion.nanoseconds)))}getHighestSequenceNumber(e){return this.bn(e).next(e=>e.highestListenSequenceNumber)}setTargetsMetadata(t,n,r){return this.bn(t).next(e=>(e.highestListenSequenceNumber=n,r&&(e.lastRemoteSnapshotVersion=r.toTimestamp()),n>e.highestListenSequenceNumber&&(e.highestListenSequenceNumber=n),this.Pn(t,e)))}addTargetData(t,n){return this.vn(t,n).next(()=>this.bn(t).next(e=>(e.targetCount+=1,this.Vn(n,e),this.Pn(t,e))))}updateTargetData(e,t){return this.vn(e,t)}removeTargetData(t,e){return this.removeMatchingKeysForTargetId(t,e.targetId).next(()=>Uu(t).delete(e.targetId)).next(()=>this.bn(t)).next(e=>(Dr(0<e.targetCount),--e.targetCount,this.Pn(t,e)))}removeTargets(r,s,i){let a=0;const o=[];return Uu(r).J((e,t)=>{var n=Zo(t);n.sequenceNumber<=s&&null===i.get(n.targetId)&&(a++,o.push(this.removeTargetData(r,n)))}).next(()=>us.waitFor(o)).next(()=>a)}forEachTarget(e,r){return Uu(e).J((e,t)=>{var n=Zo(t);r(n)})}bn(e){return qu(e).get("targetGlobalKey").next(e=>(Dr(null!==e),e))}Pn(e,t){return qu(e).put("targetGlobalKey",t)}vn(e,t){return Uu(e).put(eu(this.wt,t))}Vn(e,t){let n=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,n=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,n=!0),n}getTargetCount(e){return this.bn(e).next(e=>e.targetCount)}getTargetData(e,s){var t=li(s),t=IDBKeyRange.bound([t,Number.NEGATIVE_INFINITY],[t,Number.POSITIVE_INFINITY]);let i=null;return Uu(e).J({range:t,index:"queryTargetsIndex"},(e,t,n)=>{var r=Zo(t);di(s,r.target)&&(i=r,n.done())}).next(()=>i)}addMatchingKeys(n,e,r){const s=[],i=ju(n);return e.forEach(e=>{var t=mo(e.path);s.push(i.put({targetId:r,path:t})),s.push(this.referenceDelegate.addReference(n,r,e))}),us.waitFor(s)}removeMatchingKeys(n,e,r){const s=ju(n);return us.forEach(e,e=>{var t=mo(e.path);return us.waitFor([s.delete([r,t]),this.referenceDelegate.removeReference(n,r,e)])})}removeMatchingKeysForTargetId(e,t){const n=ju(e),r=IDBKeyRange.bound([t],[t+1],!1,!0);return n.delete(r)}getMatchingKeysForTargetId(e,t){const n=IDBKeyRange.bound([t],[t+1],!1,!0),r=ju(e);let s=ka();return r.J({range:n,H:!0},(e,t,n)=>{var r=yo(e[1]),r=new Wr(r);s=s.add(r)}).next(()=>s)}containsKey(e,t){var n=mo(t.path),n=IDBKeyRange.bound([n],[jr(n)],!1,!0);let r=0;return ju(e).J({index:"documentTargetsIndex",H:!0,range:n},([e],t,n)=>{0!==e&&(r++,n.done())}).next(()=>0<r)}te(e,t){return Uu(e).get(t).next(e=>e?Zo(e):null)}}function Uu(e){return jo(e,"targets")}function qu(e){return jo(e,"targetGlobal")}function ju(e){return jo(e,"targetDocuments")}function Ku([e,t],[n,r]){var s=Ur(e,n);return 0===s?Ur(t,r):s}class Gu{constructor(e){this.Sn=e,this.buffer=new Ds(Ku),this.Dn=0}Cn(){return++this.Dn}xn(e){var t=[e,this.Cn()];if(this.buffer.size<this.Sn)this.buffer=this.buffer.add(t);else{const e=this.buffer.last();Ku(t,e)<0&&(this.buffer=this.buffer.delete(e).add(t))}}get maxValue(){return this.buffer.last()[0]}}class $u{constructor(e,t,n){this.garbageCollector=e,this.asyncQueue=t,this.localStore=n,this.Nn=null}start(){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.kn(6e4)}stop(){this.Nn&&(this.Nn.cancel(),this.Nn=null)}get started(){return null!==this.Nn}kn(e){Er("LruGarbageCollector",`Garbage collection scheduled in ${e}ms`),this.Nn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,async()=>{this.Nn=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(e){fs(e)?Er("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",e):await os(e)}await this.kn(3e5)})}}class zu{constructor(e,t){this.On=e,this.params=t}calculateTargetCount(e,t){return this.On.Mn(e).next(e=>Math.floor(t/100*e))}nthSequenceNumber(e,t){if(0===t)return us.resolve(bs.ot);const n=new Gu(t);return this.On.forEachTarget(e,e=>n.xn(e.sequenceNumber)).next(()=>this.On.Fn(e,e=>n.xn(e))).next(()=>n.maxValue)}removeTargets(e,t,n){return this.On.removeTargets(e,t,n)}removeOrphanedDocuments(e,t){return this.On.removeOrphanedDocuments(e,t)}collect(t,n){return-1===this.params.cacheSizeCollectionThreshold?(Er("LruGarbageCollector","Garbage collection skipped; disabled"),us.resolve(Cu)):this.getCacheSize(t).next(e=>e<this.params.cacheSizeCollectionThreshold?(Er("LruGarbageCollector",`Garbage collection skipped; Cache size ${e} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),Cu):this.$n(t,n))}getCacheSize(e){return this.On.getCacheSize(e)}$n(t,n){let r,s,i,a,o,u,c;const h=Date.now();return this.calculateTargetCount(t,this.params.percentileToCollect).next(e=>(s=e>this.params.maximumSequenceNumbersToCollect?(Er("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${e}`),this.params.maximumSequenceNumbersToCollect):e,a=Date.now(),this.nthSequenceNumber(t,s))).next(e=>(r=e,o=Date.now(),this.removeTargets(t,r,n))).next(e=>(i=e,u=Date.now(),this.removeOrphanedDocuments(t,r))).next(e=>(c=Date.now(),Ir()<=l.DEBUG&&Er("LruGarbageCollector",`LRU Garbage Collection\n\tCounted targets in ${a-h}ms\n\tDetermined least recently used ${s} in `+(o-a)+"ms\n"+`\tRemoved ${i} targets in `+(u-o)+"ms\n"+`\tRemoved ${e} documents in `+(c-u)+"ms\n"+`Total Duration: ${c-h}ms`),us.resolve({didRun:!0,sequenceNumbersCollected:s,targetsRemoved:i,documentsRemoved:e})))}}class Qu{constructor(e,t){this.db=e,this.garbageCollector=(e=this,t=t,new zu(e,t))}Mn(e){const n=this.Bn(e);return this.db.getTargetCache().getTargetCount(e).next(t=>n.next(e=>t+e))}Bn(e){let t=0;return this.Fn(e,e=>{t++}).next(()=>t)}forEachTarget(e,t){return this.db.getTargetCache().forEachTarget(e,t)}Fn(e,n){return this.Ln(e,(e,t)=>n(t))}addReference(e,t,n){return Hu(e,n)}removeReference(e,t,n){return Hu(e,n)}removeTargets(e,t,n){return this.db.getTargetCache().removeTargets(e,t,n)}markPotentiallyOrphaned(e,t){return Hu(e,t)}Un(t,n){let r=!1;return Fu(t).Y(e=>Lu(t,e,n).next(e=>(e&&(r=!0),us.resolve(!e)))).next(()=>r)}removeOrphanedDocuments(n,r){const s=this.db.getRemoteDocumentCache().newChangeBuffer(),i=[];let a=0;return this.Ln(n,(t,e)=>{if(e<=r){const r=this.Un(n,t).next(e=>{if(!e)return a++,s.getEntry(n,t).next(()=>(s.removeEntry(t,Gr.min()),ju(n).delete([0,mo(t.path)])))});i.push(r)}}).next(()=>us.waitFor(i)).next(()=>s.apply(n)).next(()=>a)}removeTarget(e,t){var n=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,n)}updateLimboDocument(e,t){return Hu(e,t)}Ln(e,r){const t=ju(e);let s,i=bs.ot;return t.J({index:"documentTargetsIndex"},([e],{path:t,sequenceNumber:n})=>{0===e?(i!==bs.ot&&r(new Wr(yo(s)),i),i=n,s=t):i=bs.ot}).next(()=>{i!==bs.ot&&r(new Wr(yo(s)),i)})}getCacheSize(e){return this.db.getRemoteDocumentCache().getSize(e)}}function Hu(e,t){return ju(e).put((e=e.currentSequenceNumber,{targetId:0,path:mo(t.path),sequenceNumber:e}))}class Wu{constructor(){this.changes=new Ta(e=>e.toString(),(e,t)=>e.isEqual(t)),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,ui.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();var n=this.changes.get(t);return void 0!==n?us.resolve(n):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}}class Yu{constructor(e){this.wt=e}setIndexManager(e){this.indexManager=e}addEntry(e,t,n){return ec(e).put(n)}removeEntry(e,n,t){return ec(e).delete(function(e){const t=n.path.toArray();return[t.slice(0,t.length-2),t[t.length-2],Wo(e),t[t.length-1]]}(t))}updateMetadata(t,n){return this.getMetadata(t).next(e=>(e.byteSize+=n,this.qn(t,e)))}getEntry(e,n){let r=ui.newInvalidDocument(n);return ec(e).J({index:"documentKeyIndex",range:IDBKeyRange.only(tc(n))},(e,t)=>{r=this.Kn(n,t)}).next(()=>r)}Gn(e,n){let r={size:0,document:ui.newInvalidDocument(n)};return ec(e).J({index:"documentKeyIndex",range:IDBKeyRange.only(tc(n))},(e,t)=>{r={document:this.Kn(n,t),size:Ru(t)}}).next(()=>r)}getEntries(e,t){let r=Sa;return this.Qn(e,t,(e,t)=>{var n=this.Kn(e,t);r=r.insert(e,n)}).next(()=>r)}jn(e,t){let r=Sa,s=new Ss(Wr.comparator);return this.Qn(e,t,(e,t)=>{var n=this.Kn(e,t);r=r.insert(e,n),s=s.insert(e,Ru(t))}).next(()=>({documents:r,Wn:s}))}Qn(e,t,s){if(t.isEmpty())return us.resolve();let n=new Ds(rc);t.forEach(e=>n=n.add(e));const r=IDBKeyRange.bound(tc(n.first()),tc(n.last())),i=n.getIterator();let a=i.getNext();return ec(e).J({index:"documentKeyIndex",range:r},(e,t,n)=>{for(var r=Wr.fromSegments([...t.prefixPath,t.collectionGroup,t.documentId]);a&&rc(a,r)<0;)s(a,null),a=i.getNext();a&&a.isEqual(r)&&(s(a,t),a=i.hasNext()?i.getNext():null),a?n.q(tc(a)):n.done()}).next(()=>{for(;a;)s(a,null),a=i.hasNext()?i.getNext():null})}getAllFromCollection(e,t,n){var r=[t.popLast().toArray(),t.lastSegment(),Wo(n.readTime),n.documentKey.path.isEmpty()?"":n.documentKey.path.lastSegment()],s=[t.popLast().toArray(),t.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return ec(e).K(IDBKeyRange.bound(r,s,!0)).next(e=>{let t=Sa;for(const n of e){const e=this.Kn(Wr.fromSegments(n.prefixPath.concat(n.collectionGroup,n.documentId)),n);t=t.insert(e.key,e)}return t})}getAllFromCollectionGroup(e,t,n,s){let i=Sa;var r=nc(t,n),a=nc(t,rs.max());return ec(e).J({index:"collectionGroupIndex",range:IDBKeyRange.bound(r,a,!0)},(e,t,n)=>{var r=this.Kn(Wr.fromSegments(t.prefixPath.concat(t.collectionGroup,t.documentId)),t);i=i.insert(r.key,r),i.size===s&&n.done()}).next(()=>i)}newChangeBuffer(e){return new Ju(this,!!e&&e.trackRemovals)}getSize(e){return this.getMetadata(e).next(e=>e.byteSize)}getMetadata(e){return Zu(e).get("remoteDocumentGlobalKey").next(e=>(Dr(!!e),e))}qn(e,t){return Zu(e).put("remoteDocumentGlobalKey",t)}Kn(e,t){if(t){const e=function(e,t){let n;if(t.document)n=ro(e.ne,t.document,!!t.hasCommittedMutations);else if(t.noDocument){const e=Wr.fromSegments(t.noDocument.path),s=Xo(t.noDocument.readTime);n=ui.newNoDocument(e,s),t.hasCommittedMutations&&n.setHasCommittedMutations()}else{if(!t.unknownDocument)return xr();{const e=Wr.fromSegments(t.unknownDocument.path),i=Xo(t.unknownDocument.version);n=ui.newUnknownDocument(e,i)}}return t.readTime&&n.setReadTime((t=t.readTime,r=new Kr(t[0],t[1]),Gr.fromTimestamp(r))),n;var r}(this.wt,t);if(!e.isNoDocument()||!e.version.isEqual(Gr.min()))return e}return ui.newInvalidDocument(e)}}function Xu(e){return new Yu(e)}class Ju extends Wu{constructor(e,t){super(),this.zn=e,this.trackRemovals=t,this.Hn=new Ta(e=>e.toString(),(e,t)=>e.isEqual(t))}applyChanges(i){const a=[];let o=0,u=new Ds((e,t)=>Ur(e.canonicalString(),t.canonicalString()));return this.changes.forEach((e,t)=>{var n=this.Hn.get(e);if(a.push(this.zn.removeEntry(i,e,n.readTime)),t.isValidDocument()){var r=Ho(this.zn.wt,t);u=u.add(e.path.popLast());var s=Ru(r);o+=s-n.size,a.push(this.zn.addEntry(i,e,r))}else if(o-=n.size,this.trackRemovals){const o=Ho(this.zn.wt,t.convertToNoDocument(Gr.min()));a.push(this.zn.addEntry(i,e,o))}}),u.forEach(e=>{a.push(this.zn.indexManager.addToCollectionParentIndex(i,e))}),a.push(this.zn.updateMetadata(i,o)),us.waitFor(a)}getFromCache(e,t){return this.zn.Gn(e,t).next(e=>(this.Hn.set(t,{size:e.size,readTime:e.document.readTime}),e.document))}getAllFromCache(e,t){return this.zn.jn(e,t).next(({documents:n,Wn:e})=>(e.forEach((e,t)=>{this.Hn.set(e,{size:t,readTime:n.get(e).readTime})}),n))}}function Zu(e){return jo(e,"remoteDocumentGlobal")}function ec(e){return jo(e,"remoteDocumentsV14")}function tc(e){const t=e.path.toArray();return[t.slice(0,t.length-2),t[t.length-2],t[t.length-1]]}function nc(e,t){const n=t.documentKey.path.toArray();return[e,Wo(t.readTime),n.slice(0,n.length-2),0<n.length?n[n.length-1]:""]}function rc(e,t){var n=e.path.toArray(),r=t.path.toArray();let s=0;for(let i=0;i<n.length-2&&i<r.length-2;++i)if(s=Ur(n[i],r[i]),s)return s;return s=Ur(n.length,r.length),s||(s=Ur(n[n.length-2],r[r.length-2]),s||Ur(n[n.length-1],r[r.length-1]))}class sc{constructor(e,t){this.overlayedDocument=e,this.mutatedFields=t}}class ic{constructor(e,t,n,r){this.remoteDocumentCache=e,this.mutationQueue=t,this.documentOverlayCache=n,this.indexManager=r}getDocument(t,n){let r=null;return this.documentOverlayCache.getOverlay(t,n).next(e=>(r=e,this.getBaseDocument(t,n,r))).next(e=>(null!==r&&la(r.mutation,e,Ns.empty(),Kr.now()),e))}getDocuments(t,e){return this.remoteDocumentCache.getEntries(t,e).next(e=>this.getLocalViewOfDocuments(t,e,ka()).next(()=>e))}getLocalViewOfDocuments(e,t,n=ka()){const r=Aa();return this.populateOverlays(e,r,t).next(()=>this.computeViews(e,t,r,n).next(e=>{let n=xa();return e.forEach((e,t)=>{n=n.insert(e,t.overlayedDocument)}),n}))}getOverlayedDocuments(e,t){const n=Aa();return this.populateOverlays(e,n,t).next(()=>this.computeViews(e,t,n,ka()))}populateOverlays(e,n,t){const r=[];return t.forEach(e=>{n.has(e)||r.push(e)}),this.documentOverlayCache.getOverlays(e,r).next(e=>{e.forEach((e,t)=>{n.set(e,t)})})}computeViews(e,t,r,s){let i=Sa;const a=Aa(),o=Aa();return t.forEach((e,t)=>{const n=r.get(t.key);s.has(t.key)&&(void 0===n||n.mutation instanceof ga)?i=i.insert(t.key,t):void 0!==n&&(a.set(t.key,n.mutation.getFieldMask()),la(n.mutation,t,n.mutation.getFieldMask(),Kr.now()))}),this.recalculateAndSaveOverlays(e,i).next(e=>(e.forEach((e,t)=>a.set(e,t)),t.forEach((e,t)=>{var n;return o.set(e,new sc(t,null!==(n=a.get(e))&&void 0!==n?n:null))}),o))}recalculateAndSaveOverlays(i,a){const o=Aa();let u=new Ss((e,t)=>e-t),c=ka();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(i,a).next(e=>{for(const r of e)r.keys().forEach(e=>{var t,n=a.get(e);null!==n&&(t=o.get(e)||Ns.empty(),t=r.applyToLocalView(n,t),o.set(e,t),t=(u.get(r.batchId)||ka()).add(e),u=u.insert(r.batchId,t))})}).next(()=>{const e=[],t=u.getReverseIterator();for(;t.hasNext();){const u=t.getNext(),n=u.key,r=u.value,s=Aa();r.forEach(e=>{var t;c.has(e)||(null!==(t=ca(a.get(e),o.get(e)))&&s.set(e,t),c=c.add(e))}),e.push(this.documentOverlayCache.saveOverlays(i,n,s))}return us.waitFor(e)}).next(()=>o)}recalculateAndSaveOverlaysForDocumentKeys(t,e){return this.remoteDocumentCache.getEntries(t,e).next(e=>this.recalculateAndSaveOverlays(t,e))}getDocumentsMatchingQuery(e,t,n){return r=t,Wr.isDocumentKey(r.path)&&null===r.collectionGroup&&0===r.filters.length?this.getDocumentsMatchingDocumentQuery(e,t.path):Oi(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,n):this.getDocumentsMatchingCollectionQuery(e,t,n);var r}getNextDocuments(i,t,a,o){return this.remoteDocumentCache.getAllFromCollectionGroup(i,t,a,o).next(n=>{const e=0<o-n.size?this.documentOverlayCache.getOverlaysForCollectionGroup(i,t,a.largestBatchId,o-n.size):us.resolve(Aa());let r=-1,s=n;return e.next(e=>us.forEach(e,(t,e)=>(r<e.largestBatchId&&(r=e.largestBatchId),n.get(t)?us.resolve():this.getBaseDocument(i,t,e).next(e=>{s=s.insert(t,e)}))).next(()=>this.populateOverlays(i,e,n)).next(()=>this.computeViews(i,s,e,ka())).next(e=>({batchId:r,changes:Da(e)})))})}getDocumentsMatchingDocumentQuery(e,t){return this.getDocument(e,new Wr(t)).next(e=>{let t=xa();return e.isFoundDocument()&&(t=t.insert(e.key,e)),t})}getDocumentsMatchingCollectionGroupQuery(r,s,i){const a=s.collectionGroup;let o=xa();return this.indexManager.getCollectionParents(r,a).next(e=>us.forEach(e,e=>{var t,n=(t=s,e=e.child(a),new Ni(e,null,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt));return this.getDocumentsMatchingCollectionQuery(r,n,i).next(e=>{e.forEach((e,t)=>{o=o.insert(e,t)})})}).next(()=>o))}getDocumentsMatchingCollectionQuery(t,i,n){let a;return this.remoteDocumentCache.getAllFromCollection(t,i.path,n).next(e=>(a=e,this.documentOverlayCache.getOverlaysForCollection(t,i.path,n.largestBatchId))).next(r=>{r.forEach((e,t)=>{var n=t.getKey();null===a.get(n)&&(a=a.insert(n,ui.newInvalidDocument(n)))});let s=xa();return a.forEach((e,t)=>{var n=r.get(e);void 0!==n&&la(n.mutation,t,Ns.empty(),Kr.now()),ji(i,t)&&(s=s.insert(e,t))}),s})}getBaseDocument(e,t,n){return null===n||1===n.mutation.type?this.remoteDocumentCache.getEntry(e,t):us.resolve(ui.newInvalidDocument(t))}}class ac{constructor(e){this.wt=e,this.Jn=new Map,this.Yn=new Map}getBundleMetadata(e,t){return us.resolve(this.Jn.get(t))}saveBundleMetadata(e,t){return this.Jn.set(t.id,{id:t.id,version:t.version,createTime:Qa(t.createTime)}),us.resolve()}getNamedQuery(e,t){return us.resolve(this.Yn.get(t))}saveNamedQuery(e,t){return this.Yn.set(t.name,{name:(t=t).name,query:tu(t.bundledQuery),readTime:Qa(t.readTime)}),us.resolve()}}class oc{constructor(){this.overlays=new Ss(Wr.comparator),this.Xn=new Map}getOverlay(e,t){return us.resolve(this.overlays.get(t))}getOverlays(e,t){const n=Aa();return us.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&n.set(t,e)})).next(()=>n)}saveOverlays(n,r,e){return e.forEach((e,t)=>{this.ie(n,r,t)}),us.resolve()}removeOverlaysForBatchId(e,t,n){const r=this.Xn.get(n);return void 0!==r&&(r.forEach(e=>this.overlays=this.overlays.remove(e)),this.Xn.delete(n)),us.resolve()}getOverlaysForCollection(e,t,n){const r=Aa(),s=t.length+1,i=new Wr(t.child("")),a=this.overlays.getIteratorFrom(i);for(;a.hasNext();){const e=a.getNext().value,i=e.getKey();if(!t.isPrefixOf(i.path))break;i.path.length===s&&e.largestBatchId>n&&r.set(e.getKey(),e)}return us.resolve(r)}getOverlaysForCollectionGroup(t,e,n,r){let s=new Ss((e,t)=>e-t);const i=this.overlays.getIterator();for(;i.hasNext();){const t=i.getNext().value;if(t.getKey().getCollectionGroup()===e&&t.largestBatchId>n){let e=s.get(t.largestBatchId);null===e&&(e=Aa(),s=s.insert(t.largestBatchId,e)),e.set(t.getKey(),t)}}const a=Aa(),o=s.getIterator();for(;o.hasNext()&&(o.getNext().value.forEach((e,t)=>a.set(e,t)),!(a.size()>=r)););return us.resolve(a)}ie(e,t,n){var r=this.overlays.get(n.key);if(null!==r){const e=this.Xn.get(r.largestBatchId).delete(n.key);this.Xn.set(r.largestBatchId,e)}this.overlays=this.overlays.insert(n.key,new $o(t,n));let s=this.Xn.get(t);void 0===s&&(s=ka(),this.Xn.set(t,s)),this.Xn.set(t,s.add(n.key))}}class uc{constructor(){this.Zn=new Ds(cc.ts),this.es=new Ds(cc.ns)}isEmpty(){return this.Zn.isEmpty()}addReference(e,t){var n=new cc(e,t);this.Zn=this.Zn.add(n),this.es=this.es.add(n)}ss(e,t){e.forEach(e=>this.addReference(e,t))}removeReference(e,t){this.rs(new cc(e,t))}os(e,t){e.forEach(e=>this.removeReference(e,t))}us(e){const t=new Wr(new zr([])),n=new cc(t,e),r=new cc(t,e+1),s=[];return this.es.forEachInRange([n,r],e=>{this.rs(e),s.push(e.key)}),s}cs(){this.Zn.forEach(e=>this.rs(e))}rs(e){this.Zn=this.Zn.delete(e),this.es=this.es.delete(e)}hs(e){var t=new Wr(new zr([])),n=new cc(t,e),t=new cc(t,e+1);let r=ka();return this.es.forEachInRange([n,t],e=>{r=r.add(e.key)}),r}containsKey(e){var t=new cc(e,0),t=this.Zn.firstAfterOrEqual(t);return null!==t&&e.isEqual(t.key)}}class cc{constructor(e,t){this.key=e,this.ls=t}static ts(e,t){return Wr.comparator(e.key,t.key)||Ur(e.ls,t.ls)}static ns(e,t){return Ur(e.ls,t.ls)||Wr.comparator(e.key,t.key)}}class hc{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.fs=1,this.ds=new Ds(cc.ts)}checkEmpty(e){return us.resolve(0===this.mutationQueue.length)}addMutationBatch(e,t,n,r){var s=this.fs;this.fs++,0<this.mutationQueue.length&&this.mutationQueue[this.mutationQueue.length-1];var i=new Ko(s,t,n,r);this.mutationQueue.push(i);for(const t of r)this.ds=this.ds.add(new cc(t.key,s)),this.indexManager.addToCollectionParentIndex(e,t.key.path.popLast());return us.resolve(i)}lookupMutationBatch(e,t){return us.resolve(this._s(t))}getNextMutationBatchAfterBatchId(e,t){var n=this.ws(t+1),n=n<0?0:n;return us.resolve(this.mutationQueue.length>n?this.mutationQueue[n]:null)}getHighestUnacknowledgedBatchId(){return us.resolve(0===this.mutationQueue.length?-1:this.fs-1)}getAllMutationBatches(e){return us.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){const n=new cc(t,0),r=new cc(t,Number.POSITIVE_INFINITY),s=[];return this.ds.forEachInRange([n,r],e=>{var t=this._s(e.ls);s.push(t)}),us.resolve(s)}getAllMutationBatchesAffectingDocumentKeys(e,t){let r=new Ds(Ur);return t.forEach(e=>{var t=new cc(e,0),n=new cc(e,Number.POSITIVE_INFINITY);this.ds.forEachInRange([t,n],e=>{r=r.add(e.ls)})}),us.resolve(this.gs(r))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,r=n.length+1;let s=n;Wr.isDocumentKey(s)||(s=s.child(""));var i=new cc(new Wr(s),0);let a=new Ds(Ur);return this.ds.forEachWhile(e=>{var t=e.key.path;return!!n.isPrefixOf(t)&&(t.length===r&&(a=a.add(e.ls)),!0)},i),us.resolve(this.gs(a))}gs(e){const n=[];return e.forEach(e=>{var t=this._s(e);null!==t&&n.push(t)}),n}removeMutationBatch(n,r){Dr(0===this.ys(r.batchId,"removed")),this.mutationQueue.shift();let s=this.ds;return us.forEach(r.mutations,e=>{var t=new cc(e.key,r.batchId);return s=s.delete(t),this.referenceDelegate.markPotentiallyOrphaned(n,e.key)}).next(()=>{this.ds=s})}In(e){}containsKey(e,t){var n=new cc(t,0),n=this.ds.firstAfterOrEqual(n);return us.resolve(t.isEqual(n&&n.key))}performConsistencyCheck(e){return this.mutationQueue.length,us.resolve()}ys(e,t){return this.ws(e)}ws(e){return 0===this.mutationQueue.length?0:e-this.mutationQueue[0].batchId}_s(e){var t=this.ws(e);return t<0||t>=this.mutationQueue.length?null:this.mutationQueue[t]}}class lc{constructor(e){this.ps=e,this.docs=new Ss(Wr.comparator),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){const n=t.key,r=this.docs.get(n),s=r?r.size:0,i=this.ps(t);return this.docs=this.docs.insert(n,{document:t.mutableCopy(),size:i}),this.size+=i-s,this.indexManager.addToCollectionParentIndex(e,n.path.popLast())}removeEntry(e){var t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){const n=this.docs.get(t);return us.resolve(n?n.document.mutableCopy():ui.newInvalidDocument(t))}getEntries(e,t){let n=Sa;return t.forEach(e=>{const t=this.docs.get(e);n=n.insert(e,t?t.document.mutableCopy():ui.newInvalidDocument(e))}),us.resolve(n)}getAllFromCollection(e,t,n){let r=Sa;const s=new Wr(t.child("")),i=this.docs.getIteratorFrom(s);for(;i.hasNext();){const{key:e,value:{document:s}}=i.getNext();if(!t.isPrefixOf(e.path))break;e.path.length>t.length+1||ss(ns(s),n)<=0||(r=r.insert(s.key,s.mutableCopy()))}return us.resolve(r)}getAllFromCollectionGroup(e,t,n,r){xr()}Is(e,t){return us.forEach(this.docs,e=>t(e))}newChangeBuffer(e){return new dc(this)}getSize(e){return us.resolve(this.size)}}class dc extends Wu{constructor(e){super(),this.zn=e}applyChanges(n){const r=[];return this.changes.forEach((e,t)=>{t.isValidDocument()?r.push(this.zn.addEntry(n,t)):this.zn.removeEntry(e)}),us.waitFor(r)}getFromCache(e,t){return this.zn.getEntry(e,t)}getAllFromCache(e,t){return this.zn.getEntries(e,t)}}class fc{constructor(e){this.persistence=e,this.Ts=new Ta(e=>li(e),di),this.lastRemoteSnapshotVersion=Gr.min(),this.highestTargetId=0,this.Es=0,this.As=new uc,this.targetCount=0,this.Rs=Pu.An()}forEachTarget(e,n){return this.Ts.forEach((e,t)=>n(t)),us.resolve()}getLastRemoteSnapshotVersion(e){return us.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return us.resolve(this.Es)}allocateTargetId(e){return this.highestTargetId=this.Rs.next(),us.resolve(this.highestTargetId)}setTargetsMetadata(e,t,n){return n&&(this.lastRemoteSnapshotVersion=n),t>this.Es&&(this.Es=t),us.resolve()}vn(e){this.Ts.set(e.target,e);var t=e.targetId;t>this.highestTargetId&&(this.Rs=new Pu(t),this.highestTargetId=t),e.sequenceNumber>this.Es&&(this.Es=e.sequenceNumber)}addTargetData(e,t){return this.vn(t),this.targetCount+=1,us.resolve()}updateTargetData(e,t){return this.vn(t),us.resolve()}removeTargetData(e,t){return this.Ts.delete(t.target),this.As.us(t.targetId),--this.targetCount,us.resolve()}removeTargets(n,r,s){let i=0;const a=[];return this.Ts.forEach((e,t)=>{t.sequenceNumber<=r&&null===s.get(t.targetId)&&(this.Ts.delete(e),a.push(this.removeMatchingKeysForTargetId(n,t.targetId)),i++)}),us.waitFor(a).next(()=>i)}getTargetCount(e){return us.resolve(this.targetCount)}getTargetData(e,t){var n=this.Ts.get(t)||null;return us.resolve(n)}addMatchingKeys(e,t,n){return this.As.ss(t,n),us.resolve()}removeMatchingKeys(t,e,n){this.As.os(e,n);const r=this.persistence.referenceDelegate,s=[];return r&&e.forEach(e=>{s.push(r.markPotentiallyOrphaned(t,e))}),us.waitFor(s)}removeMatchingKeysForTargetId(e,t){return this.As.us(t),us.resolve()}getMatchingKeysForTargetId(e,t){var n=this.As.hs(t);return us.resolve(n)}containsKey(e,t){return us.resolve(this.As.containsKey(t))}}class gc{constructor(e,t){this.bs={},this.overlays={},this.Ps=new bs(0),this.vs=!1,this.vs=!0,this.referenceDelegate=e(this),this.Vs=new fc(this),this.indexManager=new bu,this.remoteDocumentCache=(e=e=>this.referenceDelegate.Ss(e),new lc(e)),this.wt=new Qo(t),this.Ds=new ac(this.wt)}start(){return Promise.resolve()}shutdown(){return this.vs=!1,Promise.resolve()}get started(){return this.vs}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new oc,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let n=this.bs[e.toKey()];return n||(n=new hc(t,this.referenceDelegate),this.bs[e.toKey()]=n),n}getTargetCache(){return this.Vs}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Ds}runTransaction(e,t,n){Er("MemoryPersistence","Starting transaction:",e);const r=new mc(this.Ps.next());return this.referenceDelegate.Cs(),n(r).next(e=>this.referenceDelegate.xs(r).next(()=>e)).toPromise().then(e=>(r.raiseOnCommittedEvent(),e))}Ns(t,n){return us.or(Object.values(this.bs).map(e=>()=>e.containsKey(t,n)))}}class mc extends as{constructor(e){super(),this.currentSequenceNumber=e}}class pc{constructor(e){this.persistence=e,this.ks=new uc,this.Os=null}static Ms(e){return new pc(e)}get Fs(){if(this.Os)return this.Os;throw xr()}addReference(e,t,n){return this.ks.addReference(n,t),this.Fs.delete(n.toString()),us.resolve()}removeReference(e,t,n){return this.ks.removeReference(n,t),this.Fs.add(n.toString()),us.resolve()}markPotentiallyOrphaned(e,t){return this.Fs.add(t.toString()),us.resolve()}removeTarget(e,t){this.ks.us(t.targetId).forEach(e=>this.Fs.add(e.toString()));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(e,t.targetId).next(e=>{e.forEach(e=>this.Fs.add(e.toString()))}).next(()=>n.removeTargetData(e,t))}Cs(){this.Os=new Set}xs(n){const r=this.persistence.getRemoteDocumentCache().newChangeBuffer();return us.forEach(this.Fs,e=>{const t=Wr.fromPath(e);return this.$s(n,t).next(e=>{e||r.removeEntry(t,Gr.min())})}).next(()=>(this.Os=null,r.apply(n)))}updateLimboDocument(e,t){return this.$s(e,t).next(e=>{e?this.Fs.delete(t.toString()):this.Fs.add(t.toString())})}Ss(e){return 0}$s(e,t){return us.or([()=>us.resolve(this.ks.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.Ns(e,t)])}}class yc{constructor(e){this.wt=e}O(t,e,n,r){const s=new cs("createOrUpgrade",e);var i;n<1&&1<=r&&(t.createObjectStore("owner"),(i=t).createObjectStore("mutationQueues",{keyPath:"userId"}),i.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",vo,{unique:!0}),i.createObjectStore("documentMutations"),vc(t),t.createObjectStore("remoteDocuments"));let a=us.resolve();return n<3&&3<=r&&(0!==n&&((i=t).deleteObjectStore("targetDocuments"),i.deleteObjectStore("targets"),i.deleteObjectStore("targetGlobal"),vc(t)),a=a.next(()=>function(){const e=s.store("targetGlobal"),t={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:Gr.min().toTimestamp(),targetCount:0};return e.put("targetGlobalKey",t)}())),n<4&&4<=r&&(0!==n&&(a=a.next(()=>function(r,s){return s.store("mutations").K().next(e=>{r.deleteObjectStore("mutations"),r.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",vo,{unique:!0});const t=s.store("mutations"),n=e.map(e=>t.put(e));return us.waitFor(n)})}(t,s))),a=a.next(()=>{t.createObjectStore("clientMetadata",{keyPath:"clientId"})})),n<5&&5<=r&&(a=a.next(()=>this.Bs(s))),n<6&&6<=r&&(a=a.next(()=>(t.createObjectStore("remoteDocumentGlobal"),this.Ls(s)))),n<7&&7<=r&&(a=a.next(()=>this.Us(s))),n<8&&8<=r&&(a=a.next(()=>this.qs(t,s))),n<9&&9<=r&&(a=a.next(()=>{var e;(e=t).objectStoreNames.contains("remoteDocumentChanges")&&e.deleteObjectStore("remoteDocumentChanges")})),n<10&&10<=r&&(a=a.next(()=>this.Ks(s))),n<11&&11<=r&&(a=a.next(()=>{t.createObjectStore("bundles",{keyPath:"bundleId"}),t.createObjectStore("namedQueries",{keyPath:"name"})})),n<12&&12<=r&&(a=a.next(()=>{!function(){const e=t.createObjectStore("documentOverlays",{keyPath:Mo});e.createIndex("collectionPathOverlayIndex",Lo,{unique:!1}),e.createIndex("collectionGroupOverlayIndex",Oo,{unique:!1})}()})),n<13&&13<=r&&(a=a.next(()=>function(){const e=t.createObjectStore("remoteDocumentsV14",{keyPath:Eo});e.createIndex("documentKeyIndex",To),e.createIndex("collectionGroupIndex",So)}()).next(()=>this.Gs(t,s)).next(()=>t.deleteObjectStore("remoteDocuments"))),n<14&&14<=r&&(a=a.next(()=>this.Qs(t,s))),n<15&&15<=r&&(a=a.next(()=>function(e){e.createObjectStore("indexConfiguration",{keyPath:"indexId",autoIncrement:!0}).createIndex("collectionGroupIndex","collectionGroup",{unique:!1}),e.createObjectStore("indexState",{keyPath:Co}).createIndex("sequenceNumberIndex",No,{unique:!1}),e.createObjectStore("indexEntries",{keyPath:ko}).createIndex("documentKeyIndex",Ro,{unique:!1})}(t))),a}Ls(t){let n=0;return t.store("remoteDocuments").J((e,t)=>{n+=Ru(t)}).next(()=>{var e={byteSize:n};return t.store("remoteDocumentGlobal").put("remoteDocumentGlobalKey",e)})}Bs(r){const e=r.store("mutationQueues"),t=r.store("mutations");return e.K().next(e=>us.forEach(e,n=>{var e=IDBKeyRange.bound([n.userId,-1],[n.userId,n.lastAcknowledgedBatchId]);return t.K("userMutationsIndex",e).next(e=>us.forEach(e,e=>{Dr(e.userId===n.userId);var t=Jo(this.wt,e);return ku(r,n.userId,t).next(()=>{})}))}))}Us(e){const a=e.store("targetDocuments"),t=e.store("remoteDocuments");return e.store("targetGlobal").get("targetGlobalKey").next(s=>{const i=[];return t.J((e,t)=>{const n=new zr(e),r=[0,mo(n)];i.push(a.get(r).next(e=>e?us.resolve():(e=>a.put({targetId:0,path:mo(e),sequenceNumber:s.highestListenSequenceNumber}))(n)))}).next(()=>us.waitFor(i))})}qs(e,t){e.createObjectStore("collectionParents",{keyPath:Ao});const n=t.store("collectionParents"),r=new Iu,s=e=>{if(r.add(e)){const t=e.lastSegment(),r=e.popLast();return n.put({collectionId:t,parent:mo(r)})}};return t.store("remoteDocuments").J({H:!0},(e,t)=>{const n=new zr(e);return s(n.popLast())}).next(()=>t.store("documentMutations").J({H:!0},([,e],t)=>{const n=yo(e);return s(n.popLast())}))}Ks(e){const r=e.store("targets");return r.J((e,t)=>{var n=Zo(t),n=eu(this.wt,n);return r.put(n)})}Gs(e,i){const t=i.store("remoteDocuments"),a=[];return t.J((e,t)=>{const n=i.store("remoteDocumentsV14"),r=((s=t).document?new Wr(zr.fromString(s.document.name).popFirst(5)):s.noDocument?Wr.fromSegments(s.noDocument.path):s.unknownDocument?Wr.fromSegments(s.unknownDocument.path):xr()).path.toArray();var s={prefixPath:r.slice(0,r.length-2),collectionGroup:r[r.length-2],documentId:r[r.length-1],readTime:t.readTime||[0,0],unknownDocument:t.unknownDocument,noDocument:t.noDocument,document:t.document,hasCommittedMutations:!!t.hasCommittedMutations};a.push(n.put(s))}).next(()=>us.waitFor(a))}Qs(e,i){const t=i.store("mutations"),a=Xu(this.wt),o=new gc(pc.Ms,this.wt.ne);return t.K().next(e=>{const r=new Map;return e.forEach(e=>{var t;let n=null!==(t=r.get(e.userId))&&void 0!==t?t:ka();Jo(this.wt,e).keys().forEach(e=>n=n.add(e)),r.set(e.userId,n)}),us.forEach(r,(e,t)=>{var n=new vr(t),r=uu.se(this.wt,n),s=o.getIndexManager(n),n=Mu.se(n,this.wt,s,o.referenceDelegate);return new ic(a,n,r,s).recalculateAndSaveOverlaysForDocumentKeys(new qo(i,bs.ot),e).next()})})}}function vc(e){e.createObjectStore("targetDocuments",{keyPath:xo}).createIndex("documentTargetsIndex",Do,{unique:!0}),e.createObjectStore("targets",{keyPath:"targetId"}).createIndex("queryTargetsIndex",_o,{unique:!0}),e.createObjectStore("targetGlobal")}const wc="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class bc{constructor(e,t,n,r,s,i,a,o,u,c,h=14){if(this.allowTabSynchronization=e,this.persistenceKey=t,this.clientId=n,this.js=s,this.window=i,this.document=a,this.Ws=u,this.zs=c,this.Hs=h,this.Ps=null,this.vs=!1,this.isPrimary=!1,this.networkEnabled=!0,this.Js=null,this.inForeground=!1,this.Ys=null,this.Xs=null,this.Zs=Number.NEGATIVE_INFINITY,this.ti=e=>Promise.resolve(),!bc.V())throw new Cr(Ar.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new Qu(this,r),this.ei=t+"main",this.wt=new Qo(o),this.ni=new hs(this.ei,this.Hs,new yc(this.wt)),this.Vs=new Bu(this.referenceDelegate,this.wt),this.remoteDocumentCache=Xu(this.wt),this.Ds=new iu,this.window&&this.window.localStorage?this.si=this.window.localStorage:(this.si=null,!1===c&&Tr("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.ii().then(()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new Cr(Ar.FAILED_PRECONDITION,wc);return this.ri(),this.oi(),this.ui(),this.runTransaction("getHighestListenSequenceNumber","readonly",e=>this.Vs.getHighestSequenceNumber(e))}).then(e=>{this.Ps=new bs(e,this.Ws)}).then(()=>{this.vs=!0}).catch(e=>(this.ni&&this.ni.close(),Promise.reject(e)))}ci(t){return this.ti=async e=>{if(this.started)return t(e)},t(this.isPrimary)}setDatabaseDeletedListener(t){this.ni.F(async e=>{null===e.newVersion&&await t()})}setNetworkEnabled(e){this.networkEnabled!==e&&(this.networkEnabled=e,this.js.enqueueAndForget(async()=>{this.started&&await this.ii()}))}ii(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",t=>Ec(t).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next(()=>{if(this.isPrimary)return this.ai(t).next(e=>{e||(this.isPrimary=!1,this.js.enqueueRetryable(()=>this.ti(!1)))})}).next(()=>this.hi(t)).next(e=>this.isPrimary&&!e?this.li(t).next(()=>!1):!!e&&this.fi(t).next(()=>!0))).catch(e=>{if(fs(e))return Er("IndexedDbPersistence","Failed to extend owner lease: ",e),this.isPrimary;if(!this.allowTabSynchronization)throw e;return Er("IndexedDbPersistence","Releasing owner lease after error during lease refresh",e),!1}).then(e=>{this.isPrimary!==e&&this.js.enqueueRetryable(()=>this.ti(e)),this.isPrimary=e})}ai(e){return Ic(e).get("owner").next(e=>us.resolve(this.di(e)))}_i(e){return Ec(e).delete(this.clientId)}async wi(){if(this.isPrimary&&!this.mi(this.Zs,18e5)){this.Zs=Date.now();var e=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",e=>{const r=jo(e,"clientMetadata");return r.K().next(e=>{const t=this.gi(e,18e5),n=e.filter(e=>-1===t.indexOf(e));return us.forEach(n,e=>r.delete(e.clientId)).next(()=>n)})}).catch(()=>[]);if(this.si)for(const t of e)this.si.removeItem(this.yi(t.clientId))}}ui(){this.Xs=this.js.enqueueAfterDelay("client_metadata_refresh",4e3,()=>this.ii().then(()=>this.wi()).then(()=>this.ui()))}di(e){return!!e&&e.ownerId===this.clientId}hi(t){return this.zs?us.resolve(!0):Ic(t).get("owner").next(e=>{if(null!==e&&this.mi(e.leaseTimestampMs,5e3)&&!this.pi(e.ownerId)){if(this.di(e)&&this.networkEnabled)return!0;if(!this.di(e)){if(!e.allowTabSynchronization)throw new Cr(Ar.FAILED_PRECONDITION,wc);return!1}}return!(!this.networkEnabled||!this.inForeground)||Ec(t).K().next(e=>void 0===this.gi(e,5e3).find(e=>{if(this.clientId!==e.clientId){var t=!this.networkEnabled&&e.networkEnabled,n=!this.inForeground&&e.inForeground,r=this.networkEnabled===e.networkEnabled;if(t||n&&r)return!0}return!1}))}).next(e=>(this.isPrimary!==e&&Er("IndexedDbPersistence",`Client ${e?"is":"is not"} eligible for a primary lease.`),e))}async shutdown(){this.vs=!1,this.Ii(),this.Xs&&(this.Xs.cancel(),this.Xs=null),this.Ti(),this.Ei(),await this.ni.runTransaction("shutdown","readwrite",["owner","clientMetadata"],e=>{const t=new qo(e,bs.ot);return this.li(t).next(()=>this._i(t))}),this.ni.close(),this.Ai()}gi(e,t){return e.filter(e=>this.mi(e.updateTimeMs,t)&&!this.pi(e.clientId))}Ri(){return this.runTransaction("getActiveClients","readonly",e=>Ec(e).K().next(e=>this.gi(e,18e5).map(e=>e.clientId)))}get started(){return this.vs}getMutationQueue(e,t){return Mu.se(e,this.wt,t,this.referenceDelegate)}getTargetCache(){return this.Vs}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(e){return new Tu(e,this.wt.ne.databaseId)}getDocumentOverlayCache(e){return uu.se(this.wt,e)}getBundleCache(){return this.Ds}runTransaction(t,n,r){Er("IndexedDbPersistence","Starting transaction:",t);var e,s="readonly"===n?"readonly":"readwrite",e=15===(e=this.Hs)?Uo:14===e?Bo:13===e?Po:12===e?Fo:11===e?Vo:void xr();let i;return this.ni.runTransaction(t,s,e,e=>(i=new qo(e,this.Ps?this.Ps.next():bs.ot),"readwrite-primary"===n?this.ai(i).next(e=>!!e||this.hi(i)).next(e=>{if(!e)throw Tr(`Failed to obtain primary lease for action '${t}'.`),this.isPrimary=!1,this.js.enqueueRetryable(()=>this.ti(!1)),new Cr(Ar.FAILED_PRECONDITION,is);return r(i)}).next(e=>this.fi(i).next(()=>e)):this.bi(i).next(()=>r(i)))).then(e=>(i.raiseOnCommittedEvent(),e))}bi(e){return Ic(e).get("owner").next(e=>{if(null!==e&&this.mi(e.leaseTimestampMs,5e3)&&!this.pi(e.ownerId)&&!this.di(e)&&!(this.zs||this.allowTabSynchronization&&e.allowTabSynchronization))throw new Cr(Ar.FAILED_PRECONDITION,wc)})}fi(e){var t={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return Ic(e).put("owner",t)}static V(){return hs.V()}li(e){const t=Ic(e);return t.get("owner").next(e=>this.di(e)?(Er("IndexedDbPersistence","Releasing primary lease."),t.delete("owner")):us.resolve())}mi(e,t){var n=Date.now();return!(e<n-t||n<e&&(Tr(`Detected an update time that is in the future: ${e} > ${n}`),1))}ri(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.Ys=()=>{this.js.enqueueAndForget(()=>(this.inForeground="visible"===this.document.visibilityState,this.ii()))},this.document.addEventListener("visibilitychange",this.Ys),this.inForeground="visible"===this.document.visibilityState)}Ti(){this.Ys&&(this.document.removeEventListener("visibilitychange",this.Ys),this.Ys=null)}oi(){var e;"function"==typeof(null===(e=this.window)||void 0===e?void 0:e.addEventListener)&&(this.Js=()=>{this.Ii(),s()&&navigator.appVersion.match(/Version\/1[45]/)&&this.js.enterRestrictedMode(!0),this.js.enqueueAndForget(()=>this.shutdown())},this.window.addEventListener("pagehide",this.Js))}Ei(){this.Js&&(this.window.removeEventListener("pagehide",this.Js),this.Js=null)}pi(e){var t;try{var n=null!==(null===(t=this.si)||void 0===t?void 0:t.getItem(this.yi(e)));return Er("IndexedDbPersistence",`Client '${e}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(e){return Tr("IndexedDbPersistence","Failed to get zombied client id.",e),!1}}Ii(){if(this.si)try{this.si.setItem(this.yi(this.clientId),String(Date.now()))}catch(e){Tr("Failed to set zombie client id.",e)}}Ai(){if(this.si)try{this.si.removeItem(this.yi(this.clientId))}catch(e){}}yi(e){return`firestore_zombie_${this.persistenceKey}_${e}`}}function Ic(e){return jo(e,"owner")}function Ec(e){return jo(e,"clientMetadata")}function Tc(e,t){let n=e.projectId;return e.isDefaultDatabase||(n+="."+e.database),"firestore/"+t+"/"+n+"/"}class Sc{constructor(e,t,n,r){this.targetId=e,this.fromCache=t,this.Pi=n,this.vi=r}static Vi(e,t){let n=ka(),r=ka();for(const e of t.docChanges)switch(e.type){case 0:n=n.add(e.doc.key);break;case 1:r=r.add(e.doc.key)}return new Sc(e,t.fromCache,n,r)}}class _c{constructor(){this.Si=!1}initialize(e,t){this.Di=e,this.indexManager=t,this.Si=!0}getDocumentsMatchingQuery(t,n,r,s){return this.Ci(t,n).next(e=>e||this.xi(t,n,s,r)).next(e=>e||this.Ni(t,n))}Ci(e,t){return us.resolve(null)}xi(n,r,s,i){return 0===(e=r).filters.length&&null===e.limit&&null==e.startAt&&null==e.endAt&&(0===e.explicitOrderBy.length||1===e.explicitOrderBy.length&&e.explicitOrderBy[0].field.isKeyField())||i.isEqual(Gr.min())?this.Ni(n,r):this.Di.getDocuments(n,s).next(e=>{var t=this.ki(r,e);return this.Oi(r,t,s,i)?this.Ni(n,r):(Ir()<=l.DEBUG&&Er("QueryEngine","Re-using previous result from %s to execute query: %s",i.toString(),qi(r)),this.Mi(n,t,r,ts(i,-1)))});var e}ki(n,e){let r=new Ds(Gi(n));return e.forEach((e,t)=>{ji(n,t)&&(r=r.add(t))}),r}Oi(e,t,n,r){if(null===e.limit)return!1;if(n.size!==t.size)return!0;const s="F"===e.limitType?t.last():t.first();return!!s&&(s.hasPendingWrites||0<s.version.compareTo(r))}Ni(e,t){return Ir()<=l.DEBUG&&Er("QueryEngine","Using full collection scan to execute query:",qi(t)),this.Di.getDocumentsMatchingQuery(e,t,rs.min())}Mi(e,n,t,r){return this.Di.getDocumentsMatchingQuery(e,t,r).next(t=>(n.forEach(e=>{t=t.insert(e.key,e)}),t))}}class xc{constructor(e,t,n,r){this.persistence=e,this.Fi=t,this.wt=r,this.$i=new Ss(Ur),this.Bi=new Ta(e=>li(e),di),this.Li=new Map,this.Ui=e.getRemoteDocumentCache(),this.Vs=e.getTargetCache(),this.Ds=e.getBundleCache(),this.qi(n)}qi(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new ic(this.Ui,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.Ui.setIndexManager(this.indexManager),this.Fi.initialize(this.localDocuments,this.indexManager)}collectGarbage(t){return this.persistence.runTransaction("Collect garbage","readwrite-primary",e=>t.collect(e,this.$i))}}function Dc(e,t,n,r){return new xc(e,t,n,r)}async function Ac(e,t){const a=e;return a.persistence.runTransaction("Handle user change","readonly",s=>{let i;return a.mutationQueue.getAllMutationBatches(s).next(e=>(i=e,a.qi(t),a.mutationQueue.getAllMutationBatches(s))).next(e=>{const t=[],n=[];let r=ka();for(const s of i){t.push(s.batchId);for(const e of s.mutations)r=r.add(e.key)}for(const s of e){n.push(s.batchId);for(const e of s.mutations)r=r.add(e.key)}return a.localDocuments.getDocuments(s,r).next(e=>({Ki:e,removedBatchIds:t,addedBatchIds:n}))})})}function Cc(e){const t=e;return t.persistence.runTransaction("Get last remote snapshot version","readonly",e=>t.Vs.getLastRemoteSnapshotVersion(e))}function Nc(e,c){const h=e,l=c.snapshotVersion;let d=h.$i;return h.persistence.runTransaction("Apply remote event","readwrite-primary",o=>{const e=h.Ui.newChangeBuffer({trackRemovals:!0});d=h.$i;const u=[];c.targetChanges.forEach((t,n)=>{const r=d.get(n);if(r){u.push(h.Vs.removeMatchingKeys(o,t.removedDocuments,n).next(()=>h.Vs.addMatchingKeys(o,t.addedDocuments,n)));let e=r.withSequenceNumber(o.currentSequenceNumber);var s,i,a;c.targetMismatches.has(n)?e=e.withResumeToken(ks.EMPTY_BYTE_STRING,Gr.min()).withLastLimboFreeSnapshotVersion(Gr.min()):0<t.resumeToken.approximateByteSize()&&(e=e.withResumeToken(t.resumeToken,l)),d=d.insert(n,e),s=r,i=e,a=t,0!==s.resumeToken.approximateByteSize()&&!(3e8<=i.snapshotVersion.toMicroseconds()-s.snapshotVersion.toMicroseconds()||0<a.addedDocuments.size+a.modifiedDocuments.size+a.removedDocuments.size)||u.push(h.Vs.updateTargetData(o,e))}});let t=Sa,n=ka();if(c.documentUpdates.forEach(e=>{c.resolvedLimboDocuments.has(e)&&u.push(h.persistence.referenceDelegate.updateLimboDocument(o,e))}),u.push(kc(o,e,c.documentUpdates).next(e=>{t=e.Gi,n=e.Qi})),!l.isEqual(Gr.min())){const c=h.Vs.getLastRemoteSnapshotVersion(o).next(e=>h.Vs.setTargetsMetadata(o,o.currentSequenceNumber,l));u.push(c)}return us.waitFor(u).next(()=>e.apply(o)).next(()=>h.localDocuments.getLocalViewOfDocuments(o,t,n)).next(()=>t)}).then(e=>(h.$i=d,e))}function kc(e,i,t){let n=ka(),a=ka();return t.forEach(e=>n=n.add(e)),i.getEntries(e,n).next(r=>{let s=Sa;return t.forEach((e,t)=>{const n=r.get(e);t.isFoundDocument()!==n.isFoundDocument()&&(a=a.add(e)),t.isNoDocument()&&t.version.isEqual(Gr.min())?(i.removeEntry(e,t.readTime),s=s.insert(e,t)):!n.isValidDocument()||0<t.version.compareTo(n.version)||0===t.version.compareTo(n.version)&&n.hasPendingWrites?(i.addEntry(t),s=s.insert(e,t)):Er("LocalStore","Ignoring outdated watch update for ",e,". Current version:",n.version," Watch version:",t.version)}),{Gi:s,Qi:a}})}function Rc(e,r){const s=e;return s.persistence.runTransaction("Allocate target","readwrite",t=>{let n;return s.Vs.getTargetData(t,r).next(e=>e?(n=e,us.resolve(n)):s.Vs.allocateTargetId(t).next(e=>(n=new zo(r,e,0,t.currentSequenceNumber),s.Vs.addTargetData(t,n).next(()=>n))))}).then(e=>{var t=s.$i.get(e.targetId);return(null===t||0<e.snapshotVersion.compareTo(t.snapshotVersion))&&(s.$i=s.$i.insert(e.targetId,e),s.Bi.set(r,e.targetId)),e})}async function Mc(e,t,n){const r=e,s=r.$i.get(t),i=n?"readwrite":"readwrite-primary";try{n||await r.persistence.runTransaction("Release target",i,e=>r.persistence.referenceDelegate.removeTarget(e,s))}catch(e){if(!fs(e))throw e;Er("LocalStore",`Failed to update sequence numbers for target ${t}: ${e}`)}r.$i=r.$i.remove(t),r.Bi.delete(s.target)}function Lc(e,n,r){const s=e;let i=Gr.min(),a=ka();return s.persistence.runTransaction("Execute query","readonly",t=>function(e,t,n){const r=e,s=r.Bi.get(n);return void 0!==s?us.resolve(r.$i.get(s)):r.Vs.getTargetData(t,n)}(s,t,Fi(n)).next(e=>{if(e)return i=e.lastLimboFreeSnapshotVersion,s.Vs.getMatchingKeysForTargetId(t,e.targetId).next(e=>{a=e})}).next(()=>s.Fi.getDocumentsMatchingQuery(t,n,r?i:Gr.min(),r?a:ka())).next(e=>(Fc(s,Ki(n),e),{documents:e,ji:a})))}function Oc(e,t){const n=e,r=n.Vs,s=n.$i.get(t);return s?Promise.resolve(s.target):n.persistence.runTransaction("Get target data","readonly",e=>r.te(e,t).next(e=>e?e.target:null))}function Vc(e,t){const n=e,r=n.Li.get(t)||Gr.min();return n.persistence.runTransaction("Get new document changes","readonly",e=>n.Ui.getAllFromCollectionGroup(e,t,ts(r,-1),Number.MAX_SAFE_INTEGER)).then(e=>(Fc(n,t,e),e))}function Fc(e,t,n){let r=Gr.min();n.forEach((e,t)=>{0<t.readTime.compareTo(r)&&(r=t.readTime)}),e.Li.set(t,r)}function Pc(e,t){return`firestore_clients_${e}_${t}`}function Bc(e,t,n){let r=`firestore_mutations_${e}_${n}`;return t.isAuthenticated()&&(r+=`_${t.uid}`),r}function Uc(e,t){return`firestore_targets_${e}_${t}`}class qc{constructor(e,t,n,r){this.user=e,this.batchId=t,this.state=n,this.error=r}static Ji(e,t,n){var r=JSON.parse(n);let s,i="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error);return i&&r.error&&(i="string"==typeof r.error.message&&"string"==typeof r.error.code,i&&(s=new Cr(r.error.code,r.error.message))),i?new qc(e,t,r.state,s):(Tr("SharedClientState",`Failed to parse mutation state for ID '${t}': ${n}`),null)}Yi(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class jc{constructor(e,t,n){this.targetId=e,this.state=t,this.error=n}static Ji(e,t){var n=JSON.parse(t);let r,s="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return s&&n.error&&(s="string"==typeof n.error.message&&"string"==typeof n.error.code,s&&(r=new Cr(n.error.code,n.error.message))),s?new jc(e,n.state,r):(Tr("SharedClientState",`Failed to parse target state for ID '${e}': ${t}`),null)}Yi(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class Kc{constructor(e,t){this.clientId=e,this.activeTargetIds=t}static Ji(e,t){var n=JSON.parse(t);let r="object"==typeof n&&n.activeTargetIds instanceof Array,s=Ra;for(let i=0;r&&i<n.activeTargetIds.length;++i)r=js(n.activeTargetIds[i]),s=s.add(n.activeTargetIds[i]);return r?new Kc(e,s):(Tr("SharedClientState",`Failed to parse client data for instance '${e}': ${t}`),null)}}class Gc{constructor(e,t){this.clientId=e,this.onlineState=t}static Ji(e){var t=JSON.parse(e);return"object"==typeof t&&-1!==["Unknown","Online","Offline"].indexOf(t.onlineState)&&"string"==typeof t.clientId?new Gc(t.clientId,t.onlineState):(Tr("SharedClientState",`Failed to parse online state: ${e}`),null)}}class $c{constructor(){this.activeTargetIds=Ra}Xi(e){this.activeTargetIds=this.activeTargetIds.add(e)}Zi(e){this.activeTargetIds=this.activeTargetIds.delete(e)}Yi(){var e={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(e)}}class zc{constructor(e,t,n,r,s){this.window=e,this.js=t,this.persistenceKey=n,this.tr=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.er=this.nr.bind(this),this.sr=new Ss(Ur),this.started=!1,this.ir=[];var i=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=s,this.rr=Pc(this.persistenceKey,this.tr),this.ur=`firestore_sequence_number_${this.persistenceKey}`,this.sr=this.sr.insert(this.tr,new $c),this.cr=new RegExp(`^firestore_clients_${i}_([^_]*)$`),this.ar=new RegExp(`^firestore_mutations_${i}_(\\d+)(?:_(.*))?$`),this.hr=new RegExp(`^firestore_targets_${i}_(\\d+)$`),this.lr=`firestore_online_state_${this.persistenceKey}`,this.dr=`firestore_bundle_loaded_v2_${this.persistenceKey}`,this.window.addEventListener("storage",this.er)}static V(e){return!(!e||!e.localStorage)}async start(){const e=await this.syncEngine.Ri();for(const n of e)if(n!==this.tr){const e=this.getItem(Pc(this.persistenceKey,n));var t;!e||(t=Kc.Ji(n,e))&&(this.sr=this.sr.insert(t.clientId,t))}this._r();const n=this.storage.getItem(this.lr);if(n){const e=this.wr(n);e&&this.mr(e)}for(const e of this.ir)this.nr(e);this.ir=[],this.window.addEventListener("pagehide",()=>this.shutdown()),this.started=!0}writeSequenceNumber(e){this.setItem(this.ur,JSON.stringify(e))}getAllActiveQueryTargets(){return this.gr(this.sr)}isActiveQueryTarget(n){let r=!1;return this.sr.forEach((e,t)=>{t.activeTargetIds.has(n)&&(r=!0)}),r}addPendingMutation(e){this.yr(e,"pending")}updateMutationState(e,t,n){this.yr(e,t,n),this.pr(e)}addLocalQueryTarget(e){let t="not-current";var n;return this.isActiveQueryTarget(e)&&(!(n=this.storage.getItem(Uc(this.persistenceKey,e)))||(n=jc.Ji(e,n))&&(t=n.state)),this.Ir.Xi(e),this._r(),t}removeLocalQueryTarget(e){this.Ir.Zi(e),this._r()}isLocalQueryTarget(e){return this.Ir.activeTargetIds.has(e)}clearQueryState(e){this.removeItem(Uc(this.persistenceKey,e))}updateQueryState(e,t,n){this.Tr(e,t,n)}handleUserChange(e,t,n){t.forEach(e=>{this.pr(e)}),this.currentUser=e,n.forEach(e=>{this.addPendingMutation(e)})}setOnlineState(e){this.Er(e)}notifyBundleLoaded(e){this.Ar(e)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.er),this.removeItem(this.rr),this.started=!1)}getItem(e){var t=this.storage.getItem(e);return Er("SharedClientState","READ",e,t),t}setItem(e,t){Er("SharedClientState","SET",e,t),this.storage.setItem(e,t)}removeItem(e){Er("SharedClientState","REMOVE",e),this.storage.removeItem(e)}nr(e){const s=e;s.storageArea===this.storage&&(Er("SharedClientState","EVENT",s.key,s.newValue),s.key!==this.rr?this.js.enqueueRetryable(async()=>{if(this.started){if(null!==s.key)if(this.cr.test(s.key)){if(null==s.newValue){var e=this.Rr(s.key);return this.br(e,null)}e=this.Pr(s.key,s.newValue);if(e)return this.br(e.clientId,e)}else if(this.ar.test(s.key)){if(null!==s.newValue){var t=this.vr(s.key,s.newValue);if(t)return this.Vr(t)}}else if(this.hr.test(s.key)){if(null!==s.newValue){t=this.Sr(s.key,s.newValue);if(t)return this.Dr(t)}}else if(s.key===this.lr){if(null!==s.newValue){var n=this.wr(s.newValue);if(n)return this.mr(n)}}else if(s.key===this.ur){n=function(e){let t=bs.ot;if(null!=e)try{var n=JSON.parse(e);Dr("number"==typeof n),t=n}catch(e){Tr("SharedClientState","Failed to read sequence number from WebStorage",e)}return t}(s.newValue);n!==bs.ot&&this.sequenceNumberHandler(n)}else if(s.key===this.dr){const r=this.Cr(s.newValue);await Promise.all(r.map(e=>this.syncEngine.Nr(e)))}}else this.ir.push(s)}):Tr("Received WebStorage notification for local change. Another client might have garbage-collected our state"))}get Ir(){return this.sr.get(this.tr)}_r(){this.setItem(this.rr,this.Ir.Yi())}yr(e,t,n){const r=new qc(this.currentUser,e,t,n),s=Bc(this.persistenceKey,this.currentUser,e);this.setItem(s,r.Yi())}pr(e){var t=Bc(this.persistenceKey,this.currentUser,e);this.removeItem(t)}Er(e){var t={clientId:this.tr,onlineState:e};this.storage.setItem(this.lr,JSON.stringify(t))}Tr(e,t,n){const r=Uc(this.persistenceKey,e),s=new jc(e,t,n);this.setItem(r,s.Yi())}Ar(e){var t=JSON.stringify(Array.from(e));this.setItem(this.dr,t)}Rr(e){var t=this.cr.exec(e);return t?t[1]:null}Pr(e,t){var n=this.Rr(e);return Kc.Ji(n,t)}vr(e,t){var n=this.ar.exec(e),r=Number(n[1]),n=void 0!==n[2]?n[2]:null;return qc.Ji(new vr(n),r,t)}Sr(e,t){var n=this.hr.exec(e),n=Number(n[1]);return jc.Ji(n,t)}wr(e){return Gc.Ji(e)}Cr(e){return JSON.parse(e)}async Vr(e){if(e.user.uid===this.currentUser.uid)return this.syncEngine.kr(e.batchId,e.state,e.error);Er("SharedClientState",`Ignoring mutation for non-active user ${e.user.uid}`)}Dr(e){return this.syncEngine.Or(e.targetId,e.state,e.error)}br(e,t){const n=t?this.sr.insert(e,t):this.sr.remove(e),r=this.gr(this.sr),s=this.gr(n),i=[],a=[];return s.forEach(e=>{r.has(e)||i.push(e)}),r.forEach(e=>{s.has(e)||a.push(e)}),this.syncEngine.Mr(i,a).then(()=>{this.sr=n})}mr(e){this.sr.get(e.clientId)&&this.onlineStateHandler(e.onlineState)}gr(e){let n=Ra;return e.forEach((e,t)=>{n=n.unionWith(t.activeTargetIds)}),n}}class Qc{constructor(){this.Fr=new $c,this.$r={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,n){}addLocalQueryTarget(e){return this.Fr.Xi(e),this.$r[e]||"not-current"}updateQueryState(e,t,n){this.$r[e]=t}removeLocalQueryTarget(e){this.Fr.Zi(e)}isLocalQueryTarget(e){return this.Fr.activeTargetIds.has(e)}clearQueryState(e){delete this.$r[e]}getAllActiveQueryTargets(){return this.Fr.activeTargetIds}isActiveQueryTarget(e){return this.Fr.activeTargetIds.has(e)}start(){return this.Fr=new $c,Promise.resolve()}handleUserChange(e,t,n){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}}class Hc{Br(e){}shutdown(){}}class Wc{constructor(){this.Lr=()=>this.Ur(),this.qr=()=>this.Kr(),this.Gr=[],this.Qr()}Br(e){this.Gr.push(e)}shutdown(){window.removeEventListener("online",this.Lr),window.removeEventListener("offline",this.qr)}Qr(){window.addEventListener("online",this.Lr),window.addEventListener("offline",this.qr)}Ur(){Er("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const e of this.Gr)e(0)}Kr(){Er("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const e of this.Gr)e(1)}static V(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}const Yc={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery"};class Xc{constructor(e){this.jr=e.jr,this.Wr=e.Wr}zr(e){this.Hr=e}Jr(e){this.Yr=e}onMessage(e){this.Xr=e}close(){this.Wr()}send(e){this.jr(e)}Zr(){this.Hr()}eo(e){this.Yr(e)}no(e){this.Xr(e)}}class Jc extends class{constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;var t=e.ssl?"https":"http";this.so=t+"://"+e.host,this.io="projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database+"/documents"}ro(t,e,n,r,s){const i=this.oo(t,e);Er("RestConnection","Sending: ",i,n);var a={};return this.uo(a,r,s),this.co(t,i,a,n).then(e=>(Er("RestConnection","Received: ",e),e),e=>{throw Sr("RestConnection",`${t} failed with error: `,e,"url: ",i,"request:",n),e})}ao(e,t,n,r,s){return this.ro(e,t,n,r,s)}uo(n,e,t){n["X-Goog-Api-Client"]="gl-js/ fire/"+wr,n["Content-Type"]="text/plain",this.databaseInfo.appId&&(n["X-Firebase-GMPID"]=this.databaseInfo.appId),e&&e.headers.forEach((e,t)=>n[t]=e),t&&t.headers.forEach((e,t)=>n[t]=e)}oo(e,t){var n=Yc[e];return`${this.so}/v1/${t}:${n}`}}{constructor(e){super(e),this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams}co(o,t,n,r){return new Promise((s,i)=>{const a=new pr;a.listenOnce(hr.COMPLETE,()=>{try{switch(a.getLastErrorCode()){case cr.NO_ERROR:var e=a.getResponseJson();Er("Connection","XHR received:",JSON.stringify(e)),s(e);break;case cr.TIMEOUT:Er("Connection",'RPC "'+o+'" timed out'),i(new Cr(Ar.DEADLINE_EXCEEDED,"Request time out"));break;case cr.HTTP_ERROR:var t,n=a.getStatus();if(Er("Connection",'RPC "'+o+'" failed with status:',n,"response text:",a.getResponseText()),0<n){const o=a.getResponseJson().error;o&&o.status&&o.message?(r=o.status.toLowerCase().replace(/_/g,"-"),t=0<=Object.values(Ar).indexOf(r)?r:Ar.UNKNOWN,i(new Cr(t,o.message))):i(new Cr(Ar.UNKNOWN,"Server responded with status "+a.getStatus()))}else i(new Cr(Ar.UNAVAILABLE,"Connection failed."));break;default:xr()}}finally{Er("Connection",'RPC "'+o+'" completed.')}var r});var e=JSON.stringify(r);a.send(t,"POST",e,n,15)})}ho(e,t,n){const r=[this.so,"/","google.firestore.v1.Firestore","/",e,"/channel"],s=new nr,i=ur(),a={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling};this.useFetchStreams&&(a.xmlHttpFactory=new gr({})),this.uo(a.initMessageHeaders,t,n),"undefined"!=typeof window&&(window.cordova||window.phonegap||window.PhoneGap)&&/ios|iphone|ipod|ipad|android|blackberry|iemobile/i.test(f())||"object"==typeof navigator&&"ReactNative"===navigator.product||0<=f().indexOf("Electron/")||function(){const e=f();return 0<=e.indexOf("MSIE ")||0<=e.indexOf("Trident/")}()||0<=f().indexOf("MSAppHost/")||"object"==typeof(o="object"==typeof chrome?chrome.runtime:"object"==typeof browser?browser.runtime:void 0)&&void 0!==o.id||(a.httpHeadersOverwriteParam="$httpHeaders");var o=r.join("");Er("Connection","Creating WebChannel: "+o,a);const u=s.createWebChannel(o,a);let c=!1,h=!1;const l=new Xc({jr:e=>{h?Er("Connection","Not sending because WebChannel is closed:",e):(c||(Er("Connection","Opening WebChannel transport."),u.open(),c=!0),Er("Connection","WebChannel sending:",e),u.send(e))},Wr:()=>u.close()}),d=(e,t,n)=>{e.listen(t,e=>{try{n(e)}catch(e){setTimeout(()=>{throw e},0)}})};return d(u,mr.EventType.OPEN,()=>{h||Er("Connection","WebChannel transport opened.")}),d(u,mr.EventType.CLOSE,()=>{h||(h=!0,Er("Connection","WebChannel transport closed"),l.eo())}),d(u,mr.EventType.ERROR,e=>{h||(h=!0,Sr("Connection","WebChannel transport errored:",e),l.eo(new Cr(Ar.UNAVAILABLE,"The operation could not be completed")))}),d(u,mr.EventType.MESSAGE,n=>{if(!h){var e=n.data[0];Dr(!!e);var r=e.error||(null===(r=e[0])||void 0===r?void 0:r.error);if(r){Er("Connection","WebChannel received error:",r);const n=r.status;let e=function(e){var t=or[e];if(void 0!==t)return Ea(t)}(n),t=r.message;void 0===e&&(e=Ar.INTERNAL,t="Unknown error status: "+n+" with message "+r.message),h=!0,l.eo(new Cr(e,t)),u.close()}else Er("Connection","WebChannel received:",e),l.no(e)}}),d(i,lr.STAT_EVENT,e=>{e.stat===dr?Er("Connection","Detected buffering proxy"):e.stat===fr&&Er("Connection","Detected no buffering proxy")}),setTimeout(()=>{l.Zr()},0),l}}function Zc(){return"undefined"!=typeof window?window:null}function eh(){return"undefined"!=typeof document?document:null}function th(e){return new Ga(e,!0)}class nh{constructor(e,t,n=1e3,r=1.5,s=6e4){this.js=e,this.timerId=t,this.lo=n,this.fo=r,this._o=s,this.wo=0,this.mo=null,this.yo=Date.now(),this.reset()}reset(){this.wo=0}po(){this.wo=this._o}Io(e){this.cancel();var t=Math.floor(this.wo+this.To()),n=Math.max(0,Date.now()-this.yo),r=Math.max(0,t-n);0<r&&Er("ExponentialBackoff",`Backing off for ${r} ms (base delay: ${this.wo} ms, delay with jitter: ${t} ms, last attempt: ${n} ms ago)`),this.mo=this.js.enqueueAfterDelay(this.timerId,r,()=>(this.yo=Date.now(),e())),this.wo*=this.fo,this.wo<this.lo&&(this.wo=this.lo),this.wo>this._o&&(this.wo=this._o)}Eo(){null!==this.mo&&(this.mo.skipDelay(),this.mo=null)}cancel(){null!==this.mo&&(this.mo.cancel(),this.mo=null)}To(){return(Math.random()-.5)*this.wo}}class rh{constructor(e,t,n,r,s,i,a,o){this.js=e,this.Ao=n,this.Ro=r,this.bo=s,this.authCredentialsProvider=i,this.appCheckCredentialsProvider=a,this.listener=o,this.state=0,this.Po=0,this.vo=null,this.Vo=null,this.stream=null,this.So=new nh(e,t)}Do(){return 1===this.state||5===this.state||this.Co()}Co(){return 2===this.state||3===this.state}start(){4!==this.state?this.auth():this.xo()}async stop(){this.Do()&&await this.close(0)}No(){this.state=0,this.So.reset()}ko(){this.Co()&&null===this.vo&&(this.vo=this.js.enqueueAfterDelay(this.Ao,6e4,()=>this.Oo()))}Mo(e){this.Fo(),this.stream.send(e)}async Oo(){if(this.Co())return this.close(0)}Fo(){this.vo&&(this.vo.cancel(),this.vo=null)}$o(){this.Vo&&(this.Vo.cancel(),this.Vo=null)}async close(e,t){this.Fo(),this.$o(),this.So.cancel(),this.Po++,4!==e?this.So.reset():t&&t.code===Ar.RESOURCE_EXHAUSTED?(Tr(t.toString()),Tr("Using maximum backoff delay to prevent overloading the backend."),this.So.po()):t&&t.code===Ar.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.Bo(),this.stream.close(),this.stream=null),this.state=e,await this.listener.Jr(t)}Bo(){}auth(){this.state=1;const e=this.Lo(this.Po),n=this.Po;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([e,t])=>{this.Po===n&&this.Uo(e,t)},t=>{e(()=>{var e=new Cr(Ar.UNKNOWN,"Fetching auth token failed: "+t.message);return this.qo(e)})})}Uo(e,t){const n=this.Lo(this.Po);this.stream=this.Ko(e,t),this.stream.zr(()=>{n(()=>(this.state=2,this.Vo=this.js.enqueueAfterDelay(this.Ro,1e4,()=>(this.Co()&&(this.state=3),Promise.resolve())),this.listener.zr()))}),this.stream.Jr(e=>{n(()=>this.qo(e))}),this.stream.onMessage(e=>{n(()=>this.onMessage(e))})}xo(){this.state=5,this.So.Io(async()=>{this.state=0,this.start()})}qo(e){return Er("PersistentStream",`close with error: ${e}`),this.stream=null,this.close(4,e)}Lo(t){return e=>{this.js.enqueueAndForget(()=>this.Po===t?e():(Er("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}}class sh extends rh{constructor(e,t,n,r,s,i){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,n,r,i),this.wt=s}Ko(e,t){return this.bo.ho("Listen",e,t)}onMessage(e){this.So.reset();var t=function(e,t){let n;if("targetChange"in t){t.targetChange;var r="NO_CHANGE"===(f=t.targetChange.targetChangeType||"NO_CHANGE")?0:"ADD"===f?1:"REMOVE"===f?2:"CURRENT"===f?3:"RESET"===f?4:xr(),s=t.targetChange.targetIds||[],i=(f=t.targetChange.resumeToken,e.dt?(Dr(void 0===f||"string"==typeof f),ks.fromBase64String(f||"")):(Dr(void 0===f||f instanceof Uint8Array),ks.fromUint8Array(f||new Uint8Array))),a=t.targetChange.cause,o=a&&(o=void 0===(f=a).code?Ar.UNKNOWN:Ea(f.code),new Cr(o,f.message||""));n=new Fa(r,s,i,o||null)}else if("documentChange"in t){t.documentChange;var u=t.documentChange;u.document,u.document.name,u.document.updateTime;var o=Xa(e,u.document.name),c=Qa(u.document.updateTime),h=new oi({mapValue:{fields:u.document.fields}}),c=ui.newFoundDocument(o,c,h),h=u.targetIds||[],u=u.removedTargetIds||[];n=new Oa(h,u,c.key,c)}else if("documentDelete"in t){t.documentDelete;h=t.documentDelete;h.document;u=Xa(e,h.document),c=h.readTime?Qa(h.readTime):Gr.min(),c=ui.newNoDocument(u,c),h=h.removedTargetIds||[];n=new Oa([],h,c.key,c)}else if("documentRemove"in t){t.documentRemove;var l=t.documentRemove;l.document;var d=Xa(e,l.document),l=l.removedTargetIds||[];n=new Oa([],l,d,null)}else{if(!("filter"in t))return xr();{t.filter;const e=t.filter;e.targetId;l=e.count||0,d=new ba(l),l=e.targetId;n=new Va(l,d)}}var o,f;return n}(this.wt,e),n=function(e){if(!("targetChange"in e))return Gr.min();var t=e.targetChange;return(!t.targetIds||!t.targetIds.length)&&t.readTime?Qa(t.readTime):Gr.min()}(e);return this.listener.Go(t,n)}Qo(e){const t={};t.database=eo(this.wt),t.addTarget=function(e,t){let n;var r=t.target;return n=fi(r)?{documents:ao(e,r)}:{query:oo(e,r)},n.targetId=t.targetId,0<t.resumeToken.approximateByteSize()?n.resumeToken=za(e,t.resumeToken):0<t.snapshotVersion.compareTo(Gr.min())&&(n.readTime=$a(e,t.snapshotVersion.toTimestamp())),n}(this.wt,e);var n,r,r=(this.wt,n=e,null==(r=function(){switch(n.purpose){case 0:return null;case 1:return"existence-filter-mismatch";case 2:return"limbo-document";default:return xr()}}())?null:{"goog-listen-tags":r});r&&(t.labels=r),this.Mo(t)}jo(e){const t={};t.database=eo(this.wt),t.removeTarget=e,this.Mo(t)}}class ih extends rh{constructor(e,t,n,r,s,i){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,n,r,i),this.wt=s,this.Wo=!1}get zo(){return this.Wo}start(){this.Wo=!1,this.lastStreamToken=void 0,super.start()}Bo(){this.Wo&&this.Ho([])}Ko(e,t){return this.bo.ho("Write",e,t)}onMessage(e){if(Dr(!!e.streamToken),this.lastStreamToken=e.streamToken,this.Wo){this.So.reset();var t=(r=e.writeResults,s=e.commitTime,r&&0<r.length?(Dr(void 0!==s),r.map(e=>function(e,t){let n=e.updateTime?Qa(e.updateTime):Qa(t);return n.isEqual(Gr.min())&&(n=Qa(t)),new ia(n,e.transformResults||[])}(e,s))):[]),n=Qa(e.commitTime);return this.listener.Jo(n,t)}var r,s;return Dr(!e.writeResults||0===e.writeResults.length),this.Wo=!0,this.listener.Yo()}Xo(){const e={};e.database=eo(this.wt),this.Mo(e)}Ho(e){var t={streamToken:this.lastStreamToken,writes:e.map(e=>so(this.wt,e))};this.Mo(t)}}class ah extends class{}{constructor(e,t,n,r){super(),this.authCredentials=e,this.appCheckCredentials=t,this.bo=n,this.wt=r,this.Zo=!1}tu(){if(this.Zo)throw new Cr(Ar.FAILED_PRECONDITION,"The client has already been terminated.")}ro(n,r,s){return this.tu(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([e,t])=>this.bo.ro(n,r,s,e,t)).catch(e=>{throw"FirebaseError"===e.name?(e.code===Ar.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new Cr(Ar.UNKNOWN,e.toString())})}ao(n,r,s){return this.tu(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([e,t])=>this.bo.ao(n,r,s,e,t)).catch(e=>{throw"FirebaseError"===e.name?(e.code===Ar.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new Cr(Ar.UNKNOWN,e.toString())})}terminate(){this.Zo=!0}}class oh{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.eu=0,this.nu=null,this.su=!0}iu(){0===this.eu&&(this.ru("Unknown"),this.nu=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this.nu=null,this.ou("Backend didn't respond within 10 seconds."),this.ru("Offline"),Promise.resolve())))}uu(e){"Online"===this.state?this.ru("Unknown"):(this.eu++,1<=this.eu&&(this.cu(),this.ou(`Connection failed 1 times. Most recent error: ${e.toString()}`),this.ru("Offline")))}set(e){this.cu(),this.eu=0,"Online"===e&&(this.su=!1),this.ru(e)}ru(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}ou(e){var t=`Could not reach Cloud Firestore backend. ${e}\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.su?(Tr(t),this.su=!1):Er("OnlineStateTracker",t)}cu(){null!==this.nu&&(this.nu.cancel(),this.nu=null)}}class uh{constructor(e,t,n,r,s){this.localStore=e,this.datastore=t,this.asyncQueue=n,this.remoteSyncer={},this.au=[],this.hu=new Map,this.lu=new Set,this.fu=[],this.du=s,this.du.Br(e=>{n.enqueueAndForget(async()=>{yh(this)&&(Er("RemoteStore","Restarting streams for network reachability change."),await async function(e){const t=e;t.lu.add(4),await hh(t),t._u.set("Unknown"),t.lu.delete(4),await ch(t)}(this))})}),this._u=new oh(n,r)}}async function ch(e){if(yh(e))for(const t of e.fu)await t(!0)}async function hh(e){for(const t of e.fu)await t(!1)}function lh(e,t){const n=e;n.hu.has(t.targetId)||(n.hu.set(t.targetId,t),ph(n)?mh(n):xh(n).Co()&&fh(n,t))}function dh(e,t){const n=e,r=xh(n);n.hu.delete(t),r.Co()&&gh(n,t),0===n.hu.size&&(r.Co()?r.ko():yh(n)&&n._u.set("Unknown"))}function fh(e,t){e.wu.Nt(t.targetId),xh(e).Qo(t)}function gh(e,t){e.wu.Nt(t),xh(e).jo(t)}function mh(t){t.wu=new Ba({getRemoteKeysForTarget:e=>t.remoteSyncer.getRemoteKeysForTarget(e),te:e=>t.hu.get(e)||null}),xh(t).start(),t._u.iu()}function ph(e){return yh(e)&&!xh(e).Do()&&0<e.hu.size}function yh(e){return 0===e.lu.size}function vh(e){e.wu=void 0}async function wh(e,t,n){if(!fs(t))throw t;e.lu.add(1),await hh(e),e._u.set("Offline"),n=n||(()=>Cc(e.localStore)),e.asyncQueue.enqueueRetryable(async()=>{Er("RemoteStore","Retrying IndexedDB access"),await n(),e.lu.delete(1),await ch(e)})}function bh(t,n){return n().catch(e=>wh(t,e,n))}async function Ih(e){const t=e,n=Dh(t);let r=0<t.au.length?t.au[t.au.length-1].batchId:-1;for(;yh(s=t)&&s.au.length<10;)try{const e=await function(e,t){const n=e;return n.persistence.runTransaction("Get next mutation batch","readonly",e=>(void 0===t&&(t=-1),n.mutationQueue.getNextMutationBatchAfterBatchId(e,t)))}(t.localStore,r);if(null===e){0===t.au.length&&n.ko();break}r=e.batchId,function(e,t){e.au.push(t);const n=Dh(e);n.Co()&&n.zo&&n.Ho(t.mutations)}(t,e)}catch(e){await wh(t,e)}var s;Eh(t)&&Th(t)}function Eh(e){return yh(e)&&!Dh(e).Do()&&0<e.au.length}function Th(e){Dh(e).start()}async function Sh(e,t){const n=e;n.asyncQueue.verifyOperationInProgress(),Er("RemoteStore","RemoteStore received new credentials");var r=yh(n);n.lu.add(3),await hh(n),r&&n._u.set("Unknown"),await n.remoteSyncer.handleCredentialChange(t),n.lu.delete(3),await ch(n)}async function _h(e,t){const n=e;t?(n.lu.delete(2),await ch(n)):(n.lu.add(2),await hh(n),n._u.set("Unknown"))}function xh(t){return t.mu||(t.mu=function(e,t,n){const r=e;return r.tu(),new sh(t,r.bo,r.authCredentials,r.appCheckCredentials,r.wt,n)}(t.datastore,t.asyncQueue,{zr:(async function(n){n.hu.forEach((e,t)=>{fh(n,e)})}).bind(null,t),Jr:(async function(e,t){vh(e),ph(e)?(e._u.uu(t),mh(e)):e._u.set("Unknown")}).bind(null,t),Go:(async function(e,r,t){if(e._u.set("Online"),r instanceof Fa&&2===r.state&&r.cause)try{await async function(e){var t=r.cause;for(const n of r.targetIds)e.hu.has(n)&&(await e.remoteSyncer.rejectListen(n,t),e.hu.delete(n),e.wu.removeTarget(n))}(e)}catch(t){Er("RemoteStore","Failed to remove targets %s: %s ",r.targetIds.join(","),t),await wh(e,t)}else if(r instanceof Oa?e.wu.Ut(r):r instanceof Va?e.wu.zt(r):e.wu.Gt(r),!t.isEqual(Gr.min()))try{const r=await Cc(e.localStore);0<=t.compareTo(r)&&await function(r,s){const e=r.wu.Yt(s);return e.targetChanges.forEach((e,t)=>{if(0<e.resumeToken.approximateByteSize()){const n=r.hu.get(t);n&&r.hu.set(t,n.withResumeToken(e.resumeToken,s))}}),e.targetMismatches.forEach(e=>{const t=r.hu.get(e);var n;t&&(r.hu.set(e,t.withResumeToken(ks.EMPTY_BYTE_STRING,t.snapshotVersion)),gh(r,e),n=new zo(t.target,e,1,t.sequenceNumber),fh(r,n))}),r.remoteSyncer.applyRemoteEvent(e)}(e,t)}catch(r){Er("RemoteStore","Failed to raise snapshot:",r),await wh(e,r)}}).bind(null,t)}),t.fu.push(async e=>{e?(t.mu.No(),ph(t)?mh(t):t._u.set("Unknown")):(await t.mu.stop(),vh(t))})),t.mu}function Dh(t){return t.gu||(t.gu=function(e,t,n){const r=e;return r.tu(),new ih(t,r.bo,r.authCredentials,r.appCheckCredentials,r.wt,n)}(t.datastore,t.asyncQueue,{zr:(async function(e){Dh(e).Xo()}).bind(null,t),Jr:(async function(e,t){t&&Dh(e).zo&&await async function(e,t){if(Ia(n=t.code)&&n!==Ar.ABORTED){const n=e.au.shift();Dh(e).No(),await bh(e,()=>e.remoteSyncer.rejectFailedWrite(n.batchId,t)),await Ih(e)}var n}(e,t),Eh(e)&&Th(e)}).bind(null,t),Yo:(async function(e){const t=Dh(e);for(const n of e.au)t.Ho(n.mutations)}).bind(null,t),Jo:(async function(e,t,n){const r=e.au.shift(),s=Go.from(r,t,n);await bh(e,()=>e.remoteSyncer.applySuccessfulWrite(s)),await Ih(e)}).bind(null,t)}),t.fu.push(async e=>{e?(t.gu.No(),await Ih(t)):(await t.gu.stop(),0<t.au.length&&(Er("RemoteStore",`Stopping write stream with ${t.au.length} pending writes`),t.au=[]))})),t.gu}class Ah{constructor(e,t,n,r,s){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=n,this.op=r,this.removalCallback=s,this.deferred=new Nr,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(e=>{})}static createAndSchedule(e,t,n,r,s){const i=Date.now()+n,a=new Ah(e,t,i,r,s);return a.start(n),a}start(e){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new Cr(Ar.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then(e=>this.deferred.resolve(e))):Promise.resolve())}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function Ch(e,t){if(Tr("AsyncQueue",`${t}: ${e}`),fs(e))return new Cr(Ar.UNAVAILABLE,`${t}: ${e}`);throw e}class Nh{constructor(n){this.comparator=n?(e,t)=>n(e,t)||Wr.comparator(e.key,t.key):(e,t)=>Wr.comparator(e.key,t.key),this.keyedMap=xa(),this.sortedSet=new Ss(this.comparator)}static emptySet(e){return new Nh(e.comparator)}has(e){return null!=this.keyedMap.get(e)}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){var t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1}get size(){return this.sortedSet.size}forEach(n){this.sortedSet.inorderTraversal((e,t)=>(n(e),!1))}add(e){const t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){var t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof Nh))return!1;if(this.size!==e.size)return!1;const t=this.sortedSet.getIterator(),n=e.sortedSet.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(!e.isEqual(r))return!1}return!0}toString(){const t=[];return this.forEach(e=>{t.push(e.toString())}),0===t.length?"DocumentSet ()":"DocumentSet (\n  "+t.join("  \n")+"\n)"}copy(e,t){const n=new Nh;return n.comparator=this.comparator,n.keyedMap=e,n.sortedSet=t,n}}class kh{constructor(){this.yu=new Ss(Wr.comparator)}track(e){var t=e.doc.key,n=this.yu.get(t);!n||0!==e.type&&3===n.type?this.yu=this.yu.insert(t,e):3===e.type&&1!==n.type?this.yu=this.yu.insert(t,{type:n.type,doc:e.doc}):2===e.type&&2===n.type?this.yu=this.yu.insert(t,{type:2,doc:e.doc}):2===e.type&&0===n.type?this.yu=this.yu.insert(t,{type:0,doc:e.doc}):1===e.type&&0===n.type?this.yu=this.yu.remove(t):1===e.type&&2===n.type?this.yu=this.yu.insert(t,{type:1,doc:n.doc}):0===e.type&&1===n.type?this.yu=this.yu.insert(t,{type:2,doc:e.doc}):xr()}pu(){const n=[];return this.yu.inorderTraversal((e,t)=>{n.push(t)}),n}}class Rh{constructor(e,t,n,r,s,i,a,o){this.query=e,this.docs=t,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=s,this.fromCache=i,this.syncStateChanged=a,this.excludesMetadataChanges=o}static fromInitialDocuments(e,t,n,r){const s=[];return t.forEach(e=>{s.push({type:0,doc:e})}),new Rh(e,t,Nh.emptySet(t),s,n,r,!0,!1)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&Bi(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;const t=this.docChanges,n=e.docChanges;if(t.length!==n.length)return!1;for(let r=0;r<t.length;r++)if(t[r].type!==n[r].type||!t[r].doc.isEqual(n[r].doc))return!1;return!0}}class Mh{constructor(){this.Iu=void 0,this.listeners=[]}}class Lh{constructor(){this.queries=new Ta(e=>Ui(e),Bi),this.onlineState="Unknown",this.Tu=new Set}}async function Oh(e,t){const n=e,r=t.query;let s=!1,i=n.queries.get(r);if(i||(s=!0,i=new Mh),s)try{i.Iu=await n.onListen(r)}catch(e){const n=Ch(e,`Initialization of query '${qi(t.query)}' failed`);return void t.onError(n)}n.queries.set(r,i),i.listeners.push(t),t.Eu(n.onlineState),!i.Iu||t.Au(i.Iu)&&Fh(n)}async function Vh(e,t){const n=e,r=t.query;let s=!1;const i=n.queries.get(r);if(i){const e=i.listeners.indexOf(t);0<=e&&(i.listeners.splice(e,1),s=0===i.listeners.length)}if(s)return n.queries.delete(r),n.onUnlisten(r)}function Fh(e){e.Tu.forEach(e=>{e.next()})}class Ph{constructor(e,t,n){this.query=e,this.Ru=t,this.bu=!1,this.Pu=null,this.onlineState="Unknown",this.options=n||{}}Au(e){if(!this.options.includeMetadataChanges){const t=[];for(const n of e.docChanges)3!==n.type&&t.push(n);e=new Rh(e.query,e.docs,e.oldDocs,t,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0)}let t=!1;return this.bu?this.vu(e)&&(this.Ru.next(e),t=!0):this.Vu(e,this.onlineState)&&(this.Su(e),t=!0),this.Pu=e,t}onError(e){this.Ru.error(e)}Eu(e){this.onlineState=e;let t=!1;return this.Pu&&!this.bu&&this.Vu(this.Pu,e)&&(this.Su(this.Pu),t=!0),t}Vu(e,t){return!e.fromCache||!(this.options.Du&&"Offline"!==t||e.docs.isEmpty()&&"Offline"!==t)}vu(e){if(0<e.docChanges.length)return!0;var t=this.Pu&&this.Pu.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&!0===this.options.includeMetadataChanges}Su(e){e=Rh.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache),this.bu=!0,this.Ru.next(e)}}class Bh{constructor(e,t){this.payload=e,this.byteLength=t}Cu(){return"metadata"in this.payload}}class Uh{constructor(e){this.wt=e}Wi(e){return Xa(this.wt,e)}zi(e){return e.metadata.exists?ro(this.wt,e.document,!1):ui.newNoDocument(this.Wi(e.metadata.name),this.Hi(e.metadata.readTime))}Hi(e){return Qa(e)}}class qh{constructor(e,t,n){this.xu=e,this.localStore=t,this.wt=n,this.queries=[],this.documents=[],this.collectionGroups=new Set,this.progress=jh(e)}Nu(e){this.progress.bytesLoaded+=e.byteLength;let t=this.progress.documentsLoaded;if(e.payload.namedQuery)this.queries.push(e.payload.namedQuery);else if(e.payload.documentMetadata){this.documents.push({metadata:e.payload.documentMetadata}),e.payload.documentMetadata.exists||++t;const n=zr.fromString(e.payload.documentMetadata.name);this.collectionGroups.add(n.get(n.length-2))}else e.payload.document&&(this.documents[this.documents.length-1].document=e.payload.document,++t);return t!==this.progress.documentsLoaded?(this.progress.documentsLoaded=t,Object.assign({},this.progress)):null}ku(e){const t=new Map,n=new Uh(this.wt);for(const s of e)if(s.metadata.queries){const e=n.Wi(s.metadata.name);for(const n of s.metadata.queries){var r=(t.get(n)||ka()).add(e);t.set(n,r)}}return t}async complete(){const e=await async function(e,t,n,r){const s=e;let i=ka(),a=Sa;for(const e of n){const n=t.Wi(e.metadata.name);e.document&&(i=i.add(n));const c=t.zi(e);c.setReadTime(t.Hi(e.metadata.readTime)),a=a.insert(n,c)}const o=s.Ui.newChangeBuffer({trackRemovals:!0}),u=await Rc(s,(r=r,Fi(Ri(zr.fromString(`__bundle__/docs/${r}`)))));return s.persistence.runTransaction("Apply bundle documents","readwrite",t=>kc(t,o,a).next(e=>(o.apply(t),e)).next(e=>s.Vs.removeMatchingKeysForTargetId(t,u.targetId).next(()=>s.Vs.addMatchingKeys(t,i,u.targetId)).next(()=>s.localDocuments.getLocalViewOfDocuments(t,e.Gi,e.Qi)).next(()=>e.Gi)))}(this.localStore,new Uh(this.wt),this.documents,this.xu.id),t=this.ku(this.documents);for(const e of this.queries)await async function(e,n,r=ka()){const s=await Rc(e,Fi(tu(n.bundledQuery))),i=e;return i.persistence.runTransaction("Save named query","readwrite",e=>{var t=Qa(n.readTime);if(0<=s.snapshotVersion.compareTo(t))return i.Ds.saveNamedQuery(e,n);t=s.withResumeToken(ks.EMPTY_BYTE_STRING,t);return i.$i=i.$i.insert(t.targetId,t),i.Vs.updateTargetData(e,t).next(()=>i.Vs.removeMatchingKeysForTargetId(e,s.targetId)).next(()=>i.Vs.addMatchingKeys(e,r,s.targetId)).next(()=>i.Ds.saveNamedQuery(e,n))})}(this.localStore,e,t.get(e.name));return this.progress.taskState="Success",{progress:this.progress,Ou:this.collectionGroups,Mu:e}}}function jh(e){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:e.totalDocuments,totalBytes:e.totalBytes}}class Kh{constructor(e){this.key=e}}class Gh{constructor(e){this.key=e}}class $h{constructor(e,t){this.query=e,this.Fu=t,this.$u=null,this.current=!1,this.Bu=ka(),this.mutatedKeys=ka(),this.Lu=Gi(e),this.Uu=new Nh(this.Lu)}get qu(){return this.Fu}Ku(e,t){const o=t?t.Gu:new kh,u=(t||this).Uu;let c=(t||this).mutatedKeys,h=u,l=!1;const d="F"===this.query.limitType&&u.size===this.query.limit?u.last():null,f="L"===this.query.limitType&&u.size===this.query.limit?u.first():null;if(e.inorderTraversal((e,t)=>{const n=u.get(e),r=ji(this.query,t)?t:null,s=!!n&&this.mutatedKeys.has(n.key),i=!!r&&(r.hasLocalMutations||this.mutatedKeys.has(r.key)&&r.hasCommittedMutations);let a=!1;n&&r?n.data.isEqual(r.data)?s!==i&&(o.track({type:3,doc:r}),a=!0):this.Qu(n,r)||(o.track({type:2,doc:r}),a=!0,(d&&0<this.Lu(r,d)||f&&this.Lu(r,f)<0)&&(l=!0)):!n&&r?(o.track({type:0,doc:r}),a=!0):n&&!r&&(o.track({type:1,doc:n}),a=!0,(d||f)&&(l=!0)),a&&(c=r?(h=h.add(r),i?c.add(e):c.delete(e)):(h=h.delete(e),c.delete(e)))}),null!==this.query.limit)for(;h.size>this.query.limit;){const e="F"===this.query.limitType?h.last():h.first();h=h.delete(e.key),c=c.delete(e.key),o.track({type:1,doc:e})}return{Uu:h,Gu:o,Oi:l,mutatedKeys:c}}Qu(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,n){var r=this.Uu;this.Uu=e.Uu,this.mutatedKeys=e.mutatedKeys;const s=e.Gu.pu();s.sort((e,t)=>function(e,t){var n=e=>{switch(e){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return xr()}};return n(e)-n(t)}(e.type,t.type)||this.Lu(e.doc,t.doc)),this.ju(n);var i=t?this.Wu():[],a=0===this.Bu.size&&this.current?1:0,o=a!==this.$u;return this.$u=a,0!==s.length||o?{snapshot:new Rh(this.query,e.Uu,r,s,e.mutatedKeys,0==a,o,!1),zu:i}:{zu:i}}Eu(e){return this.current&&"Offline"===e?(this.current=!1,this.applyChanges({Uu:this.Uu,Gu:new kh,mutatedKeys:this.mutatedKeys,Oi:!1},!1)):{zu:[]}}Hu(e){return!this.Fu.has(e)&&!!this.Uu.has(e)&&!this.Uu.get(e).hasLocalMutations}ju(e){e&&(e.addedDocuments.forEach(e=>this.Fu=this.Fu.add(e)),e.modifiedDocuments.forEach(e=>{}),e.removedDocuments.forEach(e=>this.Fu=this.Fu.delete(e)),this.current=e.current)}Wu(){if(!this.current)return[];const t=this.Bu;this.Bu=ka(),this.Uu.forEach(e=>{this.Hu(e.key)&&(this.Bu=this.Bu.add(e.key))});const n=[];return t.forEach(e=>{this.Bu.has(e)||n.push(new Gh(e))}),this.Bu.forEach(e=>{t.has(e)||n.push(new Kh(e))}),n}Ju(e){this.Fu=e.ji,this.Bu=ka();var t=this.Ku(e.documents);return this.applyChanges(t,!0)}Yu(){return Rh.fromInitialDocuments(this.query,this.Uu,this.mutatedKeys,0===this.$u)}}class zh{constructor(e,t,n){this.query=e,this.targetId=t,this.view=n}}class Qh{constructor(e){this.key=e,this.Xu=!1}}class Hh{constructor(e,t,n,r,s,i){this.localStore=e,this.remoteStore=t,this.eventManager=n,this.sharedClientState=r,this.currentUser=s,this.maxConcurrentLimboResolutions=i,this.Zu={},this.tc=new Ta(e=>Ui(e),Bi),this.ec=new Map,this.nc=new Set,this.sc=new Ss(Wr.comparator),this.ic=new Map,this.rc=new uc,this.oc={},this.uc=new Map,this.cc=Pu.Rn(),this.onlineState="Unknown",this.ac=void 0}get isPrimaryClient(){return!0===this.ac}}async function Wh(n,e,t,r){n.hc=(e,i,t)=>async function(e,t,n){let r=t.view.Ku(i);r.Oi&&(r=await Lc(e.localStore,t.query,!1).then(({documents:e})=>t.view.Ku(e,r)));var s=n&&n.targetChanges.get(t.targetId),s=t.view.applyChanges(r,e.isPrimaryClient,s);return sl(e,t.targetId,s.zu),s.snapshot}(n,e,t);const s=await Lc(n.localStore,e,!0),i=new $h(e,s.ji),a=i.Ku(s.documents),o=La.createSynthesizedTargetChangeForCurrentChange(t,r&&"Offline"!==n.onlineState),u=i.applyChanges(a,n.isPrimaryClient,o);sl(n,t,u.zu);var c=new zh(e,t,i);return n.tc.set(e,c),n.ec.has(t)?n.ec.get(t).push(e):n.ec.set(t,[e]),u.snapshot}async function Yh(e,t,n){const r=ll(e);try{const e=await function(e,s){const i=e,a=Kr.now(),o=s.reduce((e,t)=>e.add(t.key),ka());let u,c;return i.persistence.runTransaction("Locally write mutations","readwrite",n=>{let t=Sa,r=ka();return i.Ui.getEntries(n,o).next(e=>{t=e,t.forEach((e,t)=>{t.isValidDocument()||(r=r.add(e))})}).next(()=>i.localDocuments.getOverlayedDocuments(n,t)).next(e=>{u=e;const t=[];for(const n of s){const s=function(e,t){let n=null;for(const r of e.fieldTransforms){const e=t.data.field(r.field),s=Wi(r.transform,e||null);null!=s&&(null===n&&(n=oi.empty()),n.set(r.field,s))}return n||null}(n,u.get(n.key).overlayedDocument);null!=s&&t.push(new ga(n.key,s,function r(e){const s=[];return Es(e.fields,(e,t)=>{const n=new Hr([e]);if(ni(t)){const e=r(t.mapValue).fields;if(0===e.length)s.push(n);else for(const t of e)s.push(n.child(t))}else s.push(n)}),new Ns(s)}(s.value.mapValue),aa.exists(!0)))}return i.mutationQueue.addMutationBatch(n,a,t,s)}).next(e=>{var t=(c=e).applyToLocalDocumentSet(u,r);return i.documentOverlayCache.saveOverlays(n,e.batchId,t)})}).then(()=>({batchId:c.batchId,changes:Da(u)}))}(r.localStore,t);r.sharedClientState.addPendingMutation(e.batchId),function(e,t,n){let r=e.oc[e.currentUser.toKey()];r=r||new Ss(Ur),r=r.insert(t,n),e.oc[e.currentUser.toKey()]=r}(r,e.batchId,n),await al(r,e.changes),await Ih(r.remoteStore)}catch(e){const t=Ch(e,"Failed to persist write");n.reject(t)}}async function Xh(e,t){const r=e;try{const e=await Nc(r.localStore,t);t.targetChanges.forEach((e,t)=>{const n=r.ic.get(t);n&&(Dr(e.addedDocuments.size+e.modifiedDocuments.size+e.removedDocuments.size<=1),0<e.addedDocuments.size?n.Xu=!0:0<e.modifiedDocuments.size?Dr(n.Xu):0<e.removedDocuments.size&&(Dr(n.Xu),n.Xu=!1))}),await al(r,e,t)}catch(e){await os(e)}}function Jh(r,s,e){const t=r;if(t.isPrimaryClient&&0===e||!t.isPrimaryClient&&1===e){const r=[];t.tc.forEach((e,t)=>{var n=t.view.Eu(s);n.snapshot&&r.push(n.snapshot)}),function(e,n){const t=e;t.onlineState=n;let r=!1;t.queries.forEach((e,t)=>{for(const e of t.listeners)e.Eu(n)&&(r=!0)}),r&&Fh(t)}(t.eventManager,s),r.length&&t.Zu.Go(r),t.onlineState=s,t.isPrimaryClient&&t.sharedClientState.setOnlineState(s)}}async function Zh(e,t){const n=e,r=t.batch.batchId;try{const e=await function(e,r){const s=e;return s.persistence.runTransaction("Acknowledge batch","readwrite-primary",e=>{const t=r.batch.keys(),n=s.Ui.newChangeBuffer({trackRemovals:!0});return function(e,t,r,s){const i=r.batch,n=i.keys();let a=us.resolve();return n.forEach(n=>{a=a.next(()=>s.getEntry(t,n)).next(e=>{var t=r.docVersions.get(n);Dr(null!==t),e.version.compareTo(t)<0&&(i.applyToRemoteDocument(e,r),e.isValidDocument()&&(e.setReadTime(r.commitVersion),s.addEntry(e)))})}),a.next(()=>e.mutationQueue.removeMutationBatch(t,i))}(s,e,r,n).next(()=>n.apply(e)).next(()=>s.mutationQueue.performConsistencyCheck(e)).next(()=>s.documentOverlayCache.removeOverlaysForBatchId(e,t,r.batch.batchId)).next(()=>s.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,function(e){let t=ka();for(let n=0;n<e.mutationResults.length;++n)0<e.mutationResults[n].transformResults.length&&(t=t.add(e.batch.mutations[n].key));return t}(r))).next(()=>s.localDocuments.getDocuments(e,t))})}(n.localStore,t);tl(n,r,null),el(n,r),n.sharedClientState.updateMutationState(r,"acknowledged"),await al(n,e)}catch(e){await os(e)}}function el(e,t){(e.uc.get(t)||[]).forEach(e=>{e.resolve()}),e.uc.delete(t)}function tl(e,t,n){const r=e;let s=r.oc[r.currentUser.toKey()];if(s){const e=s.get(t);e&&(n?e.reject(n):e.resolve(),s=s.remove(t)),r.oc[r.currentUser.toKey()]=s}}function nl(t,e,n=null){t.sharedClientState.removeLocalQueryTarget(e);for(const r of t.ec.get(e))t.tc.delete(r),n&&t.Zu.lc(r,n);t.ec.delete(e),t.isPrimaryClient&&t.rc.us(e).forEach(e=>{t.rc.containsKey(e)||rl(t,e)})}function rl(e,t){e.nc.delete(t.path.canonicalString());var n=e.sc.get(t);null!==n&&(dh(e.remoteStore,n),e.sc=e.sc.remove(t),e.ic.delete(n),il(e))}function sl(e,t,n){for(const r of n)r instanceof Kh?(e.rc.addReference(r.key,t),function(e,t){const n=t.key,r=n.path.canonicalString();e.sc.get(n)||e.nc.has(r)||(Er("SyncEngine","New document in limbo: "+n),e.nc.add(r),il(e))}(e,r)):r instanceof Gh?(Er("SyncEngine","Document no longer in limbo: "+r.key),e.rc.removeReference(r.key,t),e.rc.containsKey(r.key)||rl(e,r.key)):xr()}function il(e){for(;0<e.nc.size&&e.sc.size<e.maxConcurrentLimboResolutions;){var t=e.nc.values().next().value;e.nc.delete(t);var n=new Wr(zr.fromString(t)),t=e.cc.next();e.ic.set(t,new Qh(n)),e.sc=e.sc.insert(n,t),lh(e.remoteStore,new zo(Fi(Ri(n.path)),t,2,bs.ot))}}async function al(e,t,r){const s=e,i=[],a=[],o=[];s.tc.isEmpty()||(s.tc.forEach((e,n)=>{o.push(s.hc(n,t,r).then(e=>{var t;e&&(s.isPrimaryClient&&s.sharedClientState.updateQueryState(n.targetId,e.fromCache?"not-current":"current"),i.push(e),t=Sc.Vi(n.targetId,e),a.push(t))}))}),await Promise.all(o),s.Zu.Go(i),await async function(e,t){const r=e;try{await r.persistence.runTransaction("notifyLocalViewChanges","readwrite",n=>us.forEach(t,t=>us.forEach(t.Pi,e=>r.persistence.referenceDelegate.addReference(n,t.targetId,e)).next(()=>us.forEach(t.vi,e=>r.persistence.referenceDelegate.removeReference(n,t.targetId,e)))))}catch(e){if(!fs(e))throw e;Er("LocalStore","Failed to update sequence numbers: "+e)}for(const e of t){const t=e.targetId;if(!e.fromCache){const e=r.$i.get(t),n=e.snapshotVersion,s=e.withLastLimboFreeSnapshotVersion(n);r.$i=r.$i.insert(t,s)}}}(s.localStore,a))}async function ol(r,e){const s=r;if(hl(s),ll(s),!0===e&&!0!==s.ac){const r=s.sharedClientState.getAllActiveQueryTargets(),e=await ul(s,r.toArray());s.ac=!0,await _h(s.remoteStore,!0);for(const r of e)lh(s.remoteStore,r)}else if(!1===e&&!1!==s.ac){const r=[];let n=Promise.resolve();s.ec.forEach((e,t)=>{s.sharedClientState.isLocalQueryTarget(t)?r.push(t):n=n.then(()=>(nl(s,t),Mc(s.localStore,t,!0))),dh(s.remoteStore,t)}),await n,await ul(s,r),function(){const n=s;n.ic.forEach((e,t)=>{dh(n.remoteStore,t)}),n.rc.cs(),n.ic=new Map,n.sc=new Ss(Wr.comparator)}(),s.ac=!1,await _h(s.remoteStore,!1)}}async function ul(t,n){const r=t,s=[],i=[];for(const t of n){let e;const h=r.ec.get(t);if(h&&0!==h.length){e=await Rc(r.localStore,Fi(h[0]));for(const t of h){const n=r.tc.get(t),h=(a=r,o=n,c=u=void 0,c=await Lc((u=a).localStore,o.query,!0),c=o.view.Ju(c),u.isPrimaryClient&&sl(u,o.targetId,c.zu),await c);h.snapshot&&i.push(h.snapshot)}}else{const h=await Oc(r.localStore,t);e=await Rc(r.localStore,h),await Wh(r,cl(h),t,!1)}s.push(e)}var a,o,u,c;return r.Zu.Go(i),s}function cl(e){return ki(e.path,e.collectionGroup,e.orderBy,e.filters,e.limit,"F",e.startAt,e.endAt)}function hl(e){const t=e;return t.remoteStore.remoteSyncer.applyRemoteEvent=Xh.bind(null,t),t.remoteStore.remoteSyncer.getRemoteKeysForTarget=(function(e,t){const n=e,r=n.ic.get(t);if(r&&r.Xu)return ka().add(r.key);{let e=ka();const r=n.ec.get(t);if(!r)return e;for(const t of r){const r=n.tc.get(t);e=e.unionWith(r.view.qu)}return e}}).bind(null,t),t.remoteStore.remoteSyncer.rejectListen=(async function(e,t,n){const r=e;r.sharedClientState.updateQueryState(t,"rejected",n);const s=r.ic.get(t),i=s&&s.key;if(i){let e=new Ss(Wr.comparator);e=e.insert(i,ui.newNoDocument(i,Gr.min()));const n=ka().add(i),s=new Ma(Gr.min(),new Map,new Ds(Ur),e,n);await Xh(r,s),r.sc=r.sc.remove(i),r.ic.delete(t),il(r)}else await Mc(r.localStore,t,!1).then(()=>nl(r,t,n)).catch(os)}).bind(null,t),t.Zu.Go=(function(e,t){const n=e;let r=!1;for(const e of t){const t=e.query,s=n.queries.get(t);if(s){for(const t of s.listeners)t.Au(e)&&(r=!0);s.Iu=e}}r&&Fh(n)}).bind(null,t.eventManager),t.Zu.lc=(function(e,t,n){const r=e,s=r.queries.get(t);if(s)for(const e of s.listeners)e.onError(n);r.queries.delete(t)}).bind(null,t.eventManager),t}function ll(e){const t=e;return t.remoteStore.remoteSyncer.applySuccessfulWrite=Zh.bind(null,t),t.remoteStore.remoteSyncer.rejectFailedWrite=(async function(e,t,n){const r=e;try{const e=await function(e,r){const s=e;return s.persistence.runTransaction("Reject batch","readwrite-primary",t=>{let n;return s.mutationQueue.lookupMutationBatch(t,r).next(e=>(Dr(null!==e),n=e.keys(),s.mutationQueue.removeMutationBatch(t,e))).next(()=>s.mutationQueue.performConsistencyCheck(t)).next(()=>s.documentOverlayCache.removeOverlaysForBatchId(t,n,r)).next(()=>s.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(t,n)).next(()=>s.localDocuments.getDocuments(t,n))})}(r.localStore,t);tl(r,t,n),el(r,t),r.sharedClientState.updateMutationState(t,"rejected",n),await al(r,e)}catch(n){await os(n)}}).bind(null,t),t}class dl{constructor(){this.synchronizeTabs=!1}async initialize(e){this.wt=th(e.databaseInfo.databaseId),this.sharedClientState=this.dc(e),this.persistence=this._c(e),await this.persistence.start(),this.localStore=this.wc(e),this.gcScheduler=this.mc(e,this.localStore),this.indexBackfillerScheduler=this.gc(e,this.localStore)}mc(e,t){return null}gc(e,t){return null}wc(e){return Dc(this.persistence,new _c,e.initialUser,this.wt)}_c(e){return new gc(pc.Ms,this.wt)}dc(e){return new Qc}async terminate(){this.gcScheduler&&this.gcScheduler.stop(),await this.sharedClientState.shutdown(),await this.persistence.shutdown()}}class fl extends dl{constructor(e,t,n){super(),this.yc=e,this.cacheSizeBytes=t,this.forceOwnership=n,this.synchronizeTabs=!1}async initialize(e){await super.initialize(e),await this.yc.initialize(this,e),await ll(this.yc.syncEngine),await Ih(this.yc.remoteStore),await this.persistence.ci(()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve()))}wc(e){return Dc(this.persistence,new _c,e.initialUser,this.wt)}mc(e,t){var n=this.persistence.referenceDelegate.garbageCollector;return new $u(n,e.asyncQueue,t)}gc(e,t){var n=new ws(t,this.persistence);return new vs(e.asyncQueue,n)}_c(e){var t=Tc(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?Nu.withCacheSize(this.cacheSizeBytes):Nu.DEFAULT;return new bc(this.synchronizeTabs,t,e.clientId,n,e.asyncQueue,Zc(),eh(),this.wt,this.sharedClientState,!!this.forceOwnership)}dc(e){return new Qc}}class gl extends fl{constructor(e,t){super(e,t,!1),this.yc=e,this.cacheSizeBytes=t,this.synchronizeTabs=!0}async initialize(e){await super.initialize(e);var t=this.yc.syncEngine;this.sharedClientState instanceof zc&&(this.sharedClientState.syncEngine={kr:(async function(e,t,n,r){var s=e,i=await function(e,n){const r=e,s=r.mutationQueue;return r.persistence.runTransaction("Lookup mutation documents","readonly",t=>s.yn(t,n).next(e=>e?r.localDocuments.getDocuments(t,e):us.resolve(null)))}(s.localStore,t);null!==i?("pending"===n?await Ih(s.remoteStore):"acknowledged"===n||"rejected"===n?(tl(s,t,r||null),el(s,t),s.localStore.mutationQueue.In(t)):xr(),await al(s,i)):Er("SyncEngine","Cannot apply mutation batch with id: "+t)}).bind(null,t),Or:(async function(e,t,n,r){const s=e;if(s.ac)Er("SyncEngine","Ignoring unexpected query state notification.");else{var i=s.ec.get(t);if(i&&0<i.length)switch(n){case"current":case"not-current":{const e=await Vc(s.localStore,Ki(i[0])),r=Ma.createSynthesizedRemoteEventForCurrentChange(t,"current"===n);await al(s,e,r);break}case"rejected":await Mc(s.localStore,t,!0),nl(s,t,r);break;default:xr()}}}).bind(null,t),Mr:(async function(e,t,n){const r=hl(e);if(r.ac){for(const e of t)if(r.ec.has(e))Er("SyncEngine","Adding an already active target "+e);else{const t=await Oc(r.localStore,e),n=await Rc(r.localStore,t);await Wh(r,cl(t),n.targetId,!1),lh(r.remoteStore,n)}for(const e of n)r.ec.has(e)&&await Mc(r.localStore,e,!1).then(()=>{dh(r.remoteStore,e),nl(r,e)}).catch(os)}}).bind(null,t),Ri:(function(e){return e.localStore.persistence.Ri()}).bind(null,t),Nr:(async function(e,t){const n=e;return Vc(n.localStore,t).then(e=>al(n,e))}).bind(null,t)},await this.sharedClientState.start()),await this.persistence.ci(async e=>{await ol(this.yc.syncEngine,e),this.gcScheduler&&(e&&!this.gcScheduler.started?this.gcScheduler.start():e||this.gcScheduler.stop()),this.indexBackfillerScheduler&&(e&&!this.indexBackfillerScheduler.started?this.indexBackfillerScheduler.start():e||this.indexBackfillerScheduler.stop())})}dc(e){var t=Zc();if(!zc.V(t))throw new Cr(Ar.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");var n=Tc(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey);return new zc(t,e.asyncQueue,n,e.clientId,e.initialUser)}}class ml{async initialize(e,t){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(t),this.remoteStore=this.createRemoteStore(t),this.eventManager=this.createEventManager(t),this.syncEngine=this.createSyncEngine(t,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=e=>Jh(this.syncEngine,e,1),this.remoteStore.remoteSyncer.handleCredentialChange=(async function(e,t){const n=e;if(!n.currentUser.isEqual(t)){Er("SyncEngine","User change. New user:",t.toKey());const r=await Ac(n.localStore,t);n.currentUser=t,(e=n).uc.forEach(e=>{e.forEach(e=>{e.reject(new Cr(Ar.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))})}),e.uc.clear(),n.sharedClientState.handleUserChange(t,r.removedBatchIds,r.addedBatchIds),await al(n,r.Ki)}}).bind(null,this.syncEngine),await _h(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(e){return new Lh}createDatastore(e){var t,n,r,s,i=th(e.databaseInfo.databaseId),t=(t=e.databaseInfo,new Jc(t));return n=e.authCredentials,r=e.appCheckCredentials,s=t,e=i,new ah(n,r,s,e)}createRemoteStore(e){return t=this.localStore,n=this.datastore,r=e.asyncQueue,s=e=>Jh(this.syncEngine,e,0),i=new(Wc.V()?Wc:Hc),new uh(t,n,r,s,i);var t,n,r,s,i}createSyncEngine(e,t){return function(e,t,n,r,s,i,a){const o=new Hh(e,t,n,r,s,i);return a&&(o.ac=!0),o}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,e.initialUser,e.maxConcurrentLimboResolutions,t)}terminate(){return async function(e){const t=e;Er("RemoteStore","RemoteStore shutting down."),t.lu.add(5),await hh(t),t.du.shutdown(),t._u.set("Unknown")}(this.remoteStore)}}function pl(t,n=10240){let r=0;return{async read(){if(r<t.byteLength){var e={value:t.slice(r,r+n),done:!1};return r+=n,e}return{done:!0}},async cancel(){},releaseLock(){},closed:Promise.reject("unimplemented")}}class yl{constructor(e){this.observer=e,this.muted=!1}next(e){this.observer.next&&this.Ic(this.observer.next,e)}error(e){this.observer.error?this.Ic(this.observer.error,e):console.error("Uncaught Error in snapshot listener:",e)}Tc(){this.muted=!0}Ic(e,t){this.muted||setTimeout(()=>{this.muted||e(t)},0)}}class vl{constructor(e,t){this.Ec=e,this.wt=t,this.metadata=new Nr,this.buffer=new Uint8Array,this.Ac=new TextDecoder("utf-8"),this.Rc().then(e=>{e&&e.Cu()?this.metadata.resolve(e.payload.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is\n             ${JSON.stringify(null==e?void 0:e.payload)}`))},e=>this.metadata.reject(e))}close(){return this.Ec.cancel()}async getMetadata(){return this.metadata.promise}async fc(){return await this.getMetadata(),this.Rc()}async Rc(){var e=await this.bc();if(null===e)return null;var t=this.Ac.decode(e),n=Number(t);isNaN(n)&&this.Pc(`length string (${t}) is not valid number`);t=await this.vc(n);return new Bh(JSON.parse(t),e.length+n)}Vc(){return this.buffer.findIndex(e=>e==="{".charCodeAt(0))}async bc(){for(;this.Vc()<0&&!await this.Sc(););if(0===this.buffer.length)return null;var e=this.Vc();e<0&&this.Pc("Reached the end of bundle when a length string is expected.");var t=this.buffer.slice(0,e);return this.buffer=this.buffer.slice(e),t}async vc(e){for(;this.buffer.length<e;)await this.Sc()&&this.Pc("Reached the end of bundle when more is expected.");var t=this.Ac.decode(this.buffer.slice(0,e));return this.buffer=this.buffer.slice(e),t}Pc(e){throw this.Ec.cancel(),new Error(`Invalid bundle format: ${e}`)}async Sc(){var e=await this.Ec.read();if(!e.done){const t=new Uint8Array(this.buffer.length+e.value.length);t.set(this.buffer),t.set(e.value,this.buffer.length),this.buffer=t}return e.done}}class wl{constructor(e){this.datastore=e,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastWriteError=null,this.writtenDocs=new Set}async lookup(e){if(this.ensureCommitNotCalled(),0<this.mutations.length)throw new Cr(Ar.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes.");const t=await async function(e,t){const r=e,n=eo(r.wt)+"/documents",s={documents:t.map(e=>Ya(r.wt,e))},i=await r.ao("BatchGetDocuments",n,s),a=new Map;i.forEach(e=>{const t=(n=r.wt,"found"in(e=e)?function(e,t){Dr(!!t.found),t.found.name,t.found.updateTime;var n=Xa(e,t.found.name),r=Qa(t.found.updateTime),s=new oi({mapValue:{fields:t.found.fields}});return ui.newFoundDocument(n,r,s)}(n,e):"missing"in e?function(e,t){Dr(!!t.missing),Dr(!!t.readTime);var n=Xa(e,t.missing),r=Qa(t.readTime);return ui.newNoDocument(n,r)}(n,e):xr());var n;a.set(t.key.toString(),t)});const o=[];return t.forEach(e=>{var t=a.get(e.toString());Dr(!!t),o.push(t)}),o}(this.datastore,e);return t.forEach(e=>this.recordVersion(e)),t}set(e,t){this.write(t.toMutation(e,this.precondition(e))),this.writtenDocs.add(e.toString())}update(e,t){try{this.write(t.toMutation(e,this.preconditionForUpdate(e)))}catch(e){this.lastWriteError=e}this.writtenDocs.add(e.toString())}delete(e){this.write(new va(e,this.precondition(e))),this.writtenDocs.add(e.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastWriteError)throw this.lastWriteError;const t=this.readVersions;this.mutations.forEach(e=>{t.delete(e.key.toString())}),t.forEach((e,t)=>{var n=Wr.fromPath(t);this.mutations.push(new wa(n,this.precondition(n)))}),await async function(e,t){const n=e,r=eo(n.wt)+"/documents",s={writes:t.map(e=>so(n.wt,e))};await n.ro("Commit",r,s)}(this.datastore,this.mutations),this.committed=!0}recordVersion(e){let t;if(e.isFoundDocument())t=e.version;else{if(!e.isNoDocument())throw xr();t=Gr.min()}var n=this.readVersions.get(e.key.toString());if(n){if(!t.isEqual(n))throw new Cr(Ar.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(e.key.toString(),t)}precondition(e){var t=this.readVersions.get(e.toString());return!this.writtenDocs.has(e.toString())&&t?aa.updateTime(t):aa.none()}preconditionForUpdate(e){const t=this.readVersions.get(e.toString());if(this.writtenDocs.has(e.toString())||!t)return aa.exists(!0);if(t.isEqual(Gr.min()))throw new Cr(Ar.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return aa.updateTime(t)}write(e){this.ensureCommitNotCalled(),this.mutations.push(e)}ensureCommitNotCalled(){}}class bl{constructor(e,t,n,r,s){this.asyncQueue=e,this.datastore=t,this.options=n,this.updateFunction=r,this.deferred=s,this.Dc=n.maxAttempts,this.So=new nh(this.asyncQueue,"transaction_retry")}run(){--this.Dc,this.Cc()}Cc(){this.So.Io(async()=>{const t=new wl(this.datastore),e=this.xc(t);e&&e.then(e=>{this.asyncQueue.enqueueAndForget(()=>t.commit().then(()=>{this.deferred.resolve(e)}).catch(e=>{this.Nc(e)}))}).catch(e=>{this.Nc(e)})})}xc(e){try{var t=this.updateFunction(e);return!Us(t)&&t.catch&&t.then?t:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(e){return this.deferred.reject(e),null}}Nc(e){0<this.Dc&&this.kc(e)?(--this.Dc,this.asyncQueue.enqueueAndForget(()=>(this.Cc(),Promise.resolve()))):this.deferred.reject(e)}kc(e){if("FirebaseError"!==e.name)return!1;var t=e.code;return"aborted"===t||"failed-precondition"===t||!Ia(t)}}class Il{constructor(e,t,n,r){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=n,this.databaseInfo=r,this.user=vr.UNAUTHENTICATED,this.clientId=Br.I(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this.authCredentials.start(n,async e=>{Er("FirestoreClient","Received user=",e.uid),await this.authCredentialListener(e),this.user=e}),this.appCheckCredentials.start(n,e=>(Er("FirestoreClient","Received new app check token=",e),this.appCheckCredentialListener(e,this.user)))}async getConfiguration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new Cr(Ar.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();const n=new Nr;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(async()=>{try{this.onlineComponents&&await this.onlineComponents.terminate(),this.offlineComponents&&await this.offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),n.resolve()}catch(e){var t=Ch(e,"Failed to shutdown persistence");n.reject(t)}}),n.promise}}async function El(e,t){e.asyncQueue.verifyOperationInProgress(),Er("FirestoreClient","Initializing OfflineComponentProvider");var n=await e.getConfiguration();await t.initialize(n);let r=n.initialUser;e.setCredentialChangeListener(async e=>{r.isEqual(e)||(await Ac(t.localStore,e),r=e)}),t.persistence.setDatabaseDeletedListener(()=>e.terminate()),e.offlineComponents=t}async function Tl(e,n){e.asyncQueue.verifyOperationInProgress();var t=await Sl(e);Er("FirestoreClient","Initializing OnlineComponentProvider");var r=await e.getConfiguration();await n.initialize(t,r),e.setCredentialChangeListener(e=>Sh(n.remoteStore,e)),e.setAppCheckTokenChangeListener((e,t)=>Sh(n.remoteStore,t)),e.onlineComponents=n}async function Sl(e){return e.offlineComponents||(Er("FirestoreClient","Using default OfflineComponentProvider"),await El(e,new dl)),e.offlineComponents}async function _l(e){return e.onlineComponents||(Er("FirestoreClient","Using default OnlineComponentProvider"),await Tl(e,new ml)),e.onlineComponents}function xl(e){return Sl(e).then(e=>e.persistence)}function Dl(e){return Sl(e).then(e=>e.localStore)}function Al(e){return _l(e).then(e=>e.remoteStore)}function Cl(e){return _l(e).then(e=>e.syncEngine)}async function Nl(e){const t=await _l(e),n=t.eventManager;return n.onListen=(async function(e,t){const n=hl(e);let r,s;const i=n.tc.get(t);if(i)r=i.targetId,n.sharedClientState.addLocalQueryTarget(r),s=i.view.Yu();else{const e=await Rc(n.localStore,Fi(t));n.isPrimaryClient&&lh(n.remoteStore,e);const i=n.sharedClientState.addLocalQueryTarget(e.targetId);r=e.targetId,s=await Wh(n,t,r,"current"===i)}return s}).bind(null,t.syncEngine),n.onUnlisten=(async function(e,t){const n=e,r=n.tc.get(t),s=n.ec.get(r.targetId);if(1<s.length)return n.ec.set(r.targetId,s.filter(e=>!Bi(e,t))),void n.tc.delete(t);n.isPrimaryClient?(n.sharedClientState.removeLocalQueryTarget(r.targetId),n.sharedClientState.isActiveQueryTarget(r.targetId)||await Mc(n.localStore,r.targetId,!1).then(()=>{n.sharedClientState.clearQueryState(r.targetId),dh(n.remoteStore,r.targetId),nl(n,r.targetId)}).catch(os)):(nl(n,r.targetId),await Mc(n.localStore,r.targetId,!0))}).bind(null,t.syncEngine),n}function kl(e,t,n={}){const r=new Nr;return e.asyncQueue.enqueueAndForget(async()=>function(n,r,s,i,a){const e=new yl({next:e=>{r.enqueueAndForget(()=>Vh(n,o));var t=e.docs.has(s);!t&&e.fromCache?a.reject(new Cr(Ar.UNAVAILABLE,"Failed to get document because the client is offline.")):t&&e.fromCache&&i&&"server"===i.source?a.reject(new Cr(Ar.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):a.resolve(e)},error:e=>a.reject(e)}),o=new Ph(Ri(s.path),e,{includeMetadataChanges:!0,Du:!0});return Oh(n,o)}(await Nl(e),e.asyncQueue,t,n,r)),r.promise}function Rl(e,t,n={}){const r=new Nr;return e.asyncQueue.enqueueAndForget(async()=>function(t,n,e,r,s){const i=new yl({next:e=>{n.enqueueAndForget(()=>Vh(t,a)),e.fromCache&&"server"===r.source?s.reject(new Cr(Ar.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):s.resolve(e)},error:e=>s.reject(e)}),a=new Ph(e,i,{includeMetadataChanges:!0,Du:!0});return Oh(t,a)}(await Nl(e),e.asyncQueue,t,n,r)),r.promise}function Ml(e,t,n,r){const s=(n=n,t=th(t),i="string"==typeof n?(new TextEncoder).encode(n):n,n=function(e){if(e instanceof Uint8Array)return pl(e,void 0);if(e instanceof ArrayBuffer)return pl(new Uint8Array(e),void 0);if(e instanceof ReadableStream)return e.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(i),t=t,new vl(n,t));var i;e.asyncQueue.enqueueAndForget(async()=>{!function(e,t,n){const r=e;!async function(t,n,r){try{var s=await n.getMetadata();if(await function(e,t){const n=e,r=Qa(t.createTime);return n.persistence.runTransaction("hasNewerBundle","readonly",e=>n.Ds.getBundleMetadata(e,t.id)).then(e=>!!e&&0<=e.createTime.compareTo(r))}(t.localStore,s))return await n.close(),r._completeWith({taskState:"Success",documentsLoaded:s.totalDocuments,bytesLoaded:s.totalBytes,totalDocuments:s.totalDocuments,totalBytes:s.totalBytes}),Promise.resolve(new Set);r._updateProgress(jh(s));const a=new qh(s,t.localStore,n.wt);let e=await n.fc();for(;e;){const t=await a.Nu(e);t&&r._updateProgress(t),e=await n.fc()}var i=await a.complete();return await al(t,i.Mu,void 0),await function(e,t){const n=e;return n.persistence.runTransaction("Save bundle","readwrite",e=>n.Ds.saveBundleMetadata(e,t))}(t.localStore,s),r._completeWith(i.progress),Promise.resolve(i.Ou)}catch(t){return Sr("SyncEngine",`Loading bundle failed with ${t}`),r._failWith(t),Promise.resolve(new Set)}}(r,t,n).then(e=>{r.sharedClientState.notifyBundleLoaded(e)})}(await Cl(e),s,r)})}const Ll=new Map;function Ol(e,t,n){if(!n)throw new Cr(Ar.INVALID_ARGUMENT,`Function ${e}() cannot be called with an empty ${t}.`)}function Vl(e,t,n,r){if(!0===t&&!0===r)throw new Cr(Ar.INVALID_ARGUMENT,`${e} and ${n} cannot be used together.`)}function Fl(e){if(!Wr.isDocumentKey(e))throw new Cr(Ar.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${e} has ${e.length}.`)}function Pl(e){if(Wr.isDocumentKey(e))throw new Cr(Ar.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${e} has ${e.length}.`)}function Bl(e){if(void 0===e)return"undefined";if(null===e)return"null";if("string"==typeof e)return 20<e.length&&(e=`${e.substring(0,20)}...`),JSON.stringify(e);if("number"==typeof e||"boolean"==typeof e)return""+e;if("object"!=typeof e)return"function"==typeof e?"a function":xr();if(e instanceof Array)return"an array";var t=(e=e).constructor?e.constructor.name:null;return t?`a custom ${t} object`:"an object"}function Ul(e,t){if((e="_delegate"in e?e._delegate:e)instanceof t)return e;if(t.name===e.constructor.name)throw new Cr(Ar.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");var n=Bl(e);throw new Cr(Ar.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: ${n}`)}function ql(e,t){if(t<=0)throw new Cr(Ar.INVALID_ARGUMENT,`Function ${e}() requires a positive number, but it was: ${t}.`)}class jl{constructor(e){var t;if(void 0===e.host){if(void 0!==e.ssl)throw new Cr(Ar.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=e.host,this.ssl=null===(t=e.ssl)||void 0===t||t;if(this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,void 0===e.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new Cr(Ar.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.useFetchStreams=!!e.useFetchStreams,Vl("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling)}isEqual(e){return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams}}class Kl{constructor(e,t,n){this._authCredentials=t,this._appCheckCredentials=n,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new jl({}),this._settingsFrozen=!1,e instanceof Bs?this._databaseId=e:(this._app=e,this._databaseId=function(e){if(!Object.prototype.hasOwnProperty.apply(e.options,["projectId"]))throw new Cr(Ar.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new Bs(e.options.projectId)}(e))}get app(){if(!this._app)throw new Cr(Ar.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(e){if(this._settingsFrozen)throw new Cr(Ar.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new jl(e),void 0!==e.credentials&&(this._authCredentials=function(e){if(!e)return new Rr;switch(e.type){case"gapi":var t=e.client;return Dr(!("object"!=typeof t||null===t||!t.auth||!t.auth.getAuthHeaderValueForFirstParty)),new Vr(t,e.sessionIndex||"0",e.iamToken||null);case"provider":return e.client;default:throw new Cr(Ar.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(e){const t=Ll.get(e);t&&(Er("ComponentProvider","Removing Datastore"),Ll.delete(e),t.terminate())}(this),Promise.resolve()}}function Gl(n,e,t,r={}){var s;const i=(n=Ul(n,Kl))._getSettings();if("firestore.googleapis.com"!==i.host&&i.host!==e&&Sr("Host has been set in both settings() and useEmulator(), emulator host will be used"),n._setSettings(Object.assign(Object.assign({},i),{host:`${e}:${t}`,ssl:!1})),r.mockUserToken){let e,t;if("string"==typeof r.mockUserToken)e=r.mockUserToken,t=vr.MOCK_USER;else{e=function(e,t){if(e.uid)throw new Error('The "uid" field is no longer supported by mockUserToken. Please use "sub" instead for Firebase Auth User ID.');var n=t||"demo-project",r=e.iat||0,s=e.sub||e.user_id;if(!s)throw new Error("mockUserToken must contain 'sub' or 'user_id' field!");return s=Object.assign({iss:`https://securetoken.google.com/${n}`,aud:n,iat:r,exp:r+3600,auth_time:r,sub:s,user_id:s,firebase:{sign_in_provider:"custom",identities:{}}},e),[a(JSON.stringify({alg:"none",type:"JWT"})),a(JSON.stringify(s)),""].join(".")}(r.mockUserToken,null===(s=n._app)||void 0===s?void 0:s.options.projectId);const i=r.mockUserToken.sub||r.mockUserToken.user_id;if(!i)throw new Cr(Ar.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");t=new vr(i)}n._authCredentials=new Mr(new kr(e,t))}}class $l{constructor(e,t,n){this.converter=t,this._key=n,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new Ql(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new $l(this.firestore,e,this._key)}}class zl{constructor(e,t,n){this.converter=t,this._query=n,this.type="query",this.firestore=e}withConverter(e){return new zl(this.firestore,e,this._query)}}class Ql extends zl{constructor(e,t,n){super(e,t,Ri(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const e=this._path.popLast();return e.isEmpty()?null:new $l(this.firestore,null,new Wr(e))}withConverter(e){return new Ql(this.firestore,e,this._path)}}function Hl(e,t,...n){if(e=m(e),Ol("collection","path",t),e instanceof Kl){var r=zr.fromString(t,...n);return Pl(r),new Ql(e,null,r)}if(!(e instanceof $l||e instanceof Ql))throw new Cr(Ar.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");r=e._path.child(zr.fromString(t,...n));return Pl(r),new Ql(e.firestore,null,r)}function Wl(e,t,...n){if(e=m(e),Ol("doc","path",t=1===arguments.length?Br.I():t),e instanceof Kl){var r=zr.fromString(t,...n);return Fl(r),new $l(e,null,new Wr(r))}if(!(e instanceof $l||e instanceof Ql))throw new Cr(Ar.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");r=e._path.child(zr.fromString(t,...n));return Fl(r),new $l(e.firestore,e instanceof Ql?e.converter:null,new Wr(r))}function Yl(e,t){return e=m(e),t=m(t),(e instanceof $l||e instanceof Ql)&&(t instanceof $l||t instanceof Ql)&&e.firestore===t.firestore&&e.path===t.path&&e.converter===t.converter}function Xl(e,t){return e=m(e),t=m(t),e instanceof zl&&t instanceof zl&&e.firestore===t.firestore&&Bi(e._query,t._query)&&e.converter===t.converter}class Jl{constructor(){this.Oc=Promise.resolve(),this.Mc=[],this.Fc=!1,this.$c=[],this.Bc=null,this.Lc=!1,this.Uc=!1,this.qc=[],this.So=new nh(this,"async_queue_retry"),this.Kc=()=>{var e=eh();e&&Er("AsyncQueue","Visibility state changed to "+e.visibilityState),this.So.Eo()};const e=eh();e&&"function"==typeof e.addEventListener&&e.addEventListener("visibilitychange",this.Kc)}get isShuttingDown(){return this.Fc}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.Gc(),this.Qc(e)}enterRestrictedMode(e){if(!this.Fc){this.Fc=!0,this.Uc=e||!1;const t=eh();t&&"function"==typeof t.removeEventListener&&t.removeEventListener("visibilitychange",this.Kc)}}enqueue(e){if(this.Gc(),this.Fc)return new Promise(()=>{});const t=new Nr;return this.Qc(()=>this.Fc&&this.Uc?Promise.resolve():(e().then(t.resolve,t.reject),t.promise)).then(()=>t.promise)}enqueueRetryable(e){this.enqueueAndForget(()=>(this.Mc.push(e),this.jc()))}async jc(){if(0!==this.Mc.length){try{await this.Mc[0](),this.Mc.shift(),this.So.reset()}catch(e){if(!fs(e))throw e;Er("AsyncQueue","Operation failed with retryable error: "+e)}0<this.Mc.length&&this.So.Io(()=>this.jc())}}Qc(e){var t=this.Oc.then(()=>(this.Lc=!0,e().catch(e=>{throw this.Bc=e,this.Lc=!1,Tr("INTERNAL UNHANDLED ERROR: ",function(e){let t=e.message||"";return e.stack&&(t=e.stack.includes(e.message)?e.stack:e.message+"\n"+e.stack),t}(e)),e}).then(e=>(this.Lc=!1,e))));return this.Oc=t}enqueueAfterDelay(e,t,n){this.Gc(),-1<this.qc.indexOf(e)&&(t=0);var r=Ah.createAndSchedule(this,e,t,n,e=>this.Wc(e));return this.$c.push(r),r}Gc(){this.Bc&&xr()}verifyOperationInProgress(){}async zc(){for(var e;await(e=this.Oc),e!==this.Oc;);}Hc(e){for(const t of this.$c)if(t.timerId===e)return!0;return!1}Jc(t){return this.zc().then(()=>{this.$c.sort((e,t)=>e.targetTimeMs-t.targetTimeMs);for(const e of this.$c)if(e.skipDelay(),"all"!==t&&e.timerId===t)break;return this.zc()})}Yc(e){this.qc.push(e)}Wc(e){var t=this.$c.indexOf(e);this.$c.splice(t,1)}}function Zl(e){return function(e){if("object"==typeof e&&null!==e){var t=e;for(const e of["next","error","complete"])if(e in t&&"function"==typeof t[e])return 1}}(e)}class ed{constructor(){this._progressObserver={},this._taskCompletionResolver=new Nr,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(e,t,n){this._progressObserver={next:e,error:t,complete:n}}catch(e){return this._taskCompletionResolver.promise.catch(e)}then(e,t){return this._taskCompletionResolver.promise.then(e,t)}_completeWith(e){this._updateProgress(e),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(e)}_failWith(e){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(e),this._taskCompletionResolver.reject(e)}_updateProgress(e){this._lastProgress=e,this._progressObserver.next&&this._progressObserver.next(e)}}var td,nd,rd;class sd extends Kl{constructor(e,t,n){super(e,t,n),this.type="firestore",this._queue=new Jl,this._persistenceKey="name"in e?e.name:"[DEFAULT]"}_terminate(){return this._firestoreClient||ad(this),this._firestoreClient.terminate()}}function id(e){return e._firestoreClient||ad(e),e._firestoreClient.verifyNotTerminated(),e._firestoreClient}function ad(e){var t,n,r,s,i,a=e._freezeSettings(),a=(n=e._databaseId,r=(null===(t=e._app)||void 0===t?void 0:t.options.appId)||"",s=e._persistenceKey,i=a,new Ps(n,r,s,i.host,i.ssl,i.experimentalForceLongPolling,i.experimentalAutoDetectLongPolling,i.useFetchStreams));e._firestoreClient=new Il(e._authCredentials,e._appCheckCredentials,e._queue,a)}function od(e,n,r){const s=new Nr;return e.asyncQueue.enqueue(async()=>{try{await El(e,r),await Tl(e,n),s.resolve()}catch(e){if(!("FirebaseError"===(t=e).name?t.code===Ar.FAILED_PRECONDITION||t.code===Ar.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&t instanceof DOMException)||(22===t.code||20===t.code||11===t.code)))throw e;console.warn("Error enabling offline persistence. Falling back to persistence disabled: "+e),s.reject(e)}var t}).then(()=>s.promise)}function ud(e){return function(e){const t=new Nr;return e.asyncQueue.enqueueAndForget(async()=>async function(e,t){const n=e;yh(n.remoteStore)||Er("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{const e=await function(){const t=n.localStore;return t.persistence.runTransaction("Get highest unacknowledged batch id","readonly",e=>t.mutationQueue.getHighestUnacknowledgedBatchId(e))}();if(-1===e)return void t.resolve();const r=n.uc.get(e)||[];r.push(t),n.uc.set(e,r)}catch(e){const n=Ch(e,"Initialization of waitForPendingWrites() operation failed");t.reject(n)}}(await Cl(e),t)),t.promise}(id(e=Ul(e,sd)))}function cd(e){return(n=id(e=Ul(e,sd))).asyncQueue.enqueue(async()=>{const e=await xl(n),t=await Al(n);return e.setNetworkEnabled(!0),function(){const e=t;return e.lu.delete(0),ch(e)}()});var n}function hd(e){return(n=id(e=Ul(e,sd))).asyncQueue.enqueue(async()=>{const e=await xl(n),t=await Al(n);return e.setNetworkEnabled(!1),async function(){const e=t;e.lu.add(0),await hh(e),e._u.set("Offline")}()});var n}function ld(t,e){return n=id(t=Ul(t,sd)),r=e,n.asyncQueue.enqueue(async()=>function(e,t){const n=e;return n.persistence.runTransaction("Get named query","readonly",e=>n.Ds.getNamedQuery(e,t))}(await Dl(n),r)).then(e=>e?new zl(t,null,e.query):null);var n,r}function dd(e){if(e._initialized||e._terminated)throw new Cr(Ar.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}class fd{constructor(...e){for(let t=0;t<e.length;++t)if(0===e[t].length)throw new Cr(Ar.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new Hr(e)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}}class gd{constructor(e){this._byteString=e}static fromBase64String(e){try{return new gd(ks.fromBase64String(e))}catch(e){throw new Cr(Ar.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(e){return new gd(ks.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}}class md{constructor(e){this._methodName=e}}class pd{constructor(e,t){if(!isFinite(e)||e<-90||90<e)throw new Cr(Ar.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||180<t)throw new Cr(Ar.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(e){return Ur(this._lat,e._lat)||Ur(this._long,e._long)}}const yd=/^__.*__$/;class vd{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return null!==this.fieldMask?new ga(e,this.data,this.fieldMask,t,this.fieldTransforms):new fa(e,this.data,t,this.fieldTransforms)}}class wd{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return new ga(e,this.data,this.fieldMask,t,this.fieldTransforms)}}function bd(e){switch(e){case 0:case 2:case 1:return 1;case 3:case 4:return;default:throw xr()}}class Id{constructor(e,t,n,r,s,i){this.settings=e,this.databaseId=t,this.wt=n,this.ignoreUndefinedProperties=r,void 0===s&&this.Xc(),this.fieldTransforms=s||[],this.fieldMask=i||[]}get path(){return this.settings.path}get Zc(){return this.settings.Zc}ta(e){return new Id(Object.assign(Object.assign({},this.settings),e),this.databaseId,this.wt,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}ea(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.ta({path:n,na:!1});return r.sa(e),r}ia(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.ta({path:n,na:!1});return r.Xc(),r}ra(e){return this.ta({path:void 0,na:!0})}oa(e){return qd(e,this.settings.methodName,this.settings.ua||!1,this.path,this.settings.ca)}contains(t){return void 0!==this.fieldMask.find(e=>t.isPrefixOf(e))||void 0!==this.fieldTransforms.find(e=>t.isPrefixOf(e.field))}Xc(){if(this.path)for(let e=0;e<this.path.length;e++)this.sa(this.path.get(e))}sa(e){if(0===e.length)throw this.oa("Document fields must not be empty");if(bd(this.Zc)&&yd.test(e))throw this.oa('Document fields cannot begin and end with "__"')}}class Ed{constructor(e,t,n){this.databaseId=e,this.ignoreUndefinedProperties=t,this.wt=n||th(e)}aa(e,t,n,r=!1){return new Id({Zc:e,methodName:t,ca:n,path:Hr.emptyPath(),na:!1,ua:r},this.databaseId,this.wt,this.ignoreUndefinedProperties)}}function Td(e){var t=e._freezeSettings(),n=th(e._databaseId);return new Ed(e._databaseId,!!t.ignoreUndefinedProperties,n)}function Sd(e,t,n,r,s,i={}){const a=e.aa(i.merge||i.mergeFields?2:0,t,n,s);Fd("Data must be an object, but it was:",a,r);var o=Od(r,a);let u,c;if(i.merge)u=new Ns(a.fieldMask),c=a.fieldTransforms;else if(i.mergeFields){const e=[];for(const r of i.mergeFields){const s=Pd(t,r,n);if(!a.contains(s))throw new Cr(Ar.INVALID_ARGUMENT,`Field '${s}' is specified in your field mask but missing from your input data.`);jd(e,s)||e.push(s)}u=new Ns(e),c=a.fieldTransforms.filter(e=>u.covers(e.field))}else u=null,c=a.fieldTransforms;return new vd(new oi(o),u,c)}class _d extends md{_toFieldTransform(e){if(2!==e.Zc)throw 1===e.Zc?e.oa(`${this._methodName}() can only appear at the top level of your update data`):e.oa(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return e.fieldMask.push(e.path),null}isEqual(e){return e instanceof _d}}function xd(e,t,n){return new Id({Zc:3,ca:t.settings.ca,methodName:e._methodName,na:n},t.databaseId,t.wt,t.ignoreUndefinedProperties)}class Dd extends md{_toFieldTransform(e){return new sa(e.path,new Yi)}isEqual(e){return e instanceof Dd}}class Ad extends md{constructor(e,t){super(e),this.ha=t}_toFieldTransform(e){const t=xd(this,e,!0),n=this.ha.map(e=>Ld(e,t)),r=new Xi(n);return new sa(e.path,r)}isEqual(e){return this===e}}class Cd extends md{constructor(e,t){super(e),this.ha=t}_toFieldTransform(e){const t=xd(this,e,!0),n=this.ha.map(e=>Ld(e,t)),r=new Zi(n);return new sa(e.path,r)}isEqual(e){return this===e}}class Nd extends md{constructor(e,t){super(e),this.la=t}_toFieldTransform(e){var t=new ta(e.wt,Qi(e.wt,this.la));return new sa(e.path,t)}isEqual(e){return this===e}}function kd(e,s,i,t){const a=e.aa(1,s,i);Fd("Data must be an object, but it was:",a,t);const o=[],u=oi.empty();Es(t,(e,t)=>{var n=Ud(s,e,i);t=m(t);var r=a.ia(n);if(t instanceof _d)o.push(n);else{const e=Ld(t,r);null!=e&&(o.push(n),u.set(n,e))}});var n=new Ns(o);return new wd(u,n,a.fieldTransforms)}function Rd(e,t,n,r,s,i){const a=e.aa(1,t,n),o=[Pd(t,r,n)],u=[s];if(i.length%2!=0)throw new Cr(Ar.INVALID_ARGUMENT,`Function ${t}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let f=0;f<i.length;f+=2)o.push(Pd(t,i[f])),u.push(i[f+1]);const c=[],h=oi.empty();for(let g=o.length-1;0<=g;--g)if(!jd(c,o[g])){const t=o[g];var l=m(l=u[g]);const r=a.ia(t);if(l instanceof _d)c.push(t);else{const e=Ld(l,r);null!=e&&(c.push(t),h.set(t,e))}}var d=new Ns(c);return new wd(h,d,a.fieldTransforms)}function Md(e,t,n,r=!1){return Ld(n,e.aa(r?4:3,t))}function Ld(i,e){if(Vd(i=m(i)))return Fd("Unsupported field value:",e,i),Od(i,e);if(i instanceof md)return function(e,t){if(!bd(t.Zc))throw t.oa(`${e._methodName}() can only be used with update() and set()`);if(!t.path)throw t.oa(`${e._methodName}() is not currently supported inside arrays`);var n=e._toFieldTransform(t);n&&t.fieldTransforms.push(n)}(i,e),null;if(void 0===i&&e.ignoreUndefinedProperties)return null;if(e.path&&e.fieldMask.push(e.path),i instanceof Array){if(e.settings.na&&4!==e.Zc)throw e.oa("Nested arrays are not supported");return function(t){const n=[];let r=0;for(const s of i){let e=Ld(s,t.ra(r));null==e&&(e={nullValue:"NULL_VALUE"}),n.push(e),r++}return{arrayValue:{values:n}}}(e)}return function(e,t){if(null===(e=m(i)))return{nullValue:"NULL_VALUE"};if("number"==typeof e)return Qi(t.wt,e);if("boolean"==typeof e)return{booleanValue:e};if("string"==typeof e)return{stringValue:e};if(e instanceof Date){var n=Kr.fromDate(e);return{timestampValue:$a(t.wt,n)}}if(e instanceof Kr){n=new Kr(e.seconds,1e3*Math.floor(e.nanoseconds/1e3));return{timestampValue:$a(t.wt,n)}}if(e instanceof pd)return{geoPointValue:{latitude:e.latitude,longitude:e.longitude}};if(e instanceof gd)return{bytesValue:za(t.wt,e._byteString)};if(e instanceof $l){const r=t.databaseId,s=e.firestore._databaseId;if(!s.isEqual(r))throw t.oa(`Document reference is for database ${s.projectId}/${s.database} but should be for database ${r.projectId}/${r.database}`);return{referenceValue:Ha(e.firestore._databaseId||t.databaseId,e._key.path)}}throw t.oa(`Unsupported field value: ${Bl(e)}`)}(0,e)}function Od(e,r){const s={};return Ts(e)?r.path&&0<r.path.length&&r.fieldMask.push(r.path):Es(e,(e,t)=>{var n=Ld(t,r.ea(e));null!=n&&(s[e]=n)}),{mapValue:{fields:s}}}function Vd(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof Kr||e instanceof pd||e instanceof gd||e instanceof $l||e instanceof md)}function Fd(e,t,n){if(!Vd(n)||("object"!=typeof(s=n)||null===s||Object.getPrototypeOf(s)!==Object.prototype&&null!==Object.getPrototypeOf(s))){var r=Bl(n);throw"an object"===r?t.oa(e+" a custom object"):t.oa(e+" "+r)}var s}function Pd(e,t,n){if((t=m(t))instanceof fd)return t._internalPath;if("string"==typeof t)return Ud(e,t);throw qd("Field path arguments must be of type string or ",e,!1,void 0,n)}const Bd=new RegExp("[~\\*/\\[\\]]");function Ud(t,n,r){if(0<=n.search(Bd))throw qd(`Invalid field path (${n}). Paths must not contain '~', '*', '/', '[', or ']'`,t,!1,void 0,r);try{return new fd(...n.split("."))._internalPath}catch(e){throw qd(`Invalid field path (${n}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,t,!1,void 0,r)}}function qd(e,t,n,r,s){var i=r&&!r.isEmpty(),a=void 0!==s;let o=`Function ${t}() called with invalid data`;n&&(o+=" (via `toFirestore()`)"),o+=". ";let u="";return(i||a)&&(u+=" (found",i&&(u+=` in field ${r}`),a&&(u+=` in document ${s}`),u+=")"),new Cr(Ar.INVALID_ARGUMENT,o+e+u)}function jd(e,t){return e.some(e=>e.isEqual(t))}class Kd{constructor(e,t,n,r,s){this._firestore=e,this._userDataWriter=t,this._key=n,this._document=r,this._converter=s}get id(){return this._key.path.lastSegment()}get ref(){return new $l(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){var e=new Gd(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.data.value)}}get(e){if(this._document){var t=this._document.data.field($d("DocumentSnapshot.get",e));if(null!==t)return this._userDataWriter.convertValue(t)}}}class Gd extends Kd{data(){return super.data()}}function $d(e,t){return"string"==typeof t?Ud(e,t):(t instanceof fd?t:t._delegate)._internalPath}class zd{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}}class Qd extends Kd{constructor(e,t,n,r,s,i){super(e,t,n,r,i),this._firestore=e,this._firestoreImpl=e,this.metadata=s}exists(){return super.exists()}data(e={}){if(this._document){if(this._converter){var t=new Hd(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(t,e)}return this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}}get(e,t={}){if(this._document){var n=this._document.data.field($d("DocumentSnapshot.get",e));if(null!==n)return this._userDataWriter.convertValue(n,t.serverTimestamps)}}}class Hd extends Qd{data(e={}){return super.data(e)}}class Wd{constructor(e,t,n,r){this._firestore=e,this._userDataWriter=t,this._snapshot=r,this.metadata=new zd(r.hasPendingWrites,r.fromCache),this.query=n}get docs(){const t=[];return this.forEach(e=>t.push(e)),t}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(t,n){this._snapshot.docs.forEach(e=>{t.call(n,new Hd(this._firestore,this._userDataWriter,e.key,e,new zd(this._snapshot.mutatedKeys.has(e.key),this._snapshot.fromCache),this.query.converter))})}docChanges(e={}){var t=!!e.includeMetadataChanges;if(t&&this._snapshot.excludesMetadataChanges)throw new Cr(Ar.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=function(i,t){if(i._snapshot.oldDocs.isEmpty()){let t=0;return i._snapshot.docChanges.map(e=>({type:"added",doc:new Hd(i._firestore,i._userDataWriter,e.doc.key,e.doc,new zd(i._snapshot.mutatedKeys.has(e.doc.key),i._snapshot.fromCache),i.query.converter),oldIndex:-1,newIndex:t++}))}{let s=i._snapshot.oldDocs;return i._snapshot.docChanges.filter(e=>t||3!==e.type).map(e=>{var t=new Hd(i._firestore,i._userDataWriter,e.doc.key,e.doc,new zd(i._snapshot.mutatedKeys.has(e.doc.key),i._snapshot.fromCache),i.query.converter);let n=-1,r=-1;return 0!==e.type&&(n=s.indexOf(e.doc.key),s=s.delete(e.doc.key)),1!==e.type&&(s=s.add(e.doc),r=s.indexOf(e.doc.key)),{type:function(e){switch(e){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return xr()}}(e.type),doc:t,oldIndex:n,newIndex:r}})}}(this,t),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges}}function Yd(e,t){return e instanceof Qd&&t instanceof Qd?e._firestore===t._firestore&&e._key.isEqual(t._key)&&(null===e._document?null===t._document:e._document.isEqual(t._document))&&e._converter===t._converter:e instanceof Wd&&t instanceof Wd&&e._firestore===t._firestore&&Xl(e.query,t.query)&&e.metadata.isEqual(t.metadata)&&e._snapshot.isEqual(t._snapshot)}function Xd(e){if("L"===e.limitType&&0===e.explicitOrderBy.length)throw new Cr(Ar.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class Jd{}function Zd(e,...t){for(const n of t)e=n._apply(e);return e}class ef extends Jd{constructor(e,t,n){super(),this.fa=e,this.da=t,this._a=n,this.type="where"}_apply(e){var t=Td(e.firestore),t=function(e,t,n,r,s,i,a){let o;if(s.isKeyField()){if("array-contains"===i||"array-contains-any"===i)throw new Cr(Ar.INVALID_ARGUMENT,`Invalid Query. You can't perform '${i}' queries on documentId().`);if("in"===i||"not-in"===i){uf(a,i);const t=[];for(const n of a)t.push(of(r,e,n));o={arrayValue:{values:t}}}else o=of(r,e,a)}else"in"!==i&&"not-in"!==i&&"array-contains-any"!==i||uf(a,i),o=Md(n,t,a,"in"===i||"not-in"===i);var u=yi.create(s,i,o);return function(e,t){if(t.ht()){const r=Li(e);if(null!==r&&!r.isEqual(t.field))throw new Cr(Ar.INVALID_ARGUMENT,`Invalid query. All where filters with an inequality (<, <=, !=, not-in, >, or >=) must be on the same field. But you have inequality filters on '${r.toString()}' and '${t.field.toString()}'`);var n=Mi(e);null!==n&&cf(0,t.field,n)}const r=function(e,t){for(const n of e.filters)if(0<=t.indexOf(n.op))return n.op;return null}(e,function(){switch(t.op){case"!=":return["!=","not-in"];case"array-contains":return["array-contains","array-contains-any","not-in"];case"in":return["array-contains-any","in","not-in"];case"array-contains-any":return["array-contains","array-contains-any","in","not-in"];case"not-in":return["array-contains","array-contains-any","in","not-in","!="];default:return[]}}());if(null!==r)throw r===t.op?new Cr(Ar.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${t.op.toString()}' filter.`):new Cr(Ar.INVALID_ARGUMENT,`Invalid query. You cannot use '${t.op.toString()}' filters with '${r.toString()}' filters.`)}(e,u),u}(e._query,"where",t,e.firestore._databaseId,this.fa,this.da,this._a);return new zl(e.firestore,e.converter,(e=e._query,t=e.filters.concat([t]),new Ni(e.path,e.collectionGroup,e.explicitOrderBy.slice(),t,e.limit,e.limitType,e.startAt,e.endAt)))}}class tf extends Jd{constructor(e,t){super(),this.fa=e,this.wa=t,this.type="orderBy"}_apply(e){var t=function(e,t,n){if(null!==e.startAt)throw new Cr(Ar.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==e.endAt)throw new Cr(Ar.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");var r,s=new Di(t,n);return n=s,null!==Mi(e=e)||null!==(r=Li(e))&&cf(0,r,n.field),s}(e._query,this.fa,this.wa);return new zl(e.firestore,e.converter,(e=e._query,t=e.explicitOrderBy.concat([t]),new Ni(e.path,e.collectionGroup,t,e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)))}}class nf extends Jd{constructor(e,t,n){super(),this.type=e,this.ma=t,this.ga=n}_apply(e){return new zl(e.firestore,e.converter,Pi(e._query,this.ma,this.ga))}}class rf extends Jd{constructor(e,t,n){super(),this.type=e,this.ya=t,this.pa=n}_apply(e){var t,n=af(e,this.type,this.ya,this.pa);return new zl(e.firestore,e.converter,(t=e._query,e=n,new Ni(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,e,t.endAt)))}}class sf extends Jd{constructor(e,t,n){super(),this.type=e,this.ya=t,this.pa=n}_apply(e){var t,n=af(e,this.type,this.ya,this.pa);return new zl(e.firestore,e.converter,(t=e._query,e=n,new Ni(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,e)))}}function af(e,t,n,r){if(n[0]=m(n[0]),n[0]instanceof Kd)return function(e,t,n,r,s){if(!r)throw new Cr(Ar.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${n}().`);const i=[];for(const n of Vi(e))if(n.field.isKeyField())i.push(Xs(t,r.key));else{const e=r.data.field(n.field);if(Vs(e))throw new Cr(Ar.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+n.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===e){const e=n.field.canonicalString();throw new Cr(Ar.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${e}' (used as the orderBy) does not exist.`)}i.push(e)}return new xi(i,s)}(e._query,e.firestore._databaseId,t,n[0]._document,r);var s=Td(e.firestore);return function(e,t,n,r,s,i){const a=e.explicitOrderBy;if(s.length>a.length)throw new Cr(Ar.INVALID_ARGUMENT,`Too many arguments provided to ${r}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);const o=[];for(let u=0;u<s.length;u++){const c=s[u];if(a[u].field.isKeyField()){if("string"!=typeof c)throw new Cr(Ar.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${r}(), but got a ${typeof c}`);if(!Oi(e)&&-1!==c.indexOf("/"))throw new Cr(Ar.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${r}() must be a plain document ID, but '${c}' contains a slash.`);const n=e.path.child(zr.fromString(c));if(!Wr.isDocumentKey(n))throw new Cr(Ar.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${r}() must result in a valid document path, but '${n}' is not because it contains an odd number of segments.`);const s=new Wr(n);o.push(Xs(t,s))}else{const e=Md(n,r,c);o.push(e)}}return new xi(o,i)}(e._query,e.firestore._databaseId,s,t,n,r)}function of(e,t,n){if("string"==typeof(n=m(n))){if(""===n)throw new Cr(Ar.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!Oi(t)&&-1!==n.indexOf("/"))throw new Cr(Ar.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);var r=t.path.child(zr.fromString(n));if(!Wr.isDocumentKey(r))throw new Cr(Ar.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${r}' is not because it has an odd number of segments (${r.length}).`);return Xs(e,new Wr(r))}if(n instanceof $l)return Xs(e,n._key);throw new Cr(Ar.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${Bl(n)}.`)}function uf(e,t){if(!Array.isArray(e)||0===e.length)throw new Cr(Ar.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`);if(10<e.length)throw new Cr(Ar.INVALID_ARGUMENT,`Invalid Query. '${t.toString()}' filters support a maximum of 10 elements in the value array.`)}function cf(e,t,n){if(!n.isEqual(t))throw new Cr(Ar.INVALID_ARGUMENT,`Invalid query. You have a where filter with an inequality (<, <=, !=, not-in, >, or >=) on field '${t.toString()}' and so you must also use '${t.toString()}' as your first argument to orderBy(), but your first orderBy() is on field '${n.toString()}' instead.`)}const hf={maxAttempts:5};class lf{convertValue(e,t="none"){switch($s(e)){case 0:return null;case 1:return e.booleanValue;case 2:return Ls(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(Os(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 10:return this.convertObject(e.mapValue,t);default:throw xr()}}convertObject(e,n){const r={};return Es(e.fields,(e,t)=>{r[e]=this.convertValue(t,n)}),r}convertGeoPoint(e){return new pd(Ls(e.latitude),Ls(e.longitude))}convertArray(e,t){return(e.values||[]).map(e=>this.convertValue(e,t))}convertServerTimestamp(e,t){switch(t){case"previous":var n=function e(t){var n=t.mapValue.fields.__previous_value__;return Vs(n)?e(n):n}(e);return null==n?null:this.convertValue(n,t);case"estimate":return this.convertTimestamp(Fs(e));default:return null}}convertTimestamp(e){var t=Ms(e);return new Kr(t.seconds,t.nanos)}convertDocumentKey(e,t){const n=zr.fromString(e);Dr(go(n));const r=new Bs(n.get(1),n.get(3)),s=new Wr(n.popFirst(5));return r.isEqual(t)||Tr(`Document ${s} contains a document reference within a different database (${r.projectId}/${r.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),s}}function df(e,t,n){return e?n&&(n.merge||n.mergeFields)?e.toFirestore(t,n):e.toFirestore(t):t}class ff extends lf{constructor(e){super(),this.firestore=e}convertBytes(e){return new gd(e)}convertReference(e){var t=this.convertDocumentKey(e,this.firestore._databaseId);return new $l(this.firestore,null,t)}}class gf{constructor(e,t){this._firestore=e,this._commitHandler=t,this._mutations=[],this._committed=!1,this._dataReader=Td(e)}set(e,t,n){this._verifyNotCommitted();const r=mf(e,this._firestore),s=df(r.converter,t,n),i=Sd(this._dataReader,"WriteBatch.set",r._key,s,null!==r.converter,n);return this._mutations.push(i.toMutation(r._key,aa.none())),this}update(e,t,n,...r){this._verifyNotCommitted();var s=mf(e,this._firestore);let i;return i="string"==typeof(t=m(t))||t instanceof fd?Rd(this._dataReader,"WriteBatch.update",s._key,t,n,r):kd(this._dataReader,"WriteBatch.update",s._key,t),this._mutations.push(i.toMutation(s._key,aa.exists(!0))),this}delete(e){this._verifyNotCommitted();var t=mf(e,this._firestore);return this._mutations=this._mutations.concat(new va(t._key,aa.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,0<this._mutations.length?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new Cr(Ar.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function mf(e,t){if((e=m(e)).firestore!==t)throw new Cr(Ar.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return e}class pf extends lf{constructor(e){super(),this.firestore=e}convertBytes(e){return new gd(e)}convertReference(e){var t=this.convertDocumentKey(e,this.firestore._databaseId);return new $l(this.firestore,null,t)}}function yf(t){t=Ul(t,$l);const n=Ul(t.firestore,sd),e=id(n),r=new pf(n);return function(e,t){const n=new Nr;return e.asyncQueue.enqueueAndForget(async()=>async function(e,t,n){try{const s=await function(t){const n=e;return n.persistence.runTransaction("read document","readonly",e=>n.localDocuments.getDocument(e,t))}(t);s.isFoundDocument()?n.resolve(s):s.isNoDocument()?n.resolve(null):n.reject(new Cr(Ar.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(e){var r=Ch(e,`Failed to get document '${t} from cache`);n.reject(r)}}(await Dl(e),t,n)),n.promise}(e,t._key).then(e=>new Qd(n,r,t._key,e,new zd(null!==e&&e.hasLocalMutations,!0),t.converter))}function vf(t){t=Ul(t,zl);const n=Ul(t.firestore,sd),e=id(n),r=new pf(n);return function(e,t){const n=new Nr;return e.asyncQueue.enqueueAndForget(async()=>async function(e,t,n){try{const s=await Lc(e,t,!0),i=new $h(t,s.ji),a=i.Ku(s.documents),o=i.applyChanges(a,!1);n.resolve(o.snapshot)}catch(e){var r=Ch(e,`Failed to execute query '${t} against cache`);n.reject(r)}}(await Dl(e),t,n)),n.promise}(e,t._query).then(e=>new Wd(n,r,t,e))}function wf(e,t,n){e=Ul(e,$l);var r=Ul(e.firestore,sd),s=df(e.converter,t,n);return Tf(r,[Sd(Td(r),"setDoc",e._key,s,null!==e.converter,n).toMutation(e._key,aa.none())])}function bf(e,t,n,...r){e=Ul(e,$l);var s=Ul(e.firestore,sd),i=Td(s);let a;return a="string"==typeof(t=m(t))||t instanceof fd?Rd(i,"updateDoc",e._key,t,n,r):kd(i,"updateDoc",e._key,t),Tf(s,[a.toMutation(e._key,aa.exists(!0))])}function If(t,...n){var e;t=m(t);let r={includeMetadataChanges:!1},s=0;"object"!=typeof n[s]||Zl(n[s])||(r=n[s],s++);var i={includeMetadataChanges:r.includeMetadataChanges};if(Zl(n[s])){const t=n[s];n[s]=null===(e=t.next)||void 0===e?void 0:e.bind(t),n[s+1]=null===(e=t.error)||void 0===e?void 0:e.bind(t),n[s+2]=null===(e=t.complete)||void 0===e?void 0:e.bind(t)}let a,o,u;if(t instanceof $l)o=Ul(t.firestore,sd),u=Ri(t._key.path),a={next:e=>{n[s]&&n[s](Sf(o,t,e))},error:n[s+1],complete:n[s+2]};else{const c=Ul(t,zl);o=Ul(c.firestore,sd),u=c._query;const h=new pf(o);a={next:e=>{n[s]&&n[s](new Wd(o,h,c,e))},error:n[s+1],complete:n[s+2]},Xd(t._query)}return function(e,t,n,r){const s=new yl(r),i=new Ph(t,s,n);return e.asyncQueue.enqueueAndForget(async()=>Oh(await Nl(e),i)),()=>{s.Tc(),e.asyncQueue.enqueueAndForget(async()=>Vh(await Nl(e),i))}}(id(o),u,i,a)}function Ef(e,t){return function(e,t){const n=new yl(t);return e.asyncQueue.enqueueAndForget(async()=>function(e,t){e.Tu.add(t),t.next()}(await Nl(e),n)),()=>{n.Tc(),e.asyncQueue.enqueueAndForget(async()=>function(e,t){e.Tu.delete(t)}(await Nl(e),n))}}(id(e=Ul(e,sd)),Zl(t)?t:{next:t})}function Tf(e,t){return function(e,t){const n=new Nr;return e.asyncQueue.enqueueAndForget(async()=>Yh(await Cl(e),t,n)),n.promise}(id(e),t)}function Sf(e,t,n){var r=n.docs.get(t._key),s=new pf(e);return new Qd(e,s,t._key,r,new zd(n.hasPendingWrites,n.fromCache),t.converter)}class _f extends class{constructor(e,t){this._firestore=e,this._transaction=t,this._dataReader=Td(e)}get(e){const n=mf(e,this._firestore),r=new ff(this._firestore);return this._transaction.lookup([n._key]).then(e=>{if(!e||1!==e.length)return xr();const t=e[0];if(t.isFoundDocument())return new Kd(this._firestore,r,t.key,t,n.converter);if(t.isNoDocument())return new Kd(this._firestore,r,n._key,null,n.converter);throw xr()})}set(e,t,n){var r=mf(e,this._firestore),s=df(r.converter,t,n),s=Sd(this._dataReader,"Transaction.set",r._key,s,null!==r.converter,n);return this._transaction.set(r._key,s),this}update(e,t,n,...r){var s=mf(e,this._firestore),i="string"==typeof(t=m(t))||t instanceof fd?Rd(this._dataReader,"Transaction.update",s._key,t,n,r):kd(this._dataReader,"Transaction.update",s._key,t);return this._transaction.update(s._key,i),this}delete(e){var t=mf(e,this._firestore);return this._transaction.delete(t._key),this}}{constructor(e,t){super(e,t),this._firestore=e}get(e){const t=mf(e,this._firestore),n=new pf(this._firestore);return super.get(e).then(e=>new Qd(this._firestore,n,t._key,e._document,new zd(!1,!1),t.converter))}}function xf(t,n,e){t=Ul(t,sd);var r=Object.assign(Object.assign({},hf),e);return function(){if(r.maxAttempts<1)throw new Cr(Ar.INVALID_ARGUMENT,"Max attempts must be at least 1")}(),function(t,n,r){const s=new Nr;return t.asyncQueue.enqueueAndForget(async()=>{var e=await _l(t).then(e=>e.datastore);new bl(t.asyncQueue,e,r,n,s).run()}),s.promise}(id(t),e=>n(new _f(t,e)),r)}td=Zf.SDK_VERSION,wr=td,Zf._registerComponent(new c("firestore",(e,{options:t})=>{const n=e.getProvider("app").getImmediate(),r=new sd(n,new Lr(e.getProvider("auth-internal")),new Pr(e.getProvider("app-check-internal")));return t=Object.assign({useFetchStreams:!0},t),r._setSettings(t),r},"PUBLIC")),Zf.registerVersion(yr,"3.4.10",void 0),Zf.registerVersion(yr,"3.4.10","esm2017");function Df(e,t){if(void 0===t)return{merge:!1};if(void 0!==t.mergeFields&&void 0!==t.merge)throw new Cr("invalid-argument",`Invalid options passed to function ${e}(): You cannot `+'specify both "merge" and "mergeFields".');return t}function Af(){if("undefined"==typeof Uint8Array)throw new Cr("unimplemented","Uint8Arrays are not available in this environment.")}function Cf(){if("undefined"==typeof atob)throw new Cr("unimplemented","Blobs are unavailable in Firestore in this environment.")}class Nf{constructor(e){this._delegate=e}static fromBase64String(e){return Cf(),new Nf(gd.fromBase64String(e))}static fromUint8Array(e){return Af(),new Nf(gd.fromUint8Array(e))}toBase64(){return Cf(),this._delegate.toBase64()}toUint8Array(){return Af(),this._delegate.toUint8Array()}isEqual(e){return this._delegate.isEqual(e._delegate)}toString(){return"Blob(base64: "+this.toBase64()+")"}}function kf(e){return function(e,t){if("object"!=typeof e||null===e)return;var n=e;for(const r of t)if(r in n&&"function"==typeof n[r])return 1;return}(e,["next","error","complete"])}class Rf{enableIndexedDbPersistence(e,t){return function(e,t){dd(e=Ul(e,sd));var n=id(e),r=e._freezeSettings(),s=new ml;return od(n,s,new fl(s,r.cacheSizeBytes,null==t?void 0:t.forceOwnership))}(e._delegate,{forceOwnership:t})}enableMultiTabIndexedDbPersistence(e){return function(e){dd(e=Ul(e,sd));var t=id(e),n=e._freezeSettings(),r=new ml;return od(t,r,new gl(r,n.cacheSizeBytes))}(e._delegate)}clearIndexedDbPersistence(e){return function(e){if(e._initialized&&!e._terminated)throw new Cr(Ar.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");const t=new Nr;return e._queue.enqueueAndForgetEvenWhileRestricted(async()=>{try{await async function(e){if(!hs.V())return Promise.resolve();var t=e+"main";await hs.delete(t)}(Tc(e._databaseId,e._persistenceKey)),t.resolve()}catch(e){t.reject(e)}}),t.promise}(e._delegate)}}class Mf{constructor(e,t,n){this._delegate=t,this._persistenceProvider=n,this.INTERNAL={delete:()=>this.terminate()},e instanceof Bs||(this._appCompat=e)}get _databaseId(){return this._delegate._databaseId}settings(e){var t=this._delegate._getSettings();e.merge||t.host===e.host||Sr("You are overriding the original host. If you did not intend to override your settings, use {merge: true}."),e.merge&&delete(e=Object.assign(Object.assign({},t),e)).merge,this._delegate._setSettings(e)}useEmulator(e,t,n={}){Gl(this._delegate,e,t,n)}enableNetwork(){return cd(this._delegate)}disableNetwork(){return hd(this._delegate)}enablePersistence(e){let t=!1,n=!1;return e&&(t=!!e.synchronizeTabs,n=!!e.experimentalForceOwningTab,Vl("synchronizeTabs",t,"experimentalForceOwningTab",n)),t?this._persistenceProvider.enableMultiTabIndexedDbPersistence(this):this._persistenceProvider.enableIndexedDbPersistence(this,n)}clearPersistence(){return this._persistenceProvider.clearIndexedDbPersistence(this)}terminate(){return this._appCompat&&(this._appCompat._removeServiceInstance("firestore-compat"),this._appCompat._removeServiceInstance("firestore")),this._delegate._delete()}waitForPendingWrites(){return ud(this._delegate)}onSnapshotsInSync(e){return Ef(this._delegate,e)}get app(){if(!this._appCompat)throw new Cr("failed-precondition","Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._appCompat}collection(e){try{return new Qf(this,Hl(this._delegate,e))}catch(e){throw Bf(e,"collection()","Firestore.collection()")}}doc(e){try{return new Pf(this,Wl(this._delegate,e))}catch(e){throw Bf(e,"doc()","Firestore.doc()")}}collectionGroup(e){try{return new Gf(this,function(e,t){if(e=Ul(e,Kl),Ol("collectionGroup","collection id",t),0<=t.indexOf("/"))throw new Cr(Ar.INVALID_ARGUMENT,`Invalid collection ID '${t}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new zl(e,null,(t=t,new Ni(zr.emptyPath(),t)))}(this._delegate,e))}catch(e){throw Bf(e,"collectionGroup()","Firestore.collectionGroup()")}}runTransaction(t){return xf(this._delegate,e=>t(new Of(this,e)))}batch(){return id(this._delegate),new Vf(new gf(this._delegate,e=>Tf(this._delegate,e)))}loadBundle(e){return t=this._delegate,e=e,n=id(t=Ul(t,sd)),r=new ed,Ml(n,t._databaseId,e,r),r;var t,n,r}namedQuery(e){return ld(this._delegate,e).then(e=>e?new Gf(this,e):null)}}class Lf extends lf{constructor(e){super(),this.firestore=e}convertBytes(e){return new Nf(new gd(e))}convertReference(e){var t=this.convertDocumentKey(e,this.firestore._databaseId);return Pf.forKey(t,this.firestore,null)}}class Of{constructor(e,t){this._firestore=e,this._delegate=t,this._userDataWriter=new Lf(e)}get(e){const t=Hf(e);return this._delegate.get(t).then(e=>new jf(this._firestore,new Qd(this._firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,t.converter)))}set(e,t,n){var r=Hf(e);return n?(Df("Transaction.set",n),this._delegate.set(r,t,n)):this._delegate.set(r,t),this}update(e,t,n,...r){var s=Hf(e);return 2===arguments.length?this._delegate.update(s,t):this._delegate.update(s,t,n,...r),this}delete(e){var t=Hf(e);return this._delegate.delete(t),this}}class Vf{constructor(e){this._delegate=e}set(e,t,n){var r=Hf(e);return n?(Df("WriteBatch.set",n),this._delegate.set(r,t,n)):this._delegate.set(r,t),this}update(e,t,n,...r){var s=Hf(e);return 2===arguments.length?this._delegate.update(s,t):this._delegate.update(s,t,n,...r),this}delete(e){var t=Hf(e);return this._delegate.delete(t),this}commit(){return this._delegate.commit()}}class Ff{constructor(e,t,n){this._firestore=e,this._userDataWriter=t,this._delegate=n}fromFirestore(e,t){var n=new Hd(this._firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,null);return this._delegate.fromFirestore(new Kf(this._firestore,n),null!=t?t:{})}toFirestore(e,t){return t?this._delegate.toFirestore(e,t):this._delegate.toFirestore(e)}static getInstance(e,t){const n=Ff.INSTANCES;let r=n.get(e);r||(r=new WeakMap,n.set(e,r));let s=r.get(t);return s||(s=new Ff(e,new Lf(e),t),r.set(t,s)),s}}Ff.INSTANCES=new WeakMap;class Pf{constructor(e,t){this.firestore=e,this._delegate=t,this._userDataWriter=new Lf(e)}static forPath(e,t,n){if(e.length%2!=0)throw new Cr("invalid-argument","Invalid document reference. Document references must have an even number of segments, but "+`${e.canonicalString()} has ${e.length}`);return new Pf(t,new $l(t._delegate,n,new Wr(e)))}static forKey(e,t,n){return new Pf(t,new $l(t._delegate,n,e))}get id(){return this._delegate.id}get parent(){return new Qf(this.firestore,this._delegate.parent)}get path(){return this._delegate.path}collection(e){try{return new Qf(this.firestore,Hl(this._delegate,e))}catch(e){throw Bf(e,"collection()","DocumentReference.collection()")}}isEqual(e){return(e=m(e))instanceof $l&&Yl(this._delegate,e)}set(e,t){t=Df("DocumentReference.set",t);try{return t?wf(this._delegate,e,t):wf(this._delegate,e)}catch(e){throw Bf(e,"setDoc()","DocumentReference.set()")}}update(e,t,...n){try{return 1===arguments.length?bf(this._delegate,e):bf(this._delegate,e,t,...n)}catch(e){throw Bf(e,"updateDoc()","DocumentReference.update()")}}delete(){return Tf(Ul((e=this._delegate).firestore,sd),[new va(e._key,aa.none())]);var e}onSnapshot(...e){var t=Uf(e),n=qf(e,e=>new jf(this.firestore,new Qd(this.firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,this._delegate.converter)));return If(this._delegate,t,n)}get(e){let t;return t=("cache"===(null==e?void 0:e.source)?yf:"server"===(null==e?void 0:e.source)?function(t){t=Ul(t,$l);const n=Ul(t.firestore,sd);return kl(id(n),t._key,{source:"server"}).then(e=>Sf(n,t,e))}:function(t){t=Ul(t,$l);const n=Ul(t.firestore,sd);return kl(id(n),t._key).then(e=>Sf(n,t,e))})(this._delegate),t.then(e=>new jf(this.firestore,new Qd(this.firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,this._delegate.converter)))}withConverter(e){return new Pf(this.firestore,e?this._delegate.withConverter(Ff.getInstance(this.firestore,e)):this._delegate.withConverter(null))}}function Bf(e,t,n){return e.message=e.message.replace(t,n),e}function Uf(e){for(const t of e)if("object"==typeof t&&!kf(t))return t;return{}}function qf(e,t){var n;let r;return r=kf(e[0])?e[0]:kf(e[1])?e[1]:"function"==typeof e[0]?{next:e[0],error:e[1],complete:e[2]}:{next:e[1],error:e[2],complete:e[3]},{next:e=>{r.next&&r.next(t(e))},error:null===(n=r.error)||void 0===n?void 0:n.bind(r),complete:null===(n=r.complete)||void 0===n?void 0:n.bind(r)}}class jf{constructor(e,t){this._firestore=e,this._delegate=t}get ref(){return new Pf(this._firestore,this._delegate.ref)}get id(){return this._delegate.id}get metadata(){return this._delegate.metadata}get exists(){return this._delegate.exists()}data(e){return this._delegate.data(e)}get(e,t){return this._delegate.get(e,t)}isEqual(e){return Yd(this._delegate,e._delegate)}}class Kf extends jf{data(e){var t=this._delegate.data(e);return void 0!==t||xr(),t}}class Gf{constructor(e,t){this.firestore=e,this._delegate=t,this._userDataWriter=new Lf(e)}where(e,t,n){try{return new Gf(this.firestore,Zd(this._delegate,(r=n,s=t,i=$d("where",e),new ef(i,s,r))))}catch(e){throw Bf(e,/(orderBy|where)\(\)/,"Query.$1()")}var r,s,i}orderBy(e,t){try{return new Gf(this.firestore,Zd(this._delegate,([n,r="asc"]=[e,t],s=r,i=$d("orderBy",n),new tf(i,s))))}catch(e){throw Bf(e,/(orderBy|where)\(\)/,"Query.$1()")}var n,r,s,i}limit(e){try{return new Gf(this.firestore,Zd(this._delegate,(ql("limit",t=e),new nf("limit",t,"F"))))}catch(e){throw Bf(e,"limit()","Query.limit()")}var t}limitToLast(e){try{return new Gf(this.firestore,Zd(this._delegate,(ql("limitToLast",t=e),new nf("limitToLast",t,"L"))))}catch(e){throw Bf(e,"limitToLast()","Query.limitToLast()")}var t}startAt(...e){try{return new Gf(this.firestore,Zd(this._delegate,function(...e){return new rf("startAt",e,!0)}(...e)))}catch(e){throw Bf(e,"startAt()","Query.startAt()")}}startAfter(...e){try{return new Gf(this.firestore,Zd(this._delegate,function(...e){return new rf("startAfter",e,!1)}(...e)))}catch(e){throw Bf(e,"startAfter()","Query.startAfter()")}}endBefore(...e){try{return new Gf(this.firestore,Zd(this._delegate,function(...e){return new sf("endBefore",e,!1)}(...e)))}catch(e){throw Bf(e,"endBefore()","Query.endBefore()")}}endAt(...e){try{return new Gf(this.firestore,Zd(this._delegate,function(...e){return new sf("endAt",e,!0)}(...e)))}catch(e){throw Bf(e,"endAt()","Query.endAt()")}}isEqual(e){return Xl(this._delegate,e._delegate)}get(e){let t;return t=("cache"===(null==e?void 0:e.source)?vf:"server"===(null==e?void 0:e.source)?function(t){t=Ul(t,zl);const n=Ul(t.firestore,sd),e=id(n),r=new pf(n);return Rl(e,t._query,{source:"server"}).then(e=>new Wd(n,r,t,e))}:function(t){t=Ul(t,zl);const n=Ul(t.firestore,sd),e=id(n),r=new pf(n);return Xd(t._query),Rl(e,t._query).then(e=>new Wd(n,r,t,e))})(this._delegate),t.then(e=>new zf(this.firestore,new Wd(this.firestore._delegate,this._userDataWriter,this._delegate,e._snapshot)))}onSnapshot(...e){var t=Uf(e),n=qf(e,e=>new zf(this.firestore,new Wd(this.firestore._delegate,this._userDataWriter,this._delegate,e._snapshot)));return If(this._delegate,t,n)}withConverter(e){return new Gf(this.firestore,e?this._delegate.withConverter(Ff.getInstance(this.firestore,e)):this._delegate.withConverter(null))}}class $f{constructor(e,t){this._firestore=e,this._delegate=t}get type(){return this._delegate.type}get doc(){return new Kf(this._firestore,this._delegate.doc)}get oldIndex(){return this._delegate.oldIndex}get newIndex(){return this._delegate.newIndex}}class zf{constructor(e,t){this._firestore=e,this._delegate=t}get query(){return new Gf(this._firestore,this._delegate.query)}get metadata(){return this._delegate.metadata}get size(){return this._delegate.size}get empty(){return this._delegate.empty}get docs(){return this._delegate.docs.map(e=>new Kf(this._firestore,e))}docChanges(e){return this._delegate.docChanges(e).map(e=>new $f(this._firestore,e))}forEach(t,n){this._delegate.forEach(e=>{t.call(n,new Kf(this._firestore,e))})}isEqual(e){return Yd(this._delegate,e._delegate)}}class Qf extends Gf{constructor(e,t){super(e,t),this.firestore=e,this._delegate=t}get id(){return this._delegate.id}get path(){return this._delegate.path}get parent(){var e=this._delegate.parent;return e?new Pf(this.firestore,e):null}doc(e){try{return void 0===e?new Pf(this.firestore,Wl(this._delegate)):new Pf(this.firestore,Wl(this._delegate,e))}catch(e){throw Bf(e,"doc()","CollectionReference.doc()")}}add(e){return function(e,t){const n=Ul(e.firestore,sd),r=Wl(e),s=df(e.converter,t);return Tf(n,[Sd(Td(e.firestore),"addDoc",r._key,s,null!==e.converter,{}).toMutation(r._key,aa.exists(!1))]).then(()=>r)}(this._delegate,e).then(e=>new Pf(this.firestore,e))}isEqual(e){return Yl(this._delegate,e._delegate)}withConverter(e){return new Qf(this.firestore,e?this._delegate.withConverter(Ff.getInstance(this.firestore,e)):this._delegate.withConverter(null))}}function Hf(e){return Ul(e,$l)}const Wf={Firestore:Mf,GeoPoint:pd,Timestamp:Kr,Blob:Nf,Transaction:Of,WriteBatch:Vf,DocumentReference:Pf,DocumentSnapshot:jf,Query:Gf,QueryDocumentSnapshot:Kf,QuerySnapshot:zf,CollectionReference:Qf,FieldPath:class Yf{constructor(...e){this._delegate=new fd(...e)}static documentId(){return new Yf(Hr.keyField().canonicalString())}isEqual(e){return(e=m(e))instanceof fd&&this._delegate._internalPath.isEqual(e._internalPath)}},FieldValue:class Xf{constructor(e){this._delegate=e}static serverTimestamp(){const e=new Dd("serverTimestamp");return e._methodName="FieldValue.serverTimestamp",new Xf(e)}static delete(){const e=new _d("deleteField");return e._methodName="FieldValue.delete",new Xf(e)}static arrayUnion(...e){const t=function(...e){return new Ad("arrayUnion",e)}(...e);return t._methodName="FieldValue.arrayUnion",new Xf(t)}static arrayRemove(...e){const t=function(...e){return new Cd("arrayRemove",e)}(...e);return t._methodName="FieldValue.arrayRemove",new Xf(t)}static increment(e){const t=new Nd("increment",e);return t._methodName="FieldValue.increment",new Xf(t)}isEqual(e){return this._delegate.isEqual(e._delegate)}},setLogLevel:function(e){e=e,br.setLogLevel(e)},CACHE_SIZE_UNLIMITED:-1};nd=t.default,rd=(e,t)=>new Mf(e,t,new Rf),nd.INTERNAL.registerComponent(new c("firestore-compat",e=>{var t=e.getProvider("app-compat").getImmediate(),n=e.getProvider("firestore").getImmediate();return rd(t,n)},"PUBLIC").setServiceProps(Object.assign({},Wf))),nd.registerVersion("@firebase/firestore-compat","0.1.19")}).apply(this,arguments)}catch(e){throw console.error(e),new Error("Cannot instantiate firebase-firestore-compat.js - be sure to load firebase-app.js first.")}});
//# sourceMappingURL=firebase-firestore-compat.js.map
